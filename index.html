<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mini Horse Race</title>
<style>
:root{
  --bg:#0b1220; --bg2:#0c111b; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
  --accent:#6ee7ff; --accent2:#22c55e; --border:#1f2937;
  --track-h:58px; --lane-gap:10px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  background:radial-gradient(1200px 600px at 70% -10%, #12213a 0%, #0b1220 45%, #090f1a 100%);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Malgun Gothic",sans-serif;
}
a{color:inherit;text-decoration:none}
.wrap{max-width:960px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0 14px}
.brand{display:flex;align-items:center;gap:10px}
.brand-badge{
  width:34px;height:34px;border-radius:10px;background:linear-gradient(140deg,#1b2a45,#0c1627);
  border:1px solid #22314d; display:grid; place-items:center; color:#6ee7ff; font-weight:900
}
h1{margin:0;font-size:20px;letter-spacing:.2px}
.sub{margin:2px 0 0;color:var(--muted);font-size:12px}

.panel{
  background:linear-gradient(180deg,var(--panel),#0c1322 70%);
  border:1px solid var(--border); border-radius:14px; padding:14px;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
}

/* --- Controls (마블룰렛 감성: 단순/정돈) --- */
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:stretch}
.card{flex:1 1 360px;display:flex;flex-direction:column;gap:10px}
label.small{font-size:12px;color:var(--muted)}
textarea{
  width:100%;min-height:120px;resize:vertical;background:#0b1220;border:1px solid #223047;
  color:var(--ink);border-radius:12px;padding:12px;outline:none
}
.btnrow{display:flex;gap:8px;flex-wrap:wrap}
button{
  border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800;letter-spacing:.2px
}
.btn-accent{background:linear-gradient(180deg,#1b9ab7,#168aa4);color:#06131b;border:1px solid #0a6c82}
.btn-ghost{background:transparent;border:1px solid #2a3a57;color:#cbd5e1}
.btn-accent:hover{filter:brightness(1.06)} .btn-ghost:hover{filter:brightness(1.1)}
.hint{font-size:12px;color:var(--muted)}

/* --- Track --- */
.trackBox{margin-top:14px}
.track{
  position:relative; border:1px solid var(--border); border-radius:14px; padding:14px;
  background:linear-gradient(180deg,#0d1728,#0c111b);
  overflow:auto; min-height:260px
}
.scroll{position:relative; min-width:1200px}
.finish{
  position:absolute; top:10px; bottom:10px; left:var(--fx,1050px); width:16px; border-radius:6px;
  background:conic-gradient(#fff 25%,#0000 0 50%,#fff 0 75%,#0000 0) 0/10px 10px, rgba(255,255,255,.06);
  border:1px solid #000; box-shadow:0 0 0 2px #0d1422 inset, 0 0 18px rgba(255,255,255,.08)
}
.lane{position:relative;height:var(--track-h);margin-bottom:var(--lane-gap);border-radius:12px;
  background:linear-gradient(180deg,#0f1b30,#0e1525); border:1px solid #1c2741; overflow:hidden}
.lane:last-child{margin-bottom:0}
.label{
  position:absolute; left:10px; top:50%; transform:translateY(-50%);
  background:#0b1220;border:1px solid #233250;border-radius:10px;color:#d7e0ea;
  padding:4px 8px;font-size:12px;max-width:48%;white-space:nowrap;text-overflow:ellipsis;overflow:hidden
}
.horse{position:absolute; left:0; top:8px; height:calc(var(--track-h) - 16px); display:flex; align-items:center}
.nameplate{
  position:absolute; bottom:100%; left:50%; transform:translate(-50%,-6px);
  background:#09111e; color:#dbe7f3; border:1px solid #2a3a57; border-radius:10px;
  font-size:11px; font-weight:800; padding:3px 8px; pointer-events:none; white-space:nowrap; max-width:140px; text-overflow:ellipsis; overflow:hidden
}

/* --- Winner banner --- */
.winner{
  margin-top:10px; display:none; padding:12px; border-radius:12px;
  background:linear-gradient(180deg,#0e1e33,#0a1626); border:1px solid #213250;
}
.winner strong{color:#9ae6b4}
.timer{color:#a0aec0;font-size:12px}

/* --- SVG horse: 내가 직접 만든 저작권 프리 --- */
.horse-svg{width:46px;height:34px}
.horse-svg .body{fill:#e5e7eb}
.horse-svg .mane{fill:#cbd5e1}
.horse-svg .jockey{fill:var(--jersey,#60a5fa)}
.horse-svg .saddle{fill:#94a3b8}
.horse-svg .eye{fill:#0f172a}

@keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-1.2px)} }
/* 앞다리/뒷다리 번갈아 달리기 */
@keyframes legA{ 0%,100%{transform:translateY(0) skewX(0deg)} 50%{transform:translateY(-2px) skewX(-5deg)} }
@keyframes legB{ 0%,100%{transform:translateY(0) skewX(0deg)} 50%{transform:translateY( 2px) skewX( 5deg)} }

.horse-svg .g-bob{animation:bob .26s infinite ease-in-out}
.horse-svg .g-legs-a{animation:legA .22s infinite ease-in-out}
.horse-svg .g-legs-b{animation:legB .22s infinite ease-in-out}

/* auto-compact */
.scroll.compact-9  .horse-svg{transform:scale(.96)}
.scroll.compact-11 .horse-svg{transform:scale(.9)}
.scroll.compact-13 .horse-svg{transform:scale(.84)}
.scroll.compact-14 .horse-svg{transform:scale(.8)}
.scroll.compact-9  {--track-h:54px}
.scroll.compact-11 {--track-h:52px}
.scroll.compact-13 {--track-h:50px}
.scroll.compact-14 {--track-h:46px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="brand-badge">HR</div>
      <div>
        <h1>Mini Horse Race</h1>
        <p class="sub">마블룰렛처럼 심플 · 외부이미지 ❌ · SVG 말/기수 직접제작 ✅</p>
      </div>
    </div>
    <div class="hint">참가자 2~14명</div>
  </header>

  <section class="panel controls">
    <div class="card">
      <label class="small">참가자 이름 (줄바꿈으로 구분)</label>
      <textarea id="names" placeholder="예)
도라에몽
노진구
루피
나미
우솝"></textarea>
      <div class="btnrow">
        <button class="btn-accent" id="startBtn">Start Race ▶</button>
        <button class="btn-ghost" id="buildBtn">트랙 새로고침</button>
        <button class="btn-ghost" id="resetBtn">Reset</button>
      </div>
      <div class="hint" id="pHint">참가자 0명</div>
    </div>
  </section>

  <section class="trackBox panel">
    <div class="track">
      <div class="scroll" id="scroll">
        <div class="finish" id="finish"></div>
      </div>
    </div>
    <div class="winner" id="winnerBox">
      <div class="timer" id="timeBox"></div>
      <div><strong>우승:</strong> <span id="winnerName"></span></div>
    </div>
  </section>
</div>

<script>
/* ======= Utils & PRNG ======= */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
let _rand=Math.random;
function reseed(seed){ _rand = Number.isFinite(seed)? mulberry32(seed|0) : Math.random; }
function autoSeed(){ return (Date.now() ^ Math.floor(Math.random()*0xFFFFFFFF))>>>0; }

const JERSEYS=['#60a5fa','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6','#eab308','#fb7185','#34d399','#f97316','#a3e635','#e879f9','#f43f5e'];
function jerseyColor(i){ return JERSEYS[i%JERSEYS.length]; }
function parseInput(raw){ return raw.split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,14).map(n=>({name:n})); }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(_rand()*(i+1)); [a[i],a[j]]=[a[j],a[i]]} return a; }

/* ======= SVG Horse (내 제작, 저작권 문제 없음) ======= */
function horseSVG(color='#60a5fa'){ return `
<svg class="horse-svg" viewBox="0 0 64 44" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="--jersey:${color}">
  <g class="g-legs-b">
    <rect x="16" y="28" width="5" height="12" rx="1" fill="#cbd5e1"/>
    <rect x="30" y="29" width="5" height="12" rx="1" fill="#cbd5e1"/>
  </g>
  <g class="g-bob">
    <path class="mane" d="M10 26c2-3 3-5 6-6 0 4-2 7-4 9l-4-1 2-2z"/>
    <path class="body" d="M8 28c7-9 12-11 20-11h9c7 0 14 4 19 9l3 5-4 2-6-4-7 2H28l-8 1-6 3-6-1 6-6z"/>
    <rect class="saddle" x="28" y="17" width="11" height="7" rx="2"/>
    <g class="jockey"><circle cx="31" cy="12" r="3.6"/><rect x="28" y="15.5" width="10" height="7" rx="2"/></g>
    <circle class="eye" cx="22.5" cy="20.5" r="0.9"/>
  </g>
  <g class="g-legs-a">
    <rect x="22" y="29" width="5" height="12" rx="1" fill="#cbd5e1"/>
    <rect x="38" y="28" width="5" height="12" rx="1" fill="#cbd5e1"/>
  </g>
</svg>`; }

/* ======= DOM ======= */
const $names=document.getElementById('names');
const $start=document.getElementById('startBtn');
const $build=document.getElementById('buildBtn');
const $reset=document.getElementById('resetBtn');
const $pHint=document.getElementById('pHint');
const $scroll=document.getElementById('scroll');
const $finish=document.getElementById('finish');
const $winnerBox=document.getElementById('winnerBox');
const $winnerName=document.getElementById('winnerName');
const $timeBox=document.getElementById('timeBox');

/* ======= State ======= */
const MIN=2, MAX=14;
let running=false, raf=null, startTs=0;
let horses=[]; // {name, $lane, $horse, x, v, done, sprint, cd}
let finishX=1050;

/* ======= Build ======= */
function applyCompact(n){
  $scroll.classList.remove('compact-9','compact-11','compact-13','compact-14');
  if(n>=14)$scroll.classList.add('compact-14');
  else if(n>=13)$scroll.classList.add('compact-13');
  else if(n>=11)$scroll.classList.add('compact-11');
  else if(n>=9)$scroll.classList.add('compact-9');
}
function setFinishAuto(){
  const visW = $scroll.parentElement.clientWidth - 80;
  finishX = Math.max(900, visW);
  $finish.style.setProperty('--fx', finishX+'px');
}
function resetWinner(){
  $winnerBox.style.display='none';
  $winnerName.textContent=''; $timeBox.textContent='';
}
function buildTrack(list){
  $scroll.innerHTML=''; $scroll.appendChild($finish); setFinishAuto(); applyCompact(list.length);
  const frag=document.createDocumentFragment();
  list.forEach((e,i)=>{
    const lane=document.createElement('div'); lane.className='lane';
    const label=document.createElement('div'); label.className='label'; label.textContent=e.name;
    const horse=document.createElement('div'); horse.className='horse'; horse.style.left='0px'; horse.innerHTML=horseSVG(jerseyColor(i));
    const plate=document.createElement('div'); plate.className='nameplate'; plate.textContent=e.name;
    horse.appendChild(plate);
    lane.appendChild(label); lane.appendChild(horse);
    frag.appendChild(lane);
    e.$lane=lane; e.$horse=horse; e.x=0; e.v=0; e.done=false; e.sprint=0; e.cd=0;
  });
  $scroll.appendChild(frag);
}

/* ======= Physics (간단/경쾌) ======= */
const BASE=0.19, NOISE=0.06; // px/ms
function step(dt){
  let maxX=0;
  for(const h of horses){
    if(h.done) continue;
    const noise = ( (_rand()-0.5) * NOISE );
    if(h.sprint<=0 && h.cd<=0 && _rand()<0.008){ h.sprint=300+_rand()*300; h.cd=900+_rand()*1100; }
    const spd = BASE + noise + (h.sprint>0? 1.35:0);
    h.v = spd;
    h.x += h.v * dt;
    h.sprint -= dt; h.cd -= dt;
    if(h.x >= finishX - 40){ h.done=true; }
    h.$horse.style.left = Math.max(0, h.x|0) + 'px';
    if(h.x>maxX) maxX=h.x;
  }
  $scroll.parentElement.scrollLeft = Math.max(0, maxX - $scroll.parentElement.clientWidth*0.55);
}

/* ======= Race Loop ======= */
function runRace(){
  running=true; startTs=performance.now();
  function tick(){
    step(16);
    const alive=horses.filter(h=>!h.done).length;
    if(alive===0){
      running=false; cancelAnimationFrame(raf); raf=null;
      const order=horses.slice().sort((a,b)=> (b.x-a.x));
      const winners=order.slice(0,1);
      $winnerName.textContent = winners.map(w=>w.name).join(', ');
      $timeBox.textContent = `경과 ${( (performance.now()-startTs)/1000 ).toFixed(2)}s`;
      $winnerBox.style.display='block';
      return;
    }
    raf=requestAnimationFrame(tick);
  }
  raf=requestAnimationFrame(tick);
}

/* ======= Controls ======= */
function updateHint(list){
  const n=list.length;
  const s = n<MIN ? '최소 2명 입력' : (n>MAX ? '최대 14명 (초과는 잘림)' : 'OK');
  $pHint.textContent = `참가자 ${n}명 · ${s}`;
}

$build.addEventListener('click', ()=>{
  if(running) return;
  const list=parseInput($names.value);
  if(list.length<MIN){ alert('최소 2명을 입력해주세요.'); return; }
  horses=list; buildTrack(horses);
  resetWinner();
  updateHint(horses);
});

$start.addEventListener('click', ()=>{
  if(running) return;
  let list=parseInput($names.value);
  if(list.length<MIN){ alert('최소 2명을 입력해주세요.'); return; }
  reseed(autoSeed());
  list=shuffle(list);
  horses=list;
  buildTrack(horses);
  resetWinner();
  runRace();
});

$reset.addEventListener('click', ()=>{
  cancelAnimationFrame(raf); raf=null; running=false;
  $scroll.innerHTML=''; $scroll.appendChild($finish);
  resetWinner();
  updateHint(parseInput($names.value));
});

$names.addEventListener('input', ()=> updateHint(parseInput($names.value)));
window.addEventListener('resize', ()=> setFinishAuto());

/* init */
updateHint(parseInput($names.value));
setFinishAuto();
</script>
</body>
</html>
