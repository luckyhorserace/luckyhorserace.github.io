<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>말달리자</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      overflow: hidden;
      background: #f4f4f4;
    }
    header {
      position: fixed;
      top: 0;
      width: 100%;
      background: white;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 10;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .controls {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }
    .controls.right {
      justify-content: flex-end;
    }
    .btn, .btn-ghost, .btn-accent {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-accent {
      background: #ffdd57;
    }
    .btn-ghost {
      background: #eee;
    }
    canvas {
      display: block;
      margin-top: 70px;
    }

    /* 순위판 */
    #rankBoard {
      position: absolute;
      top: 80px;
      right: 20px;
      display: flex;
      flex-direction: row-reverse;
      gap: 24px;
    }
    .rank-col {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .rank-item {
      background: white;
      padding: 6px 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* 우승 오버레이 */
    #celebrate {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      color: white;
    }

    #celebrate.show {
      display: flex;
    }

    #celebrate h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    /* 카운트다운 HUD */
    .hud {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 50;
      text-align: center;
      pointer-events: none;
    }

    .traffic {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 10px;
    }

    .traffic .light {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #ccc;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
    }

    .traffic .light.on {
      background: red;
    }

    .traffic .light.on.yellow {
      background: yellow;
    }

    .traffic .light.on.green {
      background: limegreen;
    }

    .hud .count {
      font-size: 5rem;
      font-weight: bold;
      text-shadow: 2px 2px 8px black;
    }
  </style>
</head>
<body>
  <!-- 상단 컨트롤 영역 -->
  <header>
    <div class="controls left">
      <input id="names" type="text" placeholder="참가자 입력 (예: 고구마 감자 김치 / 고구마*3)">
      <select id="raceLen" style="display:none">
        <option value="1">1바퀴</option>
        <option value="3" selected>3바퀴</option>
        <option value="5">5바퀴</option>
        <option value="10">10바퀴</option>
      </select>
      <select id="raceDist">
        <option value="100" selected>100m</option>
        <option value="200">200m</option>
        <option value="300">300m</option>
        <option value="500">500m</option>
        <option value="1000">1km</option>
      </select>
      <button class="btn-ghost" id="shuffleBtn">말 섞기</button>
      <button class="btn-accent" id="startBtn">시작 ▶</button>
      <button class="btn-ghost" id="resetBtn">리셋</button>
      <button class="btn-ghost" id="mapToggleBtn">맵 전환: 직선</button>
    </div>
    <div class="controls right">
      <div class="seg" id="drawSeg">
        <label class="seg-item" data-type="first">
          <input type="radio" name="draw" value="first">
          <span>1등</span>
        </label>
        <label class="seg-item" data-type="last">
          <input type="radio" name="draw" value="last">
          <span>마지막</span>
        </label>
        <label class="seg-item" data-type="nth">
          <input type="radio" name="draw" value="nth">
          <span>n등</span>
        </label>
        <input id="drawNthInput" type="number" min="1" step="1" placeholder="n등" disabled>
        <small style="opacity:.8;margin-left:6px">※ 선택만 해두면, 해당 등수 들어오는 순간 자동 발표</small>
      </div>
      <a href="https://buymeacoffee.com/luckyhorse" target="_blank" class="btn-accent btn">개발자 컵라면 사주기 🍜</a>
      <button class="btn-ghost" id="btnContact">문의 및 건의사항</button>
    </div>
  </header>

  <!-- 게임 영역 -->
  <canvas id="raceCanvas" width="1280" height="720"></canvas>

  <!-- 우승 오버레이 -->
  <div id="celebrate">
    <h1 id="winnerName">🎉 우승: 고구마 🎉</h1>
    <button id="replaySaveBtn" class="btn-accent">리플레이 저장</button>
    <button id="closeCelebrateBtn" class="btn-ghost">닫기</button>
  </div>

  <!-- 순위판 -->
  <div id="rankBoard"></div>

  <!-- HUD: 카운트다운 및 신호등 -->
  <div class="hud">
    <div class="traffic">
      <div class="light red"></div>
      <div class="light yellow"></div>
      <div class="light green"></div>
    </div>
    <div class="count" id="countdownNum">3</div>
  </div>
  <script>
const $names = document.getElementById("names");
const $startBtn = document.getElementById("startBtn");
const $resetBtn = document.getElementById("resetBtn");
const $shuffleBtn = document.getElementById("shuffleBtn");
const $replaySaveBtn = document.getElementById("replaySaveBtn");
const $closeCelebrateBtn = document.getElementById("closeCelebrateBtn");
const $mapToggleBtn = document.getElementById("mapToggleBtn");
const $celebrate = document.getElementById("celebrate");
const $winnerName = document.getElementById("winnerName");
const $rankBoard = document.getElementById("rankBoard");

let isStraightMap = true;
let replayData = [];

function shuffleNames() {
  const names = $names.value.split(/[\s/]+/).filter(Boolean);
  for (let i = names.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [names[i], names[j]] = [names[j], names[i]];
  }
  $names.value = names.join(" ");
}

function startRace() {
  if (!$names.value.trim()) return alert("참가자 이름을 입력해주세요.");
  replayData = [];
  countdown(() => {
    runRace();
  });
}

function countdown(callback) {
  const countEl = document.getElementById("countdownNum");
  const lights = document.querySelectorAll(".traffic .light");
  let count = 3;
  countEl.textContent = count;
  lights.forEach(l => l.classList.remove("on", "yellow", "green"));

  const interval = setInterval(() => {
    count--;
    if (count === 2) {
      lights[0].classList.add("on");
    } else if (count === 1) {
      lights[1].classList.add("on", "yellow");
    } else if (count === 0) {
      lights[2].classList.add("on", "green");
    }

    countEl.textContent = count > 0 ? count : "GO!";
    if (count < 0) {
      clearInterval(interval);
      setTimeout(() => {
        document.querySelector(".hud").style.display = "none";
        callback();
      }, 500);
    }
  }, 1000);

  document.querySelector(".hud").style.display = "block";
}

function runRace() {
  const names = $names.value.split(/[\s/]+/).filter(Boolean);
  const ranks = [...names].sort(() => Math.random() - 0.5);

  // 저장용 리플레이 (단순 결과만 저장)
  replayData = {
    timestamp: new Date().toISOString(),
    participants: names,
    result: ranks
  };

  showRankBoard(ranks);
  showCelebrate(ranks[0]);
}

function showRankBoard(ranks) {
  $rankBoard.innerHTML = "";
  const colSize = 10;
  const cols = Math.ceil(ranks.length / colSize);

  for (let c = 0; c < cols; c++) {
    const colDiv = document.createElement("div");
    colDiv.className = "rank-col";
    const start = c * colSize;
    const end = start + colSize;
    ranks.slice(start, end).forEach((name, idx) => {
      const div = document.createElement("div");
      div.className = "rank-item";
      div.textContent = `${start + idx + 1}등: ${name}`;
      colDiv.appendChild(div);
    });
    $rankBoard.appendChild(colDiv);
  }
}

function showCelebrate(winner) {
  $winnerName.textContent = `🎉 우승: ${winner} 🎉`;
  $celebrate.classList.add("show");
}

$startBtn.onclick = startRace;
$resetBtn.onclick = () => location.reload();
$shuffleBtn.onclick = shuffleNames;
$closeCelebrateBtn.onclick = () => $celebrate.classList.remove("show");

$mapToggleBtn.onclick = () => {
  isStraightMap = !isStraightMap;
  $mapToggleBtn.textContent = `맵 전환: ${isStraightMap ? "직선" : "타원"}`;
  // 실제 맵 전환 로직은 여기에 추가
};

$replaySaveBtn.onclick = () => {
  if (!replayData || !replayData.result) return alert("저장할 리플레이가 없습니다.");
  const blob = new Blob([JSON.stringify(replayData, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `replay_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
