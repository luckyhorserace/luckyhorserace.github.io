<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lucky Horse Race — Drama Edition</title>
<style>
:root{
  --bg:#0b1220; --bg2:#0c111b; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
  --accent:#6ee7ff; --accent2:#22c55e; --border:#1f2937;
  --hay:#d9b66b; --carrot:#f97316; --leaf:#22c55e;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;color:var(--ink);background:radial-gradient(1200px 600px at 70% -10%, #13233c 0%, #0b1220 45%, #090f1a 100%);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Malgun Gothic",sans-serif;}
a{color:inherit;text-decoration:none}
.wrap{max-width:1080px;margin:0 auto;padding:16px}

/* header */
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 14px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;border-radius:12px;border:1px solid #22314d;background:linear-gradient(140deg,#1b2a45,#0c1627);display:grid;place-items:center}
.logo svg{width:26px;height:26px}
h1{margin:0;font-size:20px;letter-spacing:.2px}
.sub{margin:2px 0 0;color:var(--muted);font-size:12px}

/* panels */
.panel{background:linear-gradient(180deg,var(--panel),#0c1322 70%);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
.controls{display:flex;gap:12px;flex-wrap:wrap}
.card{flex:1 1 360px;display:flex;flex-direction:column;gap:10px}
label.small{font-size:12px;color:var(--muted)}
textarea{width:100%;min-height:120px;resize:vertical;background:#0b1220;border:1px solid #223047;color:#dbe7f3;border-radius:12px;padding:12px;outline:none}
.row{display:flex;gap:8px;flex-wrap:wrap}
select, .chip{background:#0b1220;border:1px solid #223047;color:#dbe7f3;border-radius:10px;padding:8px 10px;font-weight:700}
.chip{display:inline-flex;align-items:center;gap:6px}
button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800;letter-spacing:.2px}
.btn-accent{background:linear-gradient(180deg,#1b9ab7,#168aa4);color:#06131b;border:1px solid #0a6c82}
.btn-ghost{background:transparent;border:1px solid #2a3a57;color:#cbd5e1}
.btn-accent:hover{filter:brightness(1.06)} .btn-ghost:hover{filter:brightness(1.1)}
.hint{font-size:12px;color:var(--muted)}

/* donate chips */
.donate-row{display:flex;gap:8px;flex-wrap:wrap}
.donate{display:inline-flex;align-items:center;gap:8px;border:1px solid #2a3a57;background:#0b1220;border-radius:12px;padding:8px 10px}
.donate svg{width:18px;height:18px}

/* track wrapper */
.trackBox{margin-top:14px}
.switch{margin-left:auto}
.trackOuter{position:relative;border:1px solid var(--border);border-radius:14px;padding:14px;background:linear-gradient(180deg,#0d1728,#0c111b);min-height:360px;overflow:auto}
.finish{position:absolute;top:14px;bottom:14px;left:var(--fx,1800px);width:16px;border-radius:6px;background:conic-gradient(#fff 25%,#0000 0 50%,#fff 0 75%,#0000 0) 0/10px 10px, rgba(255,255,255,.06);border:1px solid #000;box-shadow:0 0 0 2px #0d1422 inset, 0 0 18px rgba(255,255,255,.08)}
/* single-lane visual */
.singleLane{position:relative;min-width:2400px;height:280px;border-radius:12px;background:linear-gradient(180deg,#0f1b30,#0e1525);border:1px solid #1c2741}
.rail{position:absolute;left:0;right:0;height:2px;background:#22314d;opacity:.5}
.rail.r1{top:30px}.rail.r2{bottom:30px}
.ticks{position:absolute;inset:40px 0;pointer-events:none}
.ticks::before{content:"";position:absolute;inset:0;background:repeating-linear-gradient(90deg,rgba(255,255,255,.06) 0 8px,transparent 8px 40px)}
/* oval */
.ovalWrap{position:relative; width:100%; height:520px; display:none}
.oval{position:absolute; inset:0}
.oval svg{width:100%; height:100%; display:block}
.oval .horse{position:absolute; width:46px; height:34px; transform:translate(-50%,-50%); will-change:transform}
.oval .nameplate{transform:translate(-50%,-10px)}
.startFlag{position:absolute; width:6px; height:36px; background:#fff; border:1px solid #000; left:50%; top:50%; transform:translate(-50%,-50%);}

/* horses */
.horse{position:absolute;left:0;top:0;height:34px;display:flex;align-items:center;user-select:none}
.nameplate{position:absolute;bottom:100%;left:50%;transform:translate(-50%,-8px);background:#09111e;color:#dbe7f3;border:1px solid #2a3a57;border-radius:10px;font-size:11px;font-weight:800;padding:3px 8px;pointer-events:none;white-space:nowrap;max-width:150px;text-overflow:ellipsis;overflow:hidden}

/* svg horse (original) */
.horse-svg{width:46px;height:34px}
.horse-svg .body{fill:#e5e7eb}.horse-svg .mane{fill:#cbd5e1}.horse-svg .jockey{fill:var(--jersey,#60a5fa)}.horse-svg .saddle{fill:#94a3b8}.horse-svg .eye{fill:#0f172a}
@keyframes bob {0%,100%{transform:translateY(0)}50%{transform:translateY(-1.2px)}}
@keyframes legA{0%,100%{transform:translateY(0) skewX(0)}50%{transform:translateY(-2px) skewX(-5deg)}}
@keyframes legB{0%,100%{transform:translateY(0) skewX(0)}50%{transform:translateY( 2px) skewX( 5deg)}}
.horse-svg .g-bob{animation:bob .26s infinite ease-in-out}
.horse-svg .g-legs-a{animation:legA .22s infinite ease-in-out}
.horse-svg .g-legs-b{animation:legB .22s infinite ease-in-out}

/* fx pop */
.fx{position:absolute;top:-6px;left:50%;transform:translate(-50%,-100%);background:#111827;color:#e5e7eb;font-size:11px;padding:4px 7px;border:1px solid #334155;border-radius:8px;opacity:0;pointer-events:none;transition:transform .2s ease,opacity .2s ease;white-space:nowrap;display:flex;gap:6px;align-items:center}
.fx.show{opacity:1;transform:translate(-50%,-140%)}
.fx svg{width:12px;height:12px;display:block}

/* winner */
.winner{margin-top:12px;display:none;padding:12px;border-radius:12px;background:linear-gradient(180deg,#0e1e33,#0a1626);border:1px solid #213250}
.winner strong{color:#9ae6b4}.timer{color:#a0aec0;font-size:12px}

/* modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999}
.modal.show{display:block}
.modal-content{background:#0b1220;color:#e5e7eb;max-width:380px;margin:8% auto;padding:18px;border:1px solid #334155;border-radius:12px;text-align:center}
.contact-box{margin:12px 0;padding:10px;border:1px dashed #334155;border-radius:10px}
.btn-close{margin-top:10px;padding:8px 12px;border-radius:8px;background:#111827;color:#e5e7eb;border:1px solid #334155;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <!-- 말밥(건초) 아이콘 -->
        <svg viewBox="0 0 64 64" fill="none">
          <rect x="10" y="22" width="44" height="20" rx="6" fill="url(#g)"/>
          <path d="M14 24l6 5M20 24l6 5M26 24l6 5M32 24l6 5M38 24l6 5M44 24l6 5" stroke="#7a5a20" stroke-width="2"/>
          <defs><linearGradient id="g" x1="10" x2="54" y1="22" y2="42"><stop stop-color="#e8c87a"/><stop offset="1" stop-color="#caa555"/></linearGradient></defs>
        </svg>
      </div>
      <div>
        <h1>Lucky Horse Race — Drama Edition</h1>
        <p class="sub">단일/원형 트랙 · 스킬 · 부딪힘 · 2~3분짜리 긴장감</p>
      </div>
    </div>
    <div class="row">
      <button class="btn-ghost" id="btnDonate">말밥 보내주기</button>
      <button class="btn-ghost" id="btnContact">문의</button>
    </div>
  </header>

  <section class="panel controls">
    <div class="card">
      <label class="small">참가자 이름 (줄바꿈 구분, 최대 14명)</label>
      <textarea id="names" placeholder="예)
도라에몽
노진구
루피
나미
우솝"></textarea>
      <div class="row">
        <span class="chip">트랙
          <select id="trackType">
            <option value="single">단일 직선</option>
            <option value="oval">원형</option>
          </select>
        </span>
        <span class="chip">연출 길이
          <select id="raceLen">
            <option value="short">짧게(~40초)</option>
            <option value="standard" selected>표준(~90초)</option>
            <option value="drama">드라마(~150~180초)</option>
          </select>
        </span>
      </div>
      <div class="row">
        <button class="btn-accent" id="startBtn">Start Race ▶</button>
        <button class="btn-ghost" id="buildBtn">트랙 새로고침</button>
        <button class="btn-ghost" id="resetBtn">Reset</button>
      </div>
      <div class="hint" id="pHint">참가자 0명</div>
    </div>
    <div class="card">
      <div class="donate-row">
        <div class="donate"><svg viewBox="0 0 64 64"><rect x="10" y="22" width="44" height="20" rx="6" fill="#e8c87a"/><path d="M14 24l6 5M20 24l6 5M26 24l6 5M32 24l6 5M38 24l6 5M44 24l6 5" stroke="#7a5a20" stroke-width="2"/></svg>건초 한 포대</div>
        <div class="donate"><svg viewBox="0 0 64 64"><path d="M20 32c0-9 9-14 12-14s12 5 12 14-9 18-12 18-12-9-12-18z" fill="#f97316"/><path d="M32 16c2 2 4 5 5 8" stroke="#fff" stroke-opacity=".6"/><path d="M30 14c2-3 6-6 10-7" stroke="#22c55e" stroke-width="4" stroke-linecap="round"/></svg>당근 두 개</div>
      </div>
      <div class="hint">후원은 상단 <strong>말밥 보내주기</strong> 버튼으로 💙</div>
    </div>
  </section>

  <!-- 직선 단일 트랙 -->
  <section class="trackBox panel" id="linearBox" style="display:block">
    <div class="trackOuter" id="linearOuter">
      <div class="singleLane" id="singleLane">
        <div class="rail r1"></div><div class="rail r2"></div><div class="ticks"></div>
        <div class="finish" id="finishLinear"></div>
      </div>
    </div>
    <div class="winner" id="winnerLinear">
      <div class="timer" id="timeLinear"></div>
      <div><strong>우승:</strong> <span id="nameLinear"></span></div>
    </div>
  </section>

  <!-- 원형 트랙 -->
  <section class="trackBox panel" id="ovalBox" style="display:none">
    <div class="ovalWrap" id="ovalWrap">
      <div class="oval" id="oval">
        <svg viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet">
          <rect x="0" y="0" width="1000" height="600" fill="#0c111b"/>
          <ellipse cx="500" cy="300" rx="420" ry="220" fill="#0e1a2a" stroke="#243447" stroke-width="2"/>
          <ellipse cx="500" cy="300" rx="360" ry="160" fill="#0b1220" stroke="#1f2937" stroke-width="2"/>
          <ellipse cx="500" cy="300" rx="390" ry="190" fill="none" stroke="#334155" stroke-dasharray="6,6"/>
        </svg>
        <div class="startFlag"></div>
      </div>
    </div>
    <div class="winner" id="winnerOval">
      <div class="timer" id="timeOval"></div>
      <div><strong>우승:</strong> <span id="nameOval"></span></div>
    </div>
  </section>
</div>

<!-- 문의 모달 -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3 style="margin:0 0 6px">문의 · 제안 · 보안 이슈</h3>
    <div class="contact-box small">
      버그/개선/보안 제보는 이메일로 보내주세요.<br>
      <strong>Email:</strong> <a href="mailto:luckyhorserace@gmail.com">luckyhorserace@gmail.com</a>
    </div>
    <div class="row" style="justify-content:center">
      <button class="btn-ghost" onclick="navigator.clipboard.writeText('luckyhorserace@gmail.com')">메일 주소 복사</button>
      <button class="btn-ghost" id="openDonate">말밥 보내주기</button>
    </div>
    <button class="btn-close" onclick="document.getElementById('modal').classList.remove('show')">닫기</button>
  </div>
</div>

<!-- 말밥(후원) 모달 -->
<div class="modal" id="donateModal">
  <div class="modal-content">
    <h3 style="margin:0 0 6px">말밥 보내주기</h3>
    <div class="contact-box">
      <!-- 귀여운 건초/당근 -->
      <div class="donate-row" style="justify-content:center">
        <div class="donate"><svg viewBox="0 0 64 64"><rect x="10" y="22" width="44" height="20" rx="6" fill="#e8c87a"/><path d="M14 24l6 5M20 24l6 5M26 24l6 5M32 24l6 5M38 24l6 5M44 24l6 5" stroke="#7a5a20" stroke-width="2"/></svg>건초 한 포대</div>
        <div class="donate"><svg viewBox="0 0 64 64"><path d="M20 32c0-9 9-14 12-14s12 5 12 14-9 18-12 18-12-9-12-18z" fill="#f97316"/><path d="M30 14c2-3 6-6 10-7" stroke="#22c55e" stroke-width="4" stroke-linecap="round"/></svg>당근 두 개</div>
      </div>
      <p class="hint" style="margin-top:8px">원하시는 후원 링크를 여기에 연결해두세요.</p>
    </div>
    <div class="row" style="justify-content:center">
      <a class="btn-accent" href="#" onclick="alert('후원 링크를 연결해주세요!')">후원하기</a>
      <button class="btn-ghost" onclick="document.getElementById('donateModal').classList.remove('show')">닫기</button>
    </div>
  </div>
</div>

<script>
/* ===== PRNG & helpers ===== */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
let _rand=Math.random; function reseed(seed){_rand=mulberry32(seed|0)}
function autoSeed(){return (Date.now() ^ Math.floor(Math.random()*0xFFFFFFFF))>>>0}
const JERSEYS=['#60a5fa','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6','#eab308','#fb7185','#34d399','#f97316','#a3e635','#e879f9','#f43f5e','#6ee7ff'];
function jc(i){return JERSEYS[i%JERSEYS.length]}
function parseNames(raw){return raw.split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,14).map(n=>({name:n}))}
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.floor(_rand()*(i+1)));[a[i],a[j]]=[a[j],a[i]]}return a}
function fx(h,icon,label){
  const svg = icon==='bolt'
    ? '<svg viewBox="0 0 24 24"><path fill="#f59e0b" d="M13 2 3 14h7l-1 8 10-12h-7l1-8z"/></svg>'
    : icon==='shield'
      ? '<svg viewBox="0 0 24 24"><path fill="#22c55e" d="M12 2 4 6v6c0 5 8 10 8 10s8-5 8-10V6l-8-4z"/></svg>'
      : icon==='snow'
        ? '<svg viewBox="0 0 24 24"><path fill="#60a5fa" d="M12 2v20M4 6l16 12M4 18L20 6"/></svg>'
        : '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#93c5fd"/></svg>';
  const el=document.createElement('div'); el.className='fx'; el.innerHTML=svg+'<span>'+label+'</span>';
  h.appendChild(el); requestAnimationFrame(()=>el.classList.add('show')); setTimeout(()=>el.remove(),1000);
}

/* ===== SVG Horse (original) ===== */
function horseSVG(color='#60a5fa'){ return `
<svg class="horse-svg" viewBox="0 0 64 44" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="--jersey:${color}">
  <g class="g-legs-b"><rect x="16" y="28" width="5" height="12" rx="1" fill="#cbd5e1"/><rect x="30" y="29" width="5" height="12" rx="1" fill="#cbd5e1"/></g>
  <g class="g-bob">
    <path class="mane" d="M10 26c2-3 3-5 6-6 0 4-2 7-4 9l-4-1 2-2z"/>
    <path class="body" d="M8 28c7-9 12-11 20-11h9c7 0 14 4 19 9l3 5-4 2-6-4-7 2H28l-8 1-6 3-6-1 6-6z"/>
    <rect class="saddle" x="28" y="17" width="11" height="7" rx="2"/>
    <g class="jockey"><circle cx="31" cy="12" r="3.6"/><rect x="28" y="15.5" width="10" height="7" rx="2"/></g>
    <circle class="eye" cx="22.5" cy="20.5" r="0.9"/>
  </g>
  <g class="g-legs-a"><rect x="22" y="29" width="5" height="12" rx="1" fill="#cbd5e1"/><rect x="38" y="28" width="5" height="12" rx="1" fill="#cbd5e1"/></g>
</svg>`}

/* ===== DOM ===== */
const $names=document.getElementById('names');
const $trackType=document.getElementById('trackType');
const $raceLen=document.getElementById('raceLen');
const $start=document.getElementById('startBtn');
const $build=document.getElementById('buildBtn');
const $reset=document.getElementById('resetBtn');
const $pHint=document.getElementById('pHint');
/* linear */
const $linearBox=document.getElementById('linearBox');
const $linearOuter=document.getElementById('linearOuter');
const $singleLane=document.getElementById('singleLane');
const $finishLinear=document.getElementById('finishLinear');
const $winnerLinear=document.getElementById('winnerLinear');
const $timeLinear=document.getElementById('timeLinear');
const $nameLinear=document.getElementById('nameLinear');
/* oval */
const $ovalBox=document.getElementById('ovalBox');
const $ovalWrap=document.getElementById('ovalWrap');
const $oval=document.getElementById('oval');
const $winnerOval=document.getElementById('winnerOval');
const $timeOval=document.getElementById('timeOval');
const $nameOval=document.getElementById('nameOval');

/* donate & contact */
document.getElementById('btnContact').onclick=()=>document.getElementById('modal').classList.add('show');
document.getElementById('btnDonate').onclick=()=>document.getElementById('donateModal').classList.add('show');
document.getElementById('openDonate').onclick=()=>{document.getElementById('donateModal').classList.add('show');document.getElementById('modal').classList.remove('show')}

/* ===== State ===== */
const MIN=2, MAX=14;
let running=false, raf=null, startTs=0;
let horses=[]; // shared model for either mode
// linear
let finishX=1800;
// oval
let cx=500, cy=300, rx=390, ry=190, laps=1.6;

/* ===== Length presets (pace) ===== */
const LEN = {
  short:   {base:0.17, noise:0.05, sprint:{prob:0.007,boost:1.1,dur:[250,500],cd:[900,1400]}, distance:1600, laps:1.2},
  standard:{base:0.145,noise:0.05, sprint:{prob:0.007,boost:1.15,dur:[280,600],cd:[1000,1600]}, distance:2200, laps:1.4},
  drama:   {base:0.122,noise:0.05, sprint:{prob:0.008,boost:1.2, dur:[320,680], cd:[1100,1800]}, distance:3000, laps:1.65}
};
let pace=LEN.standard;

/* ===== Skills & interactions =====
- Draft(슬립스트림): 앞 말 뒤 40~90px 사이 보너스
- Sprint(스프린트): 확률 발동, 잠깐 가속
- Bump(부딪힘): 근접 시 살짝 밀침, 속도 손실
- Shield(방어막): 가끔 자동, bump 무효화
- Stumble(실수): 드물게 미끄러짐(감속)
*/
const DRAFT={min:40,max:90,bonus:0.09};
const BUMP={dist:18, nudge:-0.6, cd:[800,1200]};
const SHIELD={prob:0.002, dur:[300,600], cd:[1800,2600]};
const STUMBLE={prob:0.0012, slow:-0.9, dur:[300,500], cd:[2000,3200]};
function r([a,b]){return a + _rand()*(b-a)}

/* ===== Build Single (linear all together) ===== */
function setFinishAuto(){
  const visW = $linearOuter.clientWidth - 80;
  finishX = Math.max(1200, pace.distance, visW*2.4);
  $finishLinear.style.setProperty('--fx', finishX+'px');
}
function buildLinear(list){
  $singleLane.querySelectorAll('.horse').forEach(n=>n.remove());
  setFinishAuto();
  const hgap = 18; // vertical separation but same lane 느낌
  list.forEach((ent,i)=>{
    const h=document.createElement('div'); h.className='horse';
    h.style.left='0px'; h.style.top=(40 + i*hgap)+'px';
    h.innerHTML=horseSVG(jc(i));
    const plate=document.createElement('div'); plate.className='nameplate'; plate.textContent=ent.name;
    h.appendChild(plate);
    $singleLane.appendChild(h);
    ent.$el=h; ent.x=0; ent.theta=0; ent.v=0; ent.done=false;
    ent.sprint=0; ent.sCd=0;
    ent.bumpCd=0;
    ent.shield=0; ent.shCd=0;
    ent.stumble=0; ent.stCd=0;
  });
}

/* ===== Build Oval ===== */
function buildOval(list){
  $oval.querySelectorAll('.horse').forEach(n=>n.remove());
  const rect=$oval.getBoundingClientRect();
  cx=rect.width/2; cy=rect.height/2; rx=Math.min(rect.width*0.39,430); ry=Math.min(rect.height*0.36,210);
  laps=pace.laps;
  list.forEach((ent,i)=>{
    const h=document.createElement('div'); h.className='horse'; h.style.transform='translate(-50%,-50%)';
    h.innerHTML=horseSVG(jc(i));
    const plate=document.createElement('div'); plate.className='nameplate'; plate.textContent=ent.name;
    h.appendChild(plate); $oval.appendChild(h);
    ent.$el=h; ent.theta=0; ent.v=0; ent.done=false;
    ent.sprint=0; ent.sCd=0; ent.bumpCd=0; ent.shield=0; ent.shCd=0; ent.stumble=0; ent.stCd=0;
  });
}

/* ===== Hint ===== */
function updateHint(list){
  const n=list.length;
  const s = n<MIN ? '최소 2명' : (n>MAX ? '최대 14명 (초과는 잘림)' : 'OK');
  $pHint.textContent=`참가자 ${n}명 · ${s}`;
}

/* ===== Physics (linear) ===== */
function stepLinear(dt){
  // interactions
  for(const h of horses){
    if(h.done) continue;
    // shields & stumbles timers
    if(h.shield>0) h.shield-=dt; else h.shCd-=dt;
    if(h.stumble>0) h.stumble-=dt; else h.stCd-=dt;

    // maybe shield
    if(h.shield<=0 && h.shCd<=0 && _rand()<SHIELD.prob){ h.shield=r(SHIELD.dur); h.shCd=r(SHIELD.cd); fx(h.$el,'shield','방어막!') }

    // maybe stumble
    if(h.stumble<=0 && h.stCd<=0 && _rand()<STUMBLE.prob){ h.stumble=r(STUMBLE.dur); h.stCd=r(STUMBLE.cd); fx(h.$el,'snow','미끄럼!') }

    // sprint
    if(h.sprint<=0 && h.sCd<=0 && _rand()<pace.sprint.prob){ h.sprint=r(pace.sprint.dur); h.sCd=r(pace.sprint.cd); fx(h.$el,'bolt','스프린트!') }
  }

  // speed compute & collisions
  for(let i=0;i<horses.length;i++){
    const h=horses[i]; if(h.done) continue;
    const noise=( (_rand()-0.5)*pace.noise );
    // draft: someone ahead within range
    let draft=0;
    for(const o of horses){ if(o===h) continue; const d=o.x-h.x; if(d>DRAFT.min && d<DRAFT.max){ draft=Math.max(draft, DRAFT.bonus * (1- (d-DRAFT.min)/(DRAFT.max-DRAFT.min))); } }
    const sprint = h.sprint>0 ? pace.sprint.boost : 0;
    const stumble = h.stumble>0 ? STUMBLE.slow : 0;
    h.v = (pace.base + noise) * (1 + draft) + sprint + stumble;
    // bump if near
    if(h.bumpCd<=0){
      for(const o of horses){ if(o===h) continue; if(Math.abs((o.x)-(h.x))<BUMP.dist && Math.abs(o.$el.offsetTop-h.$el.offsetTop)<22){
          if(h.shield<=0){ h.v += BUMP.nudge; fx(h.$el,'snow','부딪힘!'); }
          h.bumpCd=r(BUMP.cd); break;
        } }
    } else h.bumpCd-=dt;

    h.x += h.v*dt;
    h.sprint-=dt; h.sCd-=dt;

    h.$el.style.left = Math.max(0, h.x|0) + 'px';

    if(h.x >= finishX-40){ h.done=true; }
  }

  // camera follow leader
  const maxX=Math.max(...horses.map(h=>h.x||0));
  $linearOuter.scrollLeft = Math.max(0, maxX - $linearOuter.clientWidth*0.55);
}

/* ===== Physics (oval) ===== */
function stepOval(dt){
  for(const h of horses){
    if(h.done) continue;
    // timers
    if(h.shield>0) h.shield-=dt; else h.shCd-=dt;
    if(h.stumble>0) h.stumble-=dt; else h.stCd-=dt;

    if(h.shield<=0 && h.shCd<=0 && _rand()<SHIELD.prob){ h.shield=r(SHIELD.dur); h.shCd=r(SHIELD.cd); fx(h.$el,'shield','방어막!') }
    if(h.stumble<=0 && h.stCd<=0 && _rand()<STUMBLE.prob){ h.stumble=r(STUMBLE.dur); h.stCd=r(STUMBLE.cd); fx(h.$el,'snow','미끄럼!') }
    if(h.sprint<=0 && h.sCd<=0 && _rand()<pace.sprint.prob){ h.sprint=r(pace.sprint.dur); h.sCd=r(pace.sprint.cd); fx(h.$el,'bolt','스프린트!') }
  }

  // pairwise interactions based on angle
  for(const h of horses){
    if(h.done) continue;
    const noise=( (_rand()-0.5)*0.00035 );
    let draft=0;
    for(const o of horses){ if(o===h) continue; const d=o.theta-h.theta; if(d>0.05 && d<0.35) draft=Math.max(draft,0.06) }
    const sprint = h.sprint>0 ? 0.003 : 0;
    const stumble = h.stumble>0 ? -0.002 : 0;
    h.v = (0.0012 + noise) * (1 + draft) + sprint + stumble;

    // bump by small angle gap
    if(h.bumpCd<=0){
      for(const o of horses){ if(o===h) continue; if(Math.abs(o.theta-h.theta)<0.04){
          if(h.shield<=0){ h.v += -0.002; fx(h.$el,'snow','부딪힘!') }
          h.bumpCd=r(BUMP.cd); break;
      } }
    } else h.bumpCd-=dt;

    h.theta += h.v*dt;
    // map position
    const t=h.theta;
    const x=cx + rx*Math.cos(t), y=cy + ry*Math.sin(t);
    h.$el.style.left=x+'px'; h.$el.style.top=y+'px';
    const dx=-rx*Math.sin(t), dy=ry*Math.cos(t);
    const ang=Math.atan2(dy,dx)*180/Math.PI;
    h.$el.style.transform=`translate(-50%,-50%) rotate(${ang}deg)`;

    // finish
    if( (h.theta/(Math.PI*2)) >= laps ){ h.done=true; }
  }
}

/* ===== Loop ===== */
function loopLinear(){
  running=true; startTs=performance.now();
  const stepper=()=>{ stepLinear(16);
    if(horses.every(h=>h.done)){ running=false; cancelAnimationFrame(raf); raf=null;
      const order=horses.slice().sort((a,b)=>b.x-a.x);
      $nameLinear.textContent=order[0].name;
      $timeLinear.textContent=`경과 ${((performance.now()-startTs)/1000).toFixed(2)}s`;
      $winnerLinear.style.display='block'; return; }
    raf=requestAnimationFrame(stepper);
  };
  raf=requestAnimationFrame(stepper);
}
function loopOval(){
  running=true; startTs=performance.now();
  const stepper=()=>{ stepOval(16);
    if(horses.every(h=>h.done)){ running=false; cancelAnimationFrame(raf); raf=null;
      $nameOval.textContent=horses[0].name; // all finished; first appended might not be winner, so:
      const order=horses.slice().sort((a,b)=>b.theta-a.theta);
      $nameOval.textContent=order[0].name;
      $timeOval.textContent=`경과 ${((performance.now()-startTs)/1000).toFixed(2)}s`;
      $winnerOval.style.display='block'; return; }
    raf=requestAnimationFrame(stepper);
  };
  raf=requestAnimationFrame(stepper);
}

/* ===== Controls ===== */
function resetWinners(){
  $winnerLinear.style.display='none'; $nameLinear.textContent=''; $timeLinear.textContent='';
  $winnerOval.style.display='none'; $nameOval.textContent=''; $timeOval.textContent='';
}
function buildByType(list){
  if($trackType.value==='single'){ $linearBox.style.display='block'; $ovalBox.style.display='none'; buildLinear(list); }
  else{ $linearBox.style.display='none'; $ovalBox.style.display='block'; buildOval(list); }
}
function applyLen(){
  const val=$raceLen.value; pace=LEN[val]||LEN.standard;
}
$build.onclick=()=>{
  if(running) return;
  applyLen();
  const list=parseNames($names.value); if(list.length<MIN){alert('최소 2명을 입력해주세요.');return}
  horses=list; buildByType(horses); resetWinners(); updateHint(horses);
};
$start.onclick=()=>{
  if(running) return;
  applyLen();
  let list=parseNames($names.value); if(list.length<MIN){alert('최소 2명을 입력해주세요.');return}
  reseed(autoSeed()); list=shuffle(list); horses=list; buildByType(horses); resetWinners();
  if($trackType.value==='single') loopLinear(); else loopOval();
};
$reset.onclick=()=>{
  cancelAnimationFrame(raf); raf=null; running=false; resetWinners();
  if($trackType.value==='single'){ $singleLane.querySelectorAll('.horse').forEach(n=>n.remove()); setFinishAuto(); }
  else{ $oval.querySelectorAll('.horse').forEach(n=>n.remove()); }
  updateHint(parseNames($names.value));
};
$names.addEventListener('input', ()=>updateHint(parseNames($names.value)));
$trackType.addEventListener('change', ()=>{
  if(running) return;
  const list=parseNames($names.value); if(list.length>=MIN){ buildByType(list) }
});
window.addEventListener('resize', ()=>{ if($trackType.value==='single') setFinishAuto(); });

/* init */
updateHint(parseNames($names.value));
setFinishAuto();
</script>
</body>
</html>
