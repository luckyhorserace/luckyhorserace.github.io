# Create a minimal, self-contained GitHub Pages-ready racing game (single file index.html)
# with Canvas rendering, two modes (oval 3 laps, straight sprint),
# winner modes (1st, last, Nth), start lights + simple WebAudio beeps, BuyMeACoffee link,
# inquiry modal, up to 20 players, progress bar, leaderboard, and simple horse animation.

import os, textwrap, zipfile, json, io, base64

html = r"""<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lucky Horse Race</title>
<style>
  :root{
    --bg:#0c0f14;
    --panel:#10151d;
    --panel2:#121820;
    --accent:#ffd54a;
    --accent2:#5ee1ff;
    --text:#e9eef7;
    --muted:#9fb1c9;
    --success:#74ff9f;
    --danger:#ff6f6f;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter, Pretendard, "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Malgun Gothic", "Helvetica Neue", Arial, sans-serif;}
  .wrap{display:grid;grid-template-columns:380px 1fr;gap:16px;height:100%;padding:16px;}
  aside{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #1c2430;border-radius:14px;padding:16px;overflow:auto;}
  h1{font-size:22px;margin:0 0 10px;letter-spacing:0.2px}
  h2{font-size:14px;margin:14px 0 8px;color:var(--muted)}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid #263041;background:#0d131b;color:var(--text);outline:none;
  }
  button{
    cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700;letter-spacing:0.2px;
    background:linear-gradient(180deg,#2a3344,#1e2736);color:var(--text);border:1px solid #2d3a50;
    transition:transform .05s ease, filter .15s ease;
  }
  button:hover{filter:brightness(1.08)}
  button:active{transform:translateY(1px)}
  .btn-accent{background:linear-gradient(180deg,#ffd54a,#ffb300);color:#1c1400;border-color:#e2a800}
  .btn-outline{background:transparent;border:1px solid #3a4a62}
  .row{display:flex;gap:8px;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .players{display:flex;flex-direction:column;gap:6px}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#141b25;border:1px solid #273246;color:var(--muted)}
  .list{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .foot{display:flex;gap:8px;margin-top:10px}
  .bar{height:8px;background:#121722;border:1px solid #2a364a;border-radius:999px;overflow:hidden}
  .bar>div{height:100%;background:linear-gradient(90deg,#4a79ff,#1ad1ff)}
  main{position:relative;background:#0a0d12;border:1px solid #1c2430;border-radius:14px;overflow:hidden}
  canvas{display:block;width:100%;height:100%}
  .hud{position:absolute;inset:0;pointer-events:none}
  .ribbon{position:absolute;left:16px;top:16px;right:16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
  .leader{display:flex;gap:8px;align-items:center}
  .leader .card{display:flex;gap:10px;align-items:center;background:rgba(9,13,19,.72);border:1px solid #1e2634;border-radius:12px;padding:6px 10px;backdrop-filter: blur(6px)}
  .card .rank{width:22px;height:22px;border-radius:6px;background:#182033;display:grid;place-items:center;font-weight:800;font-size:12px}
  .lap{padding:6px 10px;background:rgba(9,13,19,.72);border:1px solid #1e2634;border-radius:999px;backdrop-filter: blur(6px);font-size:12px}
  .ticker{position:absolute;left:16px;top:60px;right:16px;display:flex;gap:6px;overflow:hidden;white-space:nowrap}
  .ticker span{background:rgba(9,13,19,.6);border:1px solid #1e2634;border-radius:999px;padding:4px 8px;font-size:12px}
  .progress{position:absolute;left:16px;right:16px;bottom:16px;background:rgba(9,13,19,.6);border:1px solid #1e2634;border-radius:12px;padding:10px;backdrop-filter: blur(6px)}
  .progress .track{height:10px;background:#0b1017;border:1px solid #223049;border-radius:999px;position:relative;overflow:hidden}
  .marker{position:absolute;top:-4px;width:18px;height:18px;border-radius:50%;border:2px solid #fff;transform:translate(-50%,0);display:grid;place-items:center;font-size:10px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6)}
  .toast{position:absolute;left:50%;top:20%;transform:translate(-50%, -50%);background:rgba(10,14,20,.72);border:1px solid #243048;border-radius:14px;padding:14px 16px;font-weight:700;letter-spacing:.4px;backdrop-filter:blur(8px);display:none}
  .finishBanner{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,#1d2535,#111828);border:1px solid #2b3750;border-radius:16px;padding:18px 22px;display:none;box-shadow:0 12px 40px rgba(0,0,0,.5)}
  .finishBanner h3{margin:0 0 6px;font-size:26px}
  .finishBanner p{margin:0;color:var(--muted)}
  .floatingTag{position:absolute;padding:4px 8px;border-radius:999px;background:rgba(15,19,27,.72);border:1px solid #203048;font-size:11px;pointer-events:none;white-space:nowrap}
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999
  }
  .modal .box{background:#0d131b;border:1px solid #2b3750;border-radius:16px;max-width:520px;width:100%;padding:18px}
  .box h3{margin:0 0 10px}
  .box p{color:var(--muted);margin:8px 0 14px}
  .box .actions{display:flex;gap:8px;justify-content:flex-end}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  .topBtns{display:flex;gap:8px;flex-wrap:wrap}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <aside>
    <h1>Lucky Horse Race</h1>
    <div class="pill">브라우저에서 바로 즐기는 파티용 경마 게임</div>

    <h2>참가자 (최대 20명)</h2>
    <div id="players" class="players"></div>
    <div class="row" style="margin-top:6px">
      <input id="nameInput" type="text" placeholder="이름 입력 후 추가 (엔터)">
      <button id="addBtn">추가</button>
      <button id="fillBtn" class="btn-outline">랜덤 채우기</button>
    </div>
    <div class="note">Tip: 엔터로 빠르게 여러 명을 추가하세요.</div>

    <h2>게임 모드</h2>
    <div class="grid">
      <label class="pill"><input type="radio" name="mode" value="first" checked> 1등 승리</label>
      <label class="pill"><input type="radio" name="mode" value="last"> 마지막 입장 승리</label>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="pill" style="flex:1"><input type="radio" name="mode" value="nth"> N번째 승리</label>
      <input id="nth" type="number" min="1" max="20" value="3" style="width:90px" aria-label="Nth">
    </div>

    <h2>맵 선택</h2>
    <div class="grid">
      <label class="pill"><input type="radio" name="map" value="oval" checked> 원형 3바퀴</label>
      <label class="pill"><input type="radio" name="map" value="straight"> 직선 스프린트</label>
    </div>

    <h2>옵션</h2>
    <div class="grid">
      <label class="pill"><input id="soundToggle" type="checkbox" checked> 사운드 ON</label>
      <label class="pill"><input id="colorBlind" type="checkbox"> 색약 친화</label>
    </div>
    <div class="row" style="margin-top:6px">
      <label class="pill" style="flex:1">RNG 시드</label>
      <input id="seed" type="text" placeholder="비워두면 랜덤" style="flex:2">
    </div>

    <div class="foot">
      <button id="startBtn" class="btn-accent" style="flex:1">경기 시작</button>
      <button id="resetBtn" class="btn-outline">초기화</button>
    </div>

    <h2>지원</h2>
    <div class="topBtns">
      <button id="supportBtn">개발자 응원하기</button>
      <button id="coffeeBtn">커피 한 잔 보내기 ☕️</button>
      <button id="contactBtn" class="btn-outline">개발자에게 문의하기 ✉️</button>
    </div>
    <div class="note">Buy Me a Coffee와 이메일 문의가 열립니다.</div>

    <h2>상태</h2>
    <div class="bar"><div id="readyBar" style="width:0%"></div></div>
    <div id="status" class="small" style="margin-top:6px">준비 중… 참가자를 추가하세요.</div>
  </aside>

  <main>
    <canvas id="cv"></canvas>
    <div class="hud">
      <div class="ribbon">
        <div class="leader" id="leaders"></div>
        <div class="lap" id="lap">Lap 0/3</div>
      </div>
      <div class="ticker" id="ticker"></div>
      <div class="toast" id="toast">Photo Finish! 결과 확인 중…</div>
      <div class="progress">
        <div class="track" id="trackBar"></div>
      </div>
      <div class="finishBanner" id="finishBanner">
        <h3 id="finishTitle">Winner!</h3>
        <p id="finishSub">기록 0:00.00</p>
        <div class="badges" id="badgeList"></div>
      </div>
    </div>
  </main>
</div>

<!-- Modals -->
<div id="supportModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <h3>응원해 주셔서 감사합니다!</h3>
    <p>자유롭게 이용해 주세요. 더 좋은 게임을 위해 응원해 주신다면 큰 힘이 됩니다.</p>
    <div class="actions">
      <button class="btn-outline" onclick="closeModal('supportModal')">닫기</button>
      <a class="btn-accent" href="https://buymeacoffee.com/luckyhorse" target="_blank" rel="noopener">Buy Me a Coffee로 이동</a>
    </div>
  </div>
</div>

<div id="contactModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <h3>문의 & 피드백</h3>
    <p>자유롭게 이용해주시고, 문의·피드백·건의·요청사항이 있으면 언제든 연락 주세요.<br>
    이메일: <b>luckyhorserace@gmail.com</b></p>
    <div class="actions">
      <button class="btn-outline" onclick="copyEmail()">주소 복사</button>
      <a class="btn-accent" href="mailto:luckyhorserace@gmail.com">메일 앱 열기</a>
      <button onclick="closeModal('contactModal')">닫기</button>
    </div>
  </div>
</div>

<script>
// ---------- Utilities ----------
const $, $$ = (q,root=document)=>root.querySelector(q), (qq,root=document)=>[...root.querySelectorAll(qq)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const TAU=Math.PI*2;

// Simple seeded RNG
class RNG{
  constructor(seed){
    if(!seed){ seed = Math.random().toString(36).slice(2); }
    this.seedStr = seed;
    this.s = [...seed].reduce((a,c)=>(a*31 + c.charCodeAt(0))>>>0, 2166136261>>>0);
  }
  next(){
    // xorshift32
    let x=this.s;
    x^=x<<13; x^=x>>>17; x^=x<<5;
    this.s=x>>>0;
    return (this.s&0x7fffffff)/0x80000000;
  }
  range(a,b){return a + (b-a)*this.next()}
  pick(arr){return arr[Math.floor(this.next()*arr.length)]}
}

const COLORS = [
  '#ff3b30','#ff9500','#ffcc00','#4cd964','#5ac8fa','#007aff','#5856d6','#ff2d55',
  '#ffd166','#06d6a0','#118ab2','#ef476f','#8ac926','#1982c4','#6a4c93','#fca311',
  '#e5383b','#3a86ff','#ff006e','#8338ec'
];
const PATTERNS = ['●','★','■','▲','◆','▦','▩','▣','▤','▥','✚','✦','✶','✳︎','※','✸','✹','✺','✻','☰'];

// ---------- Audio ----------
const AudioSys = (()=>{
  let ctx;
  function ensure(){ if(!ctx){ ctx = new (window.AudioContext||window.webkitAudioContext)(); } return ctx; }
  function beep(freq=880, dur=0.18, type='sine', vol=0.2){
    const ac=ensure();
    const o=ac.createOscillator(), g=ac.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0, ac.currentTime);
    g.gain.linearRampToValueAtTime(vol, ac.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+dur);
    o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+dur+0.05);
  }
  function gun(){
    const ac=ensure();
    const b=ac.createBuffer(1, ac.sampleRate*0.18, ac.sampleRate);
    const d=b.getChannelData(0);
    for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,3); }
    const src=ac.createBufferSource(); src.buffer=b;
    const g=ac.createGain(); g.gain.value=.6; src.connect(g).connect(ac.destination);
    src.start();
  }
  function crowd(dur=2.5){
    const ac=ensure();
    const b=ac.createBuffer(1, ac.sampleRate*dur, ac.sampleRate);
    const d=b.getChannelData(0);
    for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*0.04; }
    const src=ac.createBufferSource(); src.buffer=b;
    const g=ac.createGain(); g.gain.value=.4; src.playbackRate.value=0.7;
    src.connect(g).connect(ac.destination); src.start();
  }
  return {beep, gun, crowd};
})();

// ---------- State & Setup ----------
const state = {
  players: [],
  colors: [],
  rng: new RNG(),
  running:false,
  finished:false,
  map:'oval', // 'straight'
  mode:'first', // 'last' | 'nth'
  nth:3,
  sound:true,
  colorBlind:false,
  lapTotal:3,
};

function initUI(){
  const pWrap = $('#players');
  function renderPlayers(){
    pWrap.innerHTML='';
    state.players.forEach((n,i)=>{
      const row=document.createElement('div');
      row.className='row';
      row.innerHTML=`<div class="pill" style="flex:1;display:flex;align-items:center;justify-content:space-between;gap:8px">
        <span>${i+1}. ${n}</span>
        <span style="font-weight:800;color:${state.colors[i]}">${PATTERNS[i%PATTERNS.length]}</span>
      </div>
      <button data-i="${i}" class="btn-outline">삭제</button>`;
      pWrap.appendChild(row);
      row.querySelector('button').onclick=()=>{ state.players.splice(i,1); state.colors.splice(i,1); renderPlayers(); syncStatus(); };
    });
  }
  function addName(name){
    name = (name||'').trim();
    if(!name) return;
    if(state.players.length>=20){ alert('최대 20명까지 가능합니다.'); return; }
    state.players.push(name);
    state.colors.push(COLORS[state.players.length-1] || COLORS[state.rng.range(0,COLORS.length)|0]);
    $('#nameInput').value='';
    renderPlayers(); syncStatus();
  }
  $('#addBtn').onclick=()=>addName($('#nameInput').value);
  $('#nameInput').addEventListener('keydown',e=>{ if(e.key==='Enter') addName($('#nameInput').value); });
  $('#fillBtn').onclick=()=>{
    const presets=['철수','영희','민수','지현','태호','지수','수진','현우','도윤','유진','지훈','소연','서준','채원','하준','유나','은우','가은','주원','민준'];
    while(state.players.length<20) addName(presets[state.players.length]);
  };

  $$('input[name="mode"]').forEach(el=>{
    el.onchange=()=>{ state.mode=el.value; syncStatus(); };
  });
  $('#nth').oninput=()=>{ state.nth=clamp(parseInt($('#nth').value||1),1,20); syncStatus(); };
  $$('input[name="map"]').forEach(el=>{ el.onchange=()=>{ state.map=el.value; syncStatus(); }; });
  $('#seed').oninput=()=>{ /* no-op */ };
  $('#soundToggle').onchange=()=>{ state.sound=$('#soundToggle').checked; };
  $('#colorBlind').onchange=()=>{ state.colorBlind=$('#colorBlind').checked; };
  $('#resetBtn').onclick=()=>{ location.reload(); };
  $('#supportBtn').onclick=()=>openModal('supportModal');
  $('#coffeeBtn').onclick=()=>openModal('supportModal');
  $('#contactBtn').onclick=()=>openModal('contactModal');
  $('#startBtn').onclick=startGame;

  renderPlayers(); syncStatus();
}
function syncStatus(){
  const modeTxt = state.mode==='first'?'1등 승리': state.mode==='last'?'마지막 입장 승리': `N번째 승리 (N=${state.nth})`;
  $('#status').textContent = `참가자 ${state.players.length}명 | 모드: ${modeTxt} | 맵: ${state.map==='oval'?'원형 3바퀴':'직선 스프린트'}`;
  $('#readyBar').style.width = `${Math.min(100, state.players.length/20*100)}%`;
}

// ---------- Rendering ----------
const cv=$('#cv'), ctx=cv.getContext('2d');
let W=0,H=0, DPR=1;
function resize(){
  DPR = Math.min(2, devicePixelRatio||1);
  W = cv.clientWidth; H = cv.clientHeight;
  cv.width = W*DPR; cv.height = H*DPR; ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize);

// ---------- Simulation ----------
class Horse{
  constructor(i,name,color,pattern){
    this.i=i; this.name=name; this.color=color; this.pattern=pattern;
    this.reset();
  }
  reset(){
    this.s=0; // scalar progress (straight) or arc length (oval)
    this.theta=0; // angle for oval
    this.lap=0;
    this.finished=false;
    this.finishTime=Infinity;
    // base stats
    this.base = 4.8 + (state.rng.range(-0.15,0.15)); // m/s base
    this.energy = 1.0; // fatigue
    this.spurt=false; this.spurtTime=0;
    this.v=0;
    this.bobT=state.rng.range(0,TAU);
  }
  step(dt, trackLen, leaderS){
    if(this.finished) return;
    // simple model
    const fatigue = (1-this.energy)*1.2;
    const noise = state.rng.range(-0.15,0.15);
    let v = this.base + noise - fatigue;
    // corner penalty (oval)
    if(state.map==='oval'){
      const cornerBias=0.08;
      v -= cornerBias * Math.abs(Math.sin(this.theta*2));
    }
    // final 200m spurt chance
    if(trackLen - this.s < 200 && !this.spurt && state.rng.next()<0.02){
      this.spurt=true; this.spurtTime=1.6;
    }
    if(this.spurt){
      v += 0.9; this.spurtTime-=dt; if(this.spurtTime<=0) this.spurt=false;
    }
    v = Math.max(1.5, v);
    this.v=v;
    this.s += v*dt;
    this.energy = Math.max(0, this.energy - 0.03*dt - 0.015*v*dt/6);

    if(this.s>=trackLen){
      this.finished=true; this.finishTime = now()-startTime;
      this.s=trackLen;
    }
    // for oval convert s->theta, lap counting
    if(state.map==='oval'){
      const perLap = TRACK.ovalLen;
      const total = state.lapTotal*perLap;
      const prog = this.s;
      this.lap = Math.floor(prog / perLap);
      const inLap = prog - this.lap*perLap;
      this.theta = (inLap / perLap) * TAU; // 0 at start line
    }
    this.bobT += dt* (2 + this.v*0.2);
  }
  draw(g){
    const bob = Math.sin(this.bobT)*3;
    g.save();
    g.translate(this.x, this.y + bob);
    // body
    g.fillStyle=this.color;
    roundRect(g, -14,-8,28,16,6); g.fill();
    // saddle
    g.fillStyle='rgba(0,0,0,.25)';
    roundRect(g,-6,-7,12,14,4); g.fill();
    // head
    g.beginPath(); g.arc(16, -2, 6, 0, TAU); g.fillStyle=this.color; g.fill();
    // legs (simple)
    g.strokeStyle='#000'; g.globalAlpha=0.4; g.lineWidth=2;
    g.beginPath(); g.moveTo(-8,8); g.lineTo(-8,14); g.moveTo(4,8); g.lineTo(4,14); g.stroke();
    g.globalAlpha=1;
    // pattern/jockey cap
    g.fillStyle='#fff'; g.font='10px sans-serif'; g.textAlign='center'; g.textBaseline='middle';
    g.fillText(this.pattern,0,0);
    g.restore();
  }
}

const TRACK = {
  ovalR: 180, // radius inner
  ovalW: 90,
  get ovalLen(){ return TAU * (this.ovalR + this.ovalW*0.5); }, // mid-lane
  straightLen: 600, // meters (fictional)
};
let horses=[], results=[], trackLen=0, startTime=0;

function layoutPosition(h){
  if(state.map==='straight'){
    // path along bottom-left to bottom-right
    const margin=80, y=H*0.62;
    const x = lerp(margin, W-margin, h.s/trackLen);
    h.x=x; h.y=y - (h.i*3 % 12); // tiny offset to avoid perfect overlap
  }else{
    // oval centered
    const cx=W*0.55, cy=H*0.6;
    const r = TRACK.ovalR + TRACK.ovalW*0.5 + (h.i%6-3)*3;
    const th = -Math.PI/2 + h.theta; // start at top
    h.x = cx + r*Math.cos(th);
    h.y = cy + r*Math.sin(th);
  }
}

function rankHorses(){
  // order by s descending; tie -> earlier index stable
  const arr = horses.slice().sort((a,b)=> b.s-a.s );
  return arr;
}
function computeLeaders(){
  const leaders = rankHorses();
  const box = $('#leaders'); box.innerHTML='';
  leaders.slice(0,4).forEach((h,i)=>{
    const el=document.createElement('div');
    el.className='card';
    el.innerHTML=`<div class="rank" style="background:${h.color}22;border:1px solid ${h.color}66;color:#fff">${i+1}</div>
    <div style="font-weight:700">${h.name}</div>`;
    box.appendChild(el);
  });
  // ticker
  const tick = $('#ticker'); tick.innerHTML='';
  leaders.slice(4).forEach(h=>{
    const s=document.createElement('span'); s.textContent=h.name; tick.appendChild(s);
  });
  // lap (leader basis)
  if(state.map==='oval'){
    const lead=leaders[0];
    $('#lap').textContent = `Lap ${Math.min(state.lapTotal, (lead?lead.lap+1:1))}/${state.lapTotal}`;
  }else{ $('#lap').textContent = `Sprint`; }
  // progress bar markers
  const bar=$('#trackBar');
  bar.innerHTML='';
  horses.forEach(h=>{
    const m=document.createElement('div'); m.className='marker';
    m.style.left = (h.s/trackLen*100)+'%'; m.style.background=h.color;
    m.textContent = (h.i+1);
    bar.appendChild(m);
  });
}

let last=0;
function loop(t){
  if(!state.running) return;
  requestAnimationFrame(loop);
  if(!last) last=t;
  const dt=Math.min(0.033, (t-last)/1000); last=t;

  // step
  horses.forEach(h=>h.step(dt, trackLen));
  // camera-ish: (here just background parallax)
  drawScene();
  computeLeaders();

  // check finish
  const finishedAll = horses.every(h=>h.finished);
  if(finishedAll && !state.finished){
    state.finished=true;
    finishRace();
  }
}

function drawScene(){
  ctx.clearRect(0,0,W,H);
  // ground
  const grd=ctx.createLinearGradient(0,0,0,H);
  grd.addColorStop(0,'#0a0f15'); grd.addColorStop(1,'#0c121a');
  ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);

  if(state.map==='straight'){
    // rail
    const y=H*0.62;
    ctx.strokeStyle='#e6edf55a'; ctx.lineWidth=8; ctx.beginPath(); ctx.moveTo(60,y+18); ctx.lineTo(W-60,y+18); ctx.stroke();
    ctx.lineWidth=3; ctx.strokeStyle='#a2b7d055'; ctx.beginPath(); ctx.moveTo(60,y+18); ctx.lineTo(W-60,y+18); ctx.stroke();
    // finish
    const fx=W-110;
    drawFinish(fx, y-30, 80, 60);
    // horses
    horses.forEach(h=>{ layoutPosition(h); h.draw(ctx); });
  }else{
    // oval
    const cx=W*0.55, cy=H*0.6, r1=TRACK.ovalR, r2=TRACK.ovalR+TRACK.ovalW;
    // dirt
    ctx.fillStyle='#b88b4a22'; ctx.beginPath();
    ctx.ellipse(cx,cy,r2,r2*0.66,0,0,TAU); ctx.fill();
    ctx.fillStyle='#8d6e3a22'; ctx.beginPath();
    ctx.ellipse(cx,cy,r1,r1*0.66,0,0,TAU); ctx.fill();
    // rails
    ctx.strokeStyle='#e6edf55a'; ctx.lineWidth=8;
    ctx.beginPath(); ctx.ellipse(cx,cy,r1, r1*0.66, 0,0,TAU); ctx.stroke();
    ctx.beginPath(); ctx.ellipse(cx,cy,r2, r2*0.66, 0,0,TAU); ctx.stroke();
    // finish post at top
    const fx=cx, fy=cy - (r1+r2)*0.33 - 10;
    drawFinish(fx-4, fy-30, 8, 60);
    // horses
    horses.forEach(h=>{ layoutPosition(h); h.draw(ctx); });
  }

  // floating name tags
  const hud=$('.hud');
  $$('.floatingTag',hud).forEach(n=>n.remove());
  horses.forEach(h=>{
    const tag=document.createElement('div'); tag.className='floatingTag';
    tag.style.left = (h.x)+'px'; tag.style.top=(h.y-28)+'px'; tag.style.transform='translate(-50%,-50%)';
    tag.style.borderColor = h.color+'66';
    tag.innerHTML = `<span style="color:${h.color};font-weight:800">${h.i+1}</span> ${h.name}`;
    hud.appendChild(tag);
  });
}

function drawFinish(x,y,w,h){
  // post
  ctx.fillStyle='#87a4ff'; ctx.fillRect(x-2, y, 4, h);
  // stripe banner
  const stripes=8; const step=h/stripes;
  for(let i=0;i<stripes;i++){
    ctx.fillStyle = i%2? '#d8e1ff':'#5774ff';
    ctx.fillRect(x+w-40, y+i*step, 40, step-1);
  }
  // text
  ctx.save(); ctx.translate(x+w-10, y+h/2); ctx.rotate(-Math.PI/2);
  ctx.fillStyle='#d8e1ff'; ctx.font='bold 18px sans-serif'; ctx.textAlign='center'; ctx.fillText('Finish',0,0);
  ctx.restore();
}

function setupRace(){
  resize();
  // seed
  const s = ($('#seed').value||'').trim();
  state.rng = new RNG(s || Math.random().toString(36).slice(2));
  // horses
  horses = state.players.map((n,i)=> new Horse(i,n, COLORS[i%COLORS.length], PATTERNS[i%PATTERNS.length]));
  results=[]; state.finished=false;
  // track length
  if(state.map==='straight'){
    trackLen = TRACK.straightLen;
  }else{
    trackLen = TRACK.ovalLen * state.lapTotal;
  }
  // reset
  horses.forEach(h=>h.reset());
  computeLeaders(); drawScene();
}

let startSeqRunning=false;
function startGame(){
  if(state.players.length<2){ alert('최소 2명 이상이 필요합니다.'); return; }
  if(state.mode==='nth' && state.nth>state.players.length){ alert('N이 참가자 수보다 큽니다.'); return; }
  setupRace();
  startSequence();
}

function startSequence(){
  startSeqRunning=true;
  $('#finishBanner').style.display='none';
  $('#toast').style.display='none';
  const lights=['#ff4242','#ffd140','#56ff7a'];
  const texts=['Ready','Steady','Go!'];
  let i=0;
  const step=()=>{
    if(i<3){
      showToast(texts[i]);
      if(state.sound) AudioSys.beep( i===2?1200:800 + i*200, 0.2, i===2?'square':'sine' );
      i++; setTimeout(step, 700);
    }else{
      hideToast();
      if(state.sound){ AudioSys.gun(); AudioSys.crowd(2.5); }
      // run
      state.running=true; startTime=now(); last=0;
      requestAnimationFrame(loop);
    }
  };
  step();
}

function finishRace(){
  state.running=false;
  const ranking = rankHorses();
  // evaluate winner(s)
  let winners=[]; let title='Winner!';
  if(state.mode==='first'){ winners=[ranking[0]]; title='Winner!'; }
  else if(state.mode==='last'){ winners=[ranking[ranking.length-1]]; title='Last Winner!'; }
  else { // nth
    const n = clamp(state.nth,1,ranking.length);
    // handle possible dead heat around nth boundary by ~0.03s
    const baseTime = ranking[n-1].finishTime;
    winners = ranking.filter(h=> Math.abs(h.finishTime - baseTime) < 0.03 );
    title = `${n}등 적중!`;
  }
  // banner
  const fb=$('#finishBanner');
  $('#finishTitle').textContent=title;
  const tms = winners.map(w=>w.finishTime);
  const best = Math.min(...tms);
  $('#finishSub').textContent = `기록 ${formatTime(best)}  •  참가자 ${state.players.length}명`;
  const bl=$('#badgeList'); bl.innerHTML='';
  winners.forEach(w=>{
    const b=document.createElement('div'); b.className='pill';
    b.style.borderColor=w.color; b.style.color='#fff'; b.style.background=w.color+'22';
    b.textContent=`${w.name} (No.${w.i+1})`; bl.appendChild(b);
  });
  fb.style.display='block';
}

function now(){ return performance.now()/1000; }
function showToast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; }
function hideToast(){ $('#toast').style.display='none'; }
function formatTime(sec){
  const m = Math.floor(sec/60); const s = sec-m*60; return `${m}:${s.toFixed(2).padStart(5,'0')}`;
}
function openModal(id){ $('#'+id).style.display='flex'; }
function closeModal(id){ $('#'+id).style.display='none'; }
function copyEmail(){
  navigator.clipboard.writeText('luckyhorserace@gmail.com');
  alert('이메일 주소가 복사되었습니다.');
}

// drawing util
function roundRect(g,x,y,w,h,r){
  g.beginPath();
  g.moveTo(x+r,y);
  g.arcTo(x+w,y,x+w,y+h,r);
  g.arcTo(x+w,y+h,x,y+h,r);
  g.arcTo(x,y+h,x,y,r);
  g.arcTo(x,y,x+w,y,r);
  g.closePath();
}

// boot
initUI(); resize(); setupRace();

</script>
</body>
</html>
"""

# write file
os.makedirs('/mnt/data/lucky-horse-race', exist_ok=True)
with open('/mnt/data/lucky-horse-race/index.html','w', encoding='utf-8') as f:
    f.write(html)

# zip it for download convenience
zip_path = '/mnt/data/lucky-horse-race.zip'
with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as z:
    z.write('/mnt/data/lucky-horse-race/index.html', arcname='index.html')

zip_path, '/mnt/data/lucky-horse-race/index.html'
