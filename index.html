<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lucky Horse Race â€” ì§ì„ Â·íƒ€ì›Â·ìƒŒë“œì í”„Â·ìŠ¤í”¼ë‹ë”ë¹„</title>

<!-- SEO ê¸°ë³¸ -->
<link rel="canonical" href="https://luckyhorserace.github.io/">
<meta name="robots" content="index,follow"/>
<meta name="description" content="ë§Â·ê¸°ìˆ˜ ëœë¤ ì¶”ì²¨ ê²Œì„! ì§ì„  ë‹¬ë¦¬ê¸°(ìµœëŒ€ 1km), íƒ€ì› ë©, ìƒŒë“œ ì í”„ í”¼íŠ¸, ìŠ¤í”¼ë‹ ë”ë¹„. ìš°ìŠ¹ ì˜¤ë²„ë ˆì´ì™€ ë¦¬í”Œë ˆì´ ë‹¤ìš´ë¡œë“œ ì§€ì›."/>
<meta name="keywords" content="ê²½ë§ˆê²Œì„, ëœë¤ê²Œì„, ì˜¨ë¼ì¸ ì¶”ì²¨, ì‚¬ë‹¤ë¦¬ê²Œì„, ë£°ë › ëŒ€ì²´, ë‚´ê¸°ê²Œì„, íŒŒí‹°ê²Œì„"/>

<!-- OpenGraph / Twitter -->
<meta property="og:type" content="website"/>
<meta property="og:title" content="Lucky Horse Race â€” ëœë¤ ê²½ë§ˆê²Œì„"/>
<meta property="og:description" content="ì§ì„ Â·íƒ€ì›Â·ìƒŒë“œ ì í”„Â·ìŠ¤í”¼ë‹ ë”ë¹„! ìš°ìŠ¹ì ë°œí‘œì™€ ë¦¬í”Œë ˆì´ ë‹¤ìš´ë¡œë“œ ì§€ì›."/>
<meta property="og:image" content="https://example.com/preview.png"/> <!-- ì—¬ê¸° ë„ˆ ìŠ¤ìƒ· ì£¼ì†Œë¡œ êµì²´ -->
<meta property="og:url" content="https://luckyhorserace.github.io/"/>
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="Lucky Horse Race â€” ëœë¤ ê²½ë§ˆê²Œì„"/>
<meta name="twitter:description" content="ì§ì„ Â·íƒ€ì›Â·ìƒŒë“œ ì í”„Â·ìŠ¤í”¼ë‹ ë”ë¹„, ìš°ìŠ¹ì ë°œí‘œì™€ ë¦¬í”Œë ˆì´ ë‹¤ìš´ë¡œë“œ ì§€ì›!"/>
<meta name="twitter:image" content="https://example.com/preview.png"/>

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">

<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
  --accent:#6ee7ff; --accent2:#fcd34d; --ok:#22c55e; --danger:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{color:var(--ink);background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Malgun Gothic",sans-serif}

.wrap{position:relative;width:100vw;height:100vh;overflow:hidden}
.stage{position:absolute; inset:0;}
.viewport{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);transform-origin:50% 50%;transition:transform .12s ease-out}
.canvas{position:relative;width:min(98vw,1800px);height:auto;margin:0 auto}

/* Maps */
svg{display:block}
.ovalSvg,.straightSvg,.arenaSvg{width:100%;height:auto}

/* Horses */
.horse{position:absolute;width:46px;height:34px;transform:translate(-50%,-50%);pointer-events:none; z-index:8}
.horse.jump{z-index:12}
.nameplate{position:absolute;bottom:100%;left:50%;transform:translate(-50%,-8px);background:#09111e;color:#dbe7f3;border:1px solid #2a3b57;border-radius:10px;font-size:11px;font-weight:800;padding:3px 8px;white-space:nowrap}
.horse-svg{width:46px;height:34px}
.horse-svg .body{fill:#e5e7eb}
.horse-svg .mane{fill:#cbd5e1}
.horse-svg .jockey{fill:var(--jersey,#60a5fa)}
.horse-svg .saddle{fill:#94a3b8}
.horse-svg .eye{fill:#0f172a}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-1.2px)}}
.horse-svg .g-bob{animation:bob .26s infinite ease-in-out}
@keyframes leg-run-front { 0%,100% { transform: rotate(18deg); } 50% { transform: rotate(-18deg); } }
@keyframes leg-run-back  { 0%,100% { transform: rotate(-18deg); } 50% { transform: rotate(18deg); } }
.front-leg{transform-origin: top center;animation: leg-run-front .42s infinite linear}
.back-leg {transform-origin: top center;animation: leg-run-back  .42s infinite linear}

/* Header/Controls */
header{position:absolute;inset:auto 0 0 0;padding:10px 12px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;background:rgba(0,0,0,.5);z-index:30;flex-wrap:wrap}
.group{display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:rgba(255,255,255,.04);border:1px solid #2a3b57;border-radius:12px;padding:8px}
.group h4{margin:0 6px 0 0;font-size:12px;color:#93c5fd;opacity:.9}
button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800;letter-spacing:.2px}
.btn-accent{background:linear-gradient(180deg,#1b9ab7,#168aa4);color:#06131b;border:1px solid #0a6c82}
.btn-ghost{background:rgba(0,0,0,.35);border:1px solid #2a3a57;color:#cbd5e1}
.btn-accent:hover,.btn-ghost:hover{filter:brightness(1.06)}
input[type="text"],select,input[type="number"]{padding:10px;border:1px solid #223047;border-radius:10px;background:rgba(0,0,0,.35);color:#dbe7f3}
#names{min-width:260px}

/* Ranking: 10ëª… ë‹¨ìœ„ ì—´, ì˜¤ë¥¸ìª½ì— ìƒˆ ì—´ì´ ë¶™ê³  ê¸°ì¡´ ì—´ì´ ì™¼ìª½ìœ¼ë¡œ ë°€ë¦¼ */
.rankWrap{position:absolute;top:12px;right:12px;z-index:25;display:flex;gap:8px;align-items:flex-start;flex-direction:row-reverse}
.ranking{width:260px;background:rgba(8,18,34,.78);border:1px solid #2a3b54;border-radius:10px;padding:8px;font-size:13px}
.ranking h3{margin:2px 0 6px;font-size:13px;color:#93c5fd}
.ranking .row{display:flex;justify-content:space-between;padding:2px 6px;border-radius:6px}
.ranking .row:nth-child(odd){background:rgba(255,255,255,.03)}
.ranking .pos{font-weight:900;color:#6ee7ff}
.color-badge{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle;border:1px solid #1f2937}

/* HUD (í° ì¹´ìš´íŠ¸ë‹¤ìš´) */
.hud{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:20}
.hud.show{display:flex}
.traffic{display:flex;gap:14px;align-items:center;background:#0b1220cc;border:1px solid #334155;padding:14px 18px;border-radius:14px}
.light{width:22px;height:22px;border-radius:50%;background:#111827;border:1px solid #334155}
.light.on.red{background:#ef4444}.light.on.yellow{background:#f59e0b}.light.on.green{background:#22c55e}
.countTxt{margin-left:6px;font-weight:900;font-size:clamp(24px,5vw,36px)}
.gun{margin-left:8px;font-size:clamp(16px,3.2vw,20px);color:#93c5fd}

/* ìš°ìŠ¹ ì˜¤ë²„ë ˆì´ */
#celebrate{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.55);z-index:10000;text-align:center}
#winnerVisual{font-size:96px;display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:8px}
#celeTitle{font-size:72px;color:#fff;margin:0 0 8px;letter-spacing:.2em;animation:jelly 1.6s ease both; text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 22px rgba(110,231,255,.25)}
#celeSubtitle{font-size:28px;color:#e6f9ff;margin:0 18px 18px;text-shadow:0 1px 6px rgba(0,0,0,.35)}
@keyframes jelly{0%{transform:scale(0.8)}40%{transform:scale(1.12)}60%{transform:scale(0.98)}100%{transform:scale(1)}}
.winnerCard{display:flex;gap:20px;align-items:center;justify-content:center;margin:8px 0 18px}
.winnerHorse{width:160px;height:120px;transform:scale(1.2)}
.winnerName{font-size:28px;font-weight:900}

/* Sand pit labels */
.pitLabel{position:absolute;top:0;left:0;right:0;text-align:center;color:#e5e7eb;font-size:12px}

/* ëª¨ë°”ì¼ ë³´ì • */
@media (max-width:640px){.ranking{width:220px}#names{min-width:180px}}
</style>
</head>
<body>
<div class="wrap">

  <!-- HUD -->
  <div class="hud" id="hud">
    <div class="traffic">
      <div class="light" id="ltR"></div>
      <div class="light" id="ltY"></div>
      <div class="light" id="ltG"></div>
      <span class="countTxt" id="countTxt">Ready</span>
      <span class="gun" id="gunTxt"></span>
    </div>
  </div>

  <!-- Stage -->
  <div class="stage" id="stage">
    <div class="viewport" id="viewport">
      <div class="canvas" id="canvas">
        <!-- íƒ€ì› -->
        <svg id="ovalMap" class="ovalSvg" viewBox="0 0 1000 600" style="display:none"></svg>
        <!-- ì§ì„  -->
        <svg id="straightMap" class="straightSvg" viewBox="0 0 2000 400" style="display:none"></svg>
        <!-- ìƒŒë“œ ì í”„ -->
        <svg id="sandMap" class="straightSvg" viewBox="0 0 2000 500" style="display:none"></svg>
        <!-- ì•„ë ˆë‚˜(ìŠ¤í”¼ë‹ ë”ë¹„) -->
        <svg id="arenaMap" class="arenaSvg" viewBox="0 0 800 800" style="display:none"></svg>
      </div>
    </div>

    <!-- ìˆœìœ„íŒ (ì—´ ë¶„í•  ì»¨í…Œì´ë„ˆ) -->
    <div class="rankWrap" id="rankWrap"></div>
  </div>

  <!-- í•˜ë‹¨ UI -->
  <header>
    <!-- ê²½ê¸° ì œì–´ -->
    <div class="group" id="controlGroup">
      <h4>ê²½ê¸° ì œì–´</h4>
      <input id="names" type="text" placeholder="ì°¸ê°€ì ì…ë ¥ (ì˜ˆ: ê³ êµ¬ë§ˆ ê°ì ê¹€ì¹˜ / ê³ êµ¬ë§ˆ*3)">
      <select id="mapSelect" title="ë§µ ì„ íƒ">
        <option value="straight">ì§ì„ </option>
        <option value="oval">íƒ€ì›</option>
        <option value="sand">ìƒŒë“œ ì í”„</option>
        <option value="arena">ìŠ¤í”¼ë‹ ë”ë¹„</option>
      </select>

      <!-- ë§µë³„ ì˜µì…˜ -->
      <select id="raceDist" title="ê±°ë¦¬(ì§ì„  ì „ìš©)">
        <option value="100">100m</option>
        <option value="200">200m</option>
        <option value="300">300m</option>
        <option value="1000">1000m</option>
      </select>
      <select id="raceLen" title="ë© ìˆ˜(íƒ€ì› ì „ìš©)" style="display:none">
        <option value="1">1ë°”í€´</option>
        <option value="3" selected>3ë°”í€´</option>
        <option value="5">5ë°”í€´</option>
        <option value="10">10ë°”í€´</option>
      </select>
      <select id="sandPit" title="ëª¨ë˜ í”¼íŠ¸ ê¸¸ì´(ìƒŒë“œ ì í”„ ì „ìš©)" style="display:none">
        <option value="30">30m í”¼íŠ¸</option>
        <option value="50" selected>50m í”¼íŠ¸</option>
        <option value="80">80m í”¼íŠ¸</option>
      </select>

      <button class="btn-accent" id="startBtn">ì‹œì‘ â–¶</button>
      <button class="btn-ghost" id="resetBtn">ë¦¬ì…‹</button>
      <button class="btn-ghost" id="leaderViewBtn">ë¦¬ë”ë·°: ON</button>
      <button class="btn-ghost" id="fullscreenBtn">ì „ì²´í™”ë©´</button>
    </div>

    <!-- ì¶”ì²¨ ê·œì¹™ (ì¹´ë©”ë¼ì™€ ë¶„ë¦¬) -->
    <div class="group" id="drawGroup">
      <h4>ì¶”ì²¨ ê·œì¹™</h4>
      <label class="seg-item on" data-type="first"><input type="radio" name="draw" value="first" checked> 1ë“±</label>
      <label class="seg-item" data-type="last"><input type="radio" name="draw" value="last"> ë§ˆì§€ë§‰</label>
      <label class="seg-item" data-type="nth"><input type="radio" name="draw" value="nth"> në“±</label>
      <input id="drawNthInput" type="number" min="1" step="1" placeholder="në“±" disabled>
    </div>
  </header>
</div>

<!-- ìš°ìŠ¹ ì˜¤ë²„ë ˆì´ -->
<div id="celebrate">
  <div id="winnerVisual">ğŸ‘‘ ğŸ¥• âœ¨</div>
  <div id="celeTitle">W i n n e r r r r r ~</div>
  <div id="celeSubtitle">ì´ ë§›ì— ë‹¬ë¦°ë‹¤~</div>
  <div class="winnerCard" id="winnerCard"></div>
  <div style="display:flex; gap:8px">
    <button class="btn-accent" id="replaySaveBtn">ë¦¬í”Œë ˆì´ ë‹¤ìš´ë¡œë“œ</button>
    <button class="btn-ghost" onclick="document.getElementById('celebrate').style.display='none'">ë‹«ê¸°</button>
  </div>
</div>

<script>
/* ====== Utils ====== */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
let _rand=Math.random;
function reseed(seed){_rand=mulberry32(seed|0)}
function autoSeed(){return(Date.now()^Math.floor(Math.random()*0xFFFFFFFF))>>>0}
const JERSEYS=['#60a5fa','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6','#eab308','#fb7185','#34d399','#f97316','#a3e635','#e879f9','#f43f5e','#6ee7ff'];
function jc(i){return JERSEYS[i%JERSEYS.length]}
function splitNames(raw){
  return raw.split(/[/\s]+/).map(s=>s.trim()).filter(Boolean)
    .flatMap(s=>{const m=s.match(/(.+)\*(\d+)/);return m?Array.from({length:Math.min(50,parseInt(m[2]))},()=>m[1]):s})
    .slice(0,50).map((n,i)=>({name:n,no:i+1}));
}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function download(filename, text){
  const a=document.createElement('a');
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text);
  a.download=filename; a.click();
}

/* ====== DOM ====== */
const $names=document.getElementById('names'),
      $mapSel=document.getElementById('mapSelect'),
      $raceLen=document.getElementById('raceLen'),
      $raceDist=document.getElementById('raceDist'),
      $sandPit=document.getElementById('sandPit'),
      $start=document.getElementById('startBtn'),
      $reset=document.getElementById('resetBtn'),
      $leaderBtn=document.getElementById('leaderViewBtn'),
      $fullscreenBtn=document.getElementById('fullscreenBtn'),
      $rankWrap=document.getElementById('rankWrap'),
      $viewport=document.getElementById('viewport'),
      $canvas=document.getElementById('canvas'),
      $ovalMap=document.getElementById('ovalMap'),
      $straightMap=document.getElementById('straightMap'),
      $sandMap=document.getElementById('sandMap'),
      $arenaMap=document.getElementById('arenaMap'),
      $cele=document.getElementById('celebrate'),
      $winnerCard=document.getElementById('winnerCard'),
      $replaySaveBtn=document.getElementById('replaySaveBtn');

/* ====== State ====== */
const MIN=2,MAX=50;
let H=[],running=false,raf=null;
let laps=3, dist=100, pitLen=50;
let mapMode="straight"; // straight | oval | sand | arena
let pendingDraw={type:'first'};
let finishOrder = [];
let entryDone = new Map();
let drawFired = false;
let leaderView=true;
let camPanX=0;
let seed=autoSeed();

/* ====== Replay ====== */
let replay={meta:{}, events:[]};
function logEv(t, type, data){ replay.events.push({t, type, data}); }
function resetFinishOrder(){ finishOrder=[]; entryDone.clear(); drawFired=false; }

/* ====== Straight map sizing ====== */
let straightViewW = 2000, straightViewH = 400;
function dynamicTrackHeight(){
  const n=Math.max(2, H.length||splitNames($names.value).length||2);
  // ë” ê³µê²©ì ìœ¼ë¡œ í™•ì¥
  return Math.min(260, 80 + n*10);
}

/* ====== SVG drawing ====== */
function drawStraight(){
  straightViewW = 20*dist;
  straightViewH = 400;
  const dynH = dynamicTrackHeight();
  const dynY = Math.round((straightViewH - dynH)/2);
  const startX=80, finishX=straightViewW-80;

  $straightMap.setAttribute('viewBox',`0 0 ${straightViewW} ${straightViewH}`);
  $straightMap.innerHTML = `
    <rect x="0" y="${dynY}" width="${straightViewW}" height="${dynH}" fill="#0e1a2a" stroke="#2a3b54" stroke-width="2"/>
    <line x1="${startX}" y1="${dynY-12}" x2="${startX}" y2="${dynY+dynH+12}" stroke="#22d3ee" stroke-width="6"/>
    <text x="${startX}" y="${dynY-20}" text-anchor="middle" font-size="14" fill="#a5f3fc" font-weight="800">ì¶œë°œ</text>
    <line x1="${finishX}" y1="${dynY-16}" x2="${finishX}" y2="${dynY+dynH+16}" stroke="#ffffff" stroke-width="8"/>
    <text x="${finishX}" y="${dynY-20}" text-anchor="middle" font-size="14" fill="#e5e7eb" font-weight="900">ë„ì°©</text>
  `;
}
function drawOval(){
  const rx=420, ryBase=220;
  $ovalMap.innerHTML = `
    <ellipse cx="500" cy="300" rx="${rx}" ry="${ryBase}" fill="#0e1a2a" stroke="#2a3b54" stroke-width="2"/>
    <ellipse cx="500" cy="300" rx="${rx-60}" ry="${ryBase-60}" fill="#0b1220" stroke="#1f2937" stroke-width="2"/>
    <ellipse cx="500" cy="300" rx="${rx-30}" ry="${ryBase-30}" fill="none" stroke="#5b708f" stroke-dasharray="6,6" stroke-width="2"/>
    <text x="500" y="70" text-anchor="middle" font-size="14" fill="#a5f3fc" font-weight="800">ì¶œë°œ/í”¼ë‹ˆì‹œ</text>
  `;
}
function drawSand(){
  const W=20*dist, H=500;
  $sandMap.setAttribute('viewBox',`0 0 ${W} ${H}`);
  const top=120, bot=380, mid=(top+bot)/2;
  const takeoffX = Math.round(W*0.4);
  const pitStartX = takeoffX + 0;
  const pitEndX   = Math.min(W-80, pitStartX + pitLen*20);

  // íŠ¸ë™(ë„ì•½ì„  ì´ì „), ëª¨ë˜ í”¼íŠ¸(ì´í›„)
  $sandMap.innerHTML = `
    <rect x="0" y="${mid}" width="${pitStartX-0}" height="${bot-mid+60}" fill="#0e1a2a" stroke="#2a3b54" stroke-width="2"/>
    <rect x="${pitStartX}" y="${mid}" width="${Math.max(1,pitEndX-pitStartX)}" height="${bot-mid+60}" fill="#5a4125" stroke="#3a2b18" stroke-width="2"/>
    <line x1="${80}" y1="${mid-10}" x2="${80}" y2="${bot+60}" stroke="#22d3ee" stroke-width="6"/>
    <text x="80" y="${mid-16}" text-anchor="middle" font-size="14" fill="#a5f3fc" font-weight="800">ì¶œë°œ</text>
    <line x1="${takeoffX}" y1="${mid-10}" x2="${takeoffX}" y2="${bot+60}" stroke="#fcd34d" stroke-width="6"/>
    <text x="${takeoffX}" y="${mid-16}" text-anchor="middle" font-size="14" fill="#fde68a" font-weight="900">ë„ì•½ì„ </text>
  `;
}
function drawArena(){
  const W=800,H=800, cx=W/2, cy=H/2, r=320;
  $arenaMap.innerHTML = `
    <defs>
      <radialGradient id="g" cx="50%" cy="50%"><stop offset="0%" stop-color="#0b1628"/><stop offset="100%" stop-color="#09111e"/></radialGradient>
    </defs>
    <rect x="0" y="0" width="${W}" height="${H}" fill="url(#g)" stroke="#2a3b54"/>
    <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#2a3b54" stroke-width="3"/>
    <circle cx="${cx}" cy="${cy}" r="${r-60}" fill="none" stroke="#1e2a45" stroke-dasharray="8,8" stroke-width="2"/>
  `;
}

/* ====== Horses ====== */
function horseSVG(color){return `<svg class="horse-svg" viewBox="0 0 64 44" xmlns="http://www.w3.org/2000/svg" style="--jersey:${color}">
  <g class="g-bob">
    <path class="mane" d="M10 26c2-3 3-5 6-6 0 4-2 7-4 9l-4-1 2-2z"/>
    <path class="body" d="M8 28c7-9 12-11 20-11h9c7 0 14 4 19 9l3 5-4 2-6-4-7 2H28l-8 1-6 3-6-1 6-6z"/>
    <rect class="saddle" x="28" y="17" width="11" height="7" rx="2"/>
    <g class="jockey"><circle cx="31" cy="12" r="3.6"/><rect x="28" y="15.5" width="10" height="7" rx="2"/></g>
    <circle class="eye" cx="22.5" cy="20.5" r="0.9"/>
    <rect class="front-leg" x="21" y="26" width="3.5" height="13" fill="#e5e7eb"/>
    <rect class="back-leg"  x="36" y="26" width="3.5" height="13" fill="#e5e7eb"/>
  </g>
</svg>`}
function winnerHorseSVG(color){return `<svg class="winnerHorse" viewBox="0 0 64 44" xmlns="http://www.w3.org/2000/svg" style="--jersey:${color}">
  <g>
    <!-- íŠ¸ë¡œí”¼ í¬ì¦ˆ(ë§ ë’·ë°œë¡œ ì„œê¸° + ë§ ì˜¤ë¥¸ì•ë°œ íŠ¸ë¡œí”¼ / ê¸°ìˆ˜ ì™¼ì† íŠ¸ë¡œí”¼) -->
    <path fill="#cbd5e1" d="M10 26c2-3 3-5 6-6 0 4-2 7-4 9l-4-1 2-2z"/>
    <path fill="#e5e7eb" d="M8 28c7-9 12-11 20-11h9c7 0 14 4 19 9l3 5-4 2-6-4-7 2H28l-8 1-6 3-6-1 6-6z"/>
    <rect fill="#94a3b8" x="28" y="17" width="11" height="7" rx="2"/>
    <g class="jockey"><circle cx="31" cy="10.8" r="3.6" fill="${color}"/><rect x="28" y="14.8" width="10" height="7" rx="2" fill="${color}"/></g>
    <circle cx="22.5" cy="20.5" r="0.9" fill="#0f172a"/>
    <!-- ì•ë‹¤ë¦¬ í¬ì¦ˆ -->
    <rect x="36" y="18" width="3.5" height="13" fill="#e5e7eb" transform="rotate(-25 37.75 24.5)"/>
    <rect x="21" y="22" width="3.5" height="13" fill="#e5e7eb" transform="rotate(15 22.75 28.5)"/>
    <!-- íŠ¸ë¡œí”¼ ë‘ ê°œ -->
    <g transform="translate(44,10)">
      <path d="M0 4h10v6a5 5 0 0 1-10 0z" fill="#facc15" stroke="#a16207"/>
      <rect x="3" y="10" width="4" height="5" rx="1" fill="#d97706"/>
      <rect x="2" y="14" width="6" height="3" rx="1" fill="#92400e"/>
    </g>
    <g transform="translate(18,8)">
      <path d="M0 4h10v6a5 5 0 0 1-10 0z" fill="#facc15" stroke="#a16207"/>
      <rect x="3" y="10" width="4" height="5" rx="1" fill="#d97706"/>
      <rect x="2" y="14" width="6" height="3" rx="1" fill="#92400e"/>
    </g>
  </g>
</svg>`}

/* ====== Helpers ====== */
function clearHorses(){ $canvas.querySelectorAll('.horse').forEach(n=>n.remove()); H.length=0; }
function placeHorseStraight(h){
  const vb = $straightMap.getAttribute('viewBox').split(' ').map(Number);
  const W=vb[2], Hvb=vb[3];
  const rect=$straightMap.getBoundingClientRect();
  const scaleX=rect.width/W, scaleY=rect.height/Hvb;

  const dynH = dynamicTrackHeight();
  const dynY = Math.round((Hvb - dynH)/2);
  const startX=80, finishX=W-80;

  const progress = clamp(h.x/dist, 0, 1);
  const sx = startX + (finishX-startX)*progress;

  const lanes = H.length;
  const laneGap = Math.min(28, dynH/Math.max(1,lanes));
  const cy = dynY + dynH/2 + (h.laneIdx-(lanes-1)/2) * laneGap;

  let x=sx*scaleX, y=cy*scaleY;

  if(h.jumping){
    const p = Math.min(1, h.jumpT / h.jumpDur);
    const arc = Math.sin(Math.PI * p);
    y -= 26 * arc;
  }
  h.$el.style.left = x+'px'; h.$el.style.top = y+'px';
  h.$el.style.transform=`translate(-50%,-50%)`;

  const dur = Math.max(0.18, 0.6 - (h.speed*0.12));
  if(Math.abs(dur - (h.legsDur||0.42)) > 0.01){
    h.legsDur = dur;
    h.$el.querySelectorAll('.front-leg,.back-leg').forEach(e=>e.style.animationDuration = dur+'s');
  }
}
function placeHorseSand(h){
  const vb = $sandMap.getAttribute('viewBox').split(' ').map(Number);
  const W=vb[2], Hvb=vb[3];
  const rect=$sandMap.getBoundingClientRect();
  const scaleX=rect.width/W, scaleY=rect.height/Hvb;

  const top=120, bot=380, mid=(top+bot)/2;
  const takeoffX = Math.round(W*0.4);
  const startX=80;

  const progress = clamp(h.x/dist, 0, 1);
  const sx = startX + (W-160)*progress;

  const lanes = H.length;
  const laneGap = Math.min(28, 140/Math.max(1,lanes));
  const baseY = 250 + (h.laneIdx-(lanes-1)/2) * laneGap;

  let x=sx*scaleX, y=baseY*scaleY;
  // ì í”„ì¼ ë•Œ í¬ë¬¼ì„ 
  if(h.air){
    const p = clamp((h.airT/h.airDur),0,1);
    const arc = Math.sin(Math.PI*p);
    y -= 26*arc;
  }
  h.$el.style.left = x+'px'; h.$el.style.top = y+'px';
  h.$el.style.transform=`translate(-50%,-50%)`;

  const dur = Math.max(0.18, 0.6 - (h.speed*0.12));
  if(Math.abs(dur - (h.legsDur||0.42)) > 0.01){
    h.legsDur = dur;
    h.$el.querySelectorAll('.front-leg,.back-leg').forEach(e=>e.style.animationDuration = dur+'s');
  }
}
function placeHorseOval(h){
  const rect=$ovalMap.getBoundingClientRect();
  const rx=420, ry=220, cx=500, cy=300;

  const angle = -Math.PI/2 + (h.lapProg%1) * Math.PI*2 + h.thetaOffset;
  const nx = Math.cos(angle)/Math.hypot(Math.cos(angle)/rx, Math.sin(angle)/ry);
  const ny = Math.sin(angle)/Math.hypot(Math.cos(angle)/rx, Math.sin(angle)/ry);
  const laneOffset = (h.laneIdx - (H.length-1)/2) * 12;

  const px = cx + (rx * Math.cos(angle)) + nx*laneOffset;
  const py = cy + (ry * Math.sin(angle)) + ny*laneOffset;

  const scaleX=rect.width/1000, scaleY=rect.height/600;
  const x = px*scaleX, y = py*scaleY;

  h.$el.style.left = x+'px'; h.$el.style.top = y+'px';
  h.$el.style.transform=`translate(-50%,-50%)`;

  const dur = Math.max(0.18, 0.6 - (h.speed*0.12));
  if(Math.abs(dur - (h.legsDur||0.42)) > 0.01){
    h.legsDur = dur;
    h.$el.querySelectorAll('.front-leg,.back-leg').forEach(e=>e.style.animationDuration = dur+'s');
  }
}
function placeHorseArena(h){
  const vb=$arenaMap.getAttribute('viewBox').split(' ').map(Number);
  const W=vb[2], H=vb[3], cx=W/2, cy=H/2;
  const rect=$arenaMap.getBoundingClientRect();
  const scaleX=rect.width/W, scaleY=rect.height/H;

  // ìœ„ì¹˜ ì—…ë°ì´íŠ¸ëŠ” run()ì—ì„œ, ì—¬ê¸°ì„œëŠ” ë Œë”ë§Œ
  const x = h.ax*scaleX, y=h.ay*scaleY;
  h.$el.style.left=x+'px'; h.$el.style.top=y+'px';
  h.$el.style.transform=`translate(-50%,-50%) rotate(${h.rot||0}deg)`;
}

/* ====== Build horses ====== */
function clearCanvas(){ $canvas.querySelectorAll('.horse').forEach(n=>n.remove()); H.length=0; }
function buildHorses(list){
  clearCanvas();
  list.forEach((ent,i)=>{
    const color = jc(i);
    const el=document.createElement('div');
    el.className='horse';
    el.innerHTML=horseSVG(color);
    const plate=document.createElement('div');
    plate.className='nameplate';
    plate.textContent=`${ent.no}ë²ˆ ${ent.name}`;
    plate.style.borderColor = color;
    plate.style.boxShadow = `0 0 0 1px rgba(0,0,0,.25), 0 0 8px 0 ${color}33`;
    el.appendChild(plate);
    $canvas.appendChild(el);

    if(mapMode==='straight'){
      const base   = 2.8 + _rand()*(6.2-2.8);
      H.push({
        entryId:i, laneIdx:i, name:ent.name,no:ent.no,color,$el:el,
        x:0, base, speed: base*(0.85+_rand()*0.3), fatigue:0, legsDur:.42,
        jumping:false,jumpT:0,jumpDur:0.55, done:false,_finished:false
      });
    }else if(mapMode==='sand'){
      const base   = 2.8 + _rand()*(6.2-2.8);
      // ì í”„ ê±°ë¦¬ëŠ” ëŸ¬ë‹ê³¼ ë…ë¦½ ëœë¤
      const jumpPow = 0.6 + _rand()*1.4; // 0.6~2.0 (ìƒëŒ€ì¹˜)
      H.push({
        entryId:i, laneIdx:i, name:ent.name,no:ent.no,color,$el:el,
        x:0, base, speed: base*(0.85+_rand()*0.3), fatigue:0, legsDur:.42,
        air:false, airT:0, airDur:(0.5+_rand()*0.5), jumpPow, landed:false, landX:0,
        done:false,_finished:false
      });
    }else if(mapMode==='oval'){
      const base   = 0.02 + (_rand()-0.5)*0.004;
      H.push({
        entryId:i, laneIdx:i, name:ent.name,no:ent.no,color,$el:el,
        lapProg:0, speed: 4.3 + _rand()*1.6, thetaOffset:(i-(list.length-1)/2)*0.06,
        done:false,_finished:false
      });
    }else if(mapMode==='arena'){
      const vb=$arenaMap.getAttribute('viewBox').split(' ').map(Number);
      const W=vb[2], Hvb=vb[3], cx=W/2, cy=Hvb/2;
      const r=40;
      const ax=cx + (_rand()-0.5)*r, ay=cy + (_rand()-0.5)*r;
      H.push({
        entryId:i, laneIdx:i, name:ent.name,no:ent.no,color,$el:el,
        ax, ay, vx:(_rand()-0.5)*2.4, vy:(_rand()-0.5)*2.4, rot:_rand()*360,
        done:false,_finished:false
      });
    }
  });

  updateRanking();
  H.forEach(placeEntity);
}

/* ====== Placement multiplexer ====== */
function placeEntity(h){
  if(mapMode==='straight') return placeHorseStraight(h);
  if(mapMode==='sand') return placeHorseSand(h);
  if(mapMode==='oval') return placeHorseOval(h);
  if(mapMode==='arena') return placeHorseArena(h);
}

/* ====== Ranking (ì—´ ë¶„í• ) ====== */
function toEntryOrder(){
  if(mapMode==='oval'){
    const best = new Map();
    H.forEach(h=>{
      const p = Math.min(h.lapProg, laps);
      if(!best.has(h.entryId) || best.get(h.entryId)._p < p) best.set(h.entryId, {...h, _p:p});
    });
    return [...best.values()].sort((a,b)=> b._p - a._p);
  }else if(mapMode==='sand'){
    // ìƒŒë“œ: ì°©ì§€í•œ ë§ì€ landX(ì°©ì§€ê±°ë¦¬) ê¸°ì¤€, ì•„ì§ì´ë©´ ì§„í–‰ x
    const landed = H.filter(h=>h.landed).slice().sort((a,b)=> b.landX - a.landX);
    const rest   = H.filter(h=>!h.landed).slice().sort((a,b)=> b.x - a.x);
    return landed.concat(rest);
  }else if(mapMode==='arena'){
    // ì•„ë ˆë‚˜: íƒˆë½ ìˆœìœ¼ë¡œ finishOrderì— ìŒ“ì„. ë‚¨ì€ ì• ë“¤ íšŒì¥ ì•ˆìª½ ê±°ë¦¬ ê¸°ì¤€
    const finished = finishOrder.slice();
    const rest = H.filter(h=>!h.done).slice().sort((a,b)=>{
      const vb=$arenaMap.getAttribute('viewBox').split(' ').map(Number);
      const W=vb[2],Hvb=vb[3],cx=W/2,cy=Hvb/2;
      const da=Math.hypot(a.ax-cx,a.ay-cy), db=Math.hypot(b.ax-cx,b.ay-cy);
      return da-db;
    });
    return finished.concat(rest);
  }else{
    const finished = finishOrder.slice();
    const rest = H.filter(h=>!h.done).slice().sort((a,b)=> Math.min(b.x,dist) - Math.min(a.x,dist));
    return finished.concat(rest);
  }
}
function renderRankColumns(list){
  $rankWrap.innerHTML='';
  const cols = Math.ceil(list.length/10)||1;
  for(let c=0;c<cols;c++){
    const box=document.createElement('div');
    box.className='ranking';
    box.innerHTML=`<h3>í˜„ì¬ ìˆœìœ„</h3><div class="lines"></div>`;
    const lines=box.querySelector('.lines');
    const slice=list.slice(c*10,(c+1)*10);
    lines.innerHTML=slice.map((h,i)=>{
      const pos=c*10+i+1;
      let status='';
      if(mapMode==='oval') status = h.done?'ì™„ì£¼':`${(h.lapProg).toFixed(2)}ë©`;
      else if(mapMode==='sand') status = h.landed?`${(h.landX).toFixed(1)}m`:`${Math.floor(h.x)}m`;
      else if(mapMode==='arena') status = h.done?'íƒˆë½':'ìƒì¡´';
      else status = h.done?'ì™„ì£¼':`${Math.floor(h.x)}m`;
      return `<div class="row"><span class="pos">${pos}ìœ„</span>
      <span><span class="color-badge" style="background:${h.color}"></span>${h.no}ë²ˆ ${h.name} - ${status}</span></div>`;
    }).join('');
    $rankWrap.appendChild(box);
  }
}
function updateRanking(){ renderRankColumns(toEntryOrder()); }

/* ====== Camera (ë¦¬ë”ë·°) ====== */
function updateCamera(){
  if(!leaderView){
    $viewport.style.transform = `translate(-50%,-50%) scale(1)`;
    return;
  }
  // ë¦¬ë”(í˜„ì¬ ì„ ë‘)
  const order = toEntryOrder();
  const lead = order[0];
  if(!lead){ $viewport.style.transform = `translate(-50%,-50%) scale(1)`; return; }

  const activeView = (mapMode==='straight')?$straightMap:(mapMode==='sand')?$sandMap:(mapMode==='oval')?$ovalMap:$arenaMap;
  const rect = activeView.getBoundingClientRect();
  const scale = (mapMode==='arena')? 1.08 : 1.24; // ìŠ¤í”¼ë‹ë”ë¹„ëŠ” ê³¼í™•ëŒ€ ê¸ˆì§€
  const leadX = lead.$el?.offsetLeft || rect.width/2;

  // ê²½ê¸° ì¢…ë£Œ í›„ì—” íŒ¬ ë™ê²°
  const finished = (mapMode==='oval') ? (lead.lapProg>=laps-1e-6) :
                   (mapMode==='sand') ? H.every(h=>h.landed) :
                   (mapMode==='arena') ? (H.filter(h=>!h.done).length<=1) :
                   (lead.x>=dist-1e-6);
  if(finished){
    $viewport.style.transform = `translate(-50%,-50%) scale(${scale}) translate(${camPanX}px, 0)`;
    return;
  }
  const targetPanX = clamp((rect.width/2 - leadX)/scale, -rect.width*0.35, rect.width*0.35);
  camPanX += (targetPanX - camPanX) * 0.15;
  $viewport.style.transform = `translate(-50%,-50%) scale(${scale}) translate(${camPanX}px, 0)`;
}

/* ====== Countdown HUD ====== */
const $hud=document.getElementById('hud'),
      $ltR=document.getElementById('ltR'),
      $ltY=document.getElementById('ltY'),
      $ltG=document.getElementById('ltG'),
      $countTxt=document.getElementById('countTxt'),
      $gunTxt=document.getElementById('gunTxt');
function wait(ms){return new Promise(r=>setTimeout(r,ms))}
async function countdown(){
  $hud.classList.add('show');
  $ltR.className='light on red'; $countTxt.textContent='3'; await wait(650);
  $ltY.className='light on yellow'; $countTxt.textContent='2'; await wait(650);
  $ltG.className='light on green'; $countTxt.textContent='1'; await wait(550);
  $countTxt.textContent='ì¶œë°œ!'; $gunTxt.textContent='íƒ•!'; await wait(300);
  $hud.classList.remove('show'); $gunTxt.textContent='';
}

/* ====== Winner ====== */
function showWinner(entry, extraText){
  $cele.style.display='flex';
  $winnerCard.innerHTML = `
    <div>${winnerHorseSVG(entry.color)}</div>
    <div class="winnerName">[${entry.no}] ${entry.name}${extraText?` â€” ${extraText}`:''}</div>
  `;
  replay.meta.finishedAt = Date.now();
  $replaySaveBtn.onclick = ()=>{ download('lucky-horse-replay.json', JSON.stringify(replay,null,2)); };
}

/* ====== Draw trigger ====== */
function maybeFireDraw(){
  if(drawFired || !pendingDraw) return;
  const k = finishOrder.length; if(k===0) return;

  function pick(n){return finishOrder[n-1];}
  let target=null, extra=null;

  if(mapMode==='sand'){
    // ìƒŒë“œ: finishOrderëŠ” ì°©ì§€ ì™„ë£Œ ìˆœìœ¼ë¡œ ìŒ“ëŠ” ëŒ€ì‹ , ì—¬ê¸°ì„  ì´ë¯¸ ê¸°ë¡ ì‹œì  ì²˜ë¦¬
  }

  if(pendingDraw.type==='first' && k>=1){ target=pick(1); }
  if(pendingDraw.type==='nth'){
    const n=Math.max(1,parseInt(pendingDraw.n||1,10)); if(k>=n) target=pick(n);
  }
  if(pendingDraw.type==='last'){
    if(k===toEntryOrder().length){ target=pick(k); }
  }
  if(target){
    drawFired=true; pendingDraw=null;
    let add='';
    if(mapMode==='sand' && target.landX) add=`${target.landX.toFixed(1)}m`;
    if(mapMode==='arena') add='ìµœí›„ ìƒì¡´ì';
    showWinner(target, add);
  }
}

/* ====== Finish ê¸°ë¡ ====== */
function finishEntry(h){
  if(entryDone.get(h.entryId)) return;
  entryDone.set(h.entryId, true);
  const entry = {entryId:h.entryId, name:h.name, no:h.no, color:h.color, landX:h.landX};
  finishOrder.push(entry);
  logEv((performance.now()-startTS)/1000,'finish', entry);
  maybeFireDraw();
}

/* ====== Physics params ====== */
const JITTER_FACTOR   = 0.22;
const BOOST_PROB      = 0.015;
const BOOST_GAIN      = 0.75;
const FATIGUE_INC     = 0.14;
const FATIGUE_DEC     = 0.07;
const FATIGUE_PENALTY = 0.16;
const VMIN_RATIO      = 0.55;
const VMAX_RATIO      = 2.10;

/* ====== Race Loop ====== */
let lastTime=null, startTS=0;
function run(){
  running=true; lastTime=null; startTS=performance.now();

  const tick=(now)=>{
    if(lastTime===null) lastTime=now;
    const dt=Math.max(0.001,Math.min(0.05,(now-lastTime)/1000));
    lastTime=now;

    if(mapMode==='oval'){
      for(const h of H){
        if(h.done) continue;
        h.lapProg += h.speed * dt * (1.34)/100; // íƒ€ì› ë³´ì •
        if(h.lapProg>=laps){ h.lapProg=laps; h.done=true; }
        if(!h._finished && h.done){ h._finished=true; finishEntry(h); }
        placeHorseOval(h);
      }
    }else if(mapMode==='straight'){
      for(const h of H){
        if(h.done) continue;
        h.speed += h.base*JITTER_FACTOR*(_rand()-0.5);
        if(_rand()<BOOST_PROB) h.speed += h.base*BOOST_GAIN;
        if(h.speed>h.base*1.12) h.fatigue=Math.min(1,h.fatigue+dt*FATIGUE_INC);
        else h.fatigue=Math.max(0,h.fatigue-dt*FATIGUE_DEC);
        h.speed -= h.fatigue*h.base*FATIGUE_PENALTY;
        const vMin=h.base*VMIN_RATIO, vMax=h.base*VMAX_RATIO;
        h.speed=clamp(h.speed,vMin,vMax);
        h.x += h.speed*dt*1.20;
        if(h.x>=dist){ h.x=dist; h.done=true; }
        if(!h._finished && h.done){ h._finished=true; finishEntry(h); }
        placeHorseStraight(h);
      }
    }else if(mapMode==='sand'){
      const vb = $sandMap.getAttribute('viewBox').split(' ').map(Number);
      const W=vb[2], top=120, bot=380, mid=(top+bot)/2;
      const takeoffX = Math.round(W*0.4);
      const startX=80;
      const takeoffM = (takeoffX - startX)/20;

      for(const h of H){
        if(h.done) continue;

        if(!h.air && !h.landed){
          // ë‹¬ë¦¬ê¸°
          h.speed += h.base*JITTER_FACTOR*(_rand()-0.5);
          if(_rand()<BOOST_PROB) h.speed += h.base*BOOST_GAIN;
          if(h.speed>h.base*1.12) h.fatigue=Math.min(1,h.fatigue+dt*FATIGUE_INC);
          else h.fatigue=Math.max(0,h.fatigue-dt*FATIGUE_DEC);
          h.speed -= h.fatigue*h.base*FATIGUE_PENALTY;
          const vMin=h.base*VMIN_RATIO, vMax=h.base*VMAX_RATIO;
          h.speed=clamp(h.speed,vMin,vMax);
          h.x += h.speed*dt*1.20;

          if(h.x>=takeoffM && !h.air){
            // ë„ì•½ì„  ë„ë‹¬ ì¦‰ì‹œ ì í”„ (ì í”„ ê¸¸ì´ëŠ” ëŸ¬ë‹ê³¼ ë…ë¦½)
            h.air=true; h.airT=0;
          }
        }

        if(h.air){
          h.airT += dt;
          if(h.airT>=h.airDur){
            // ì°©ì§€
            h.air=false; h.landed=true;
             const jumpMeters = (h.jumpPow * (12 + _rand()*18)); // 12~30m ë²”ìœ„ë¥¼ jumpPowë¡œ ê°€ë³€
            // ëª¨ë˜ í”¼íŠ¸ ë²”ìœ„ë¡œ í´ë¨í”„
            h.landX = clamp(jumpMeters, 0, pitLen);
            // ë§ ìœ„ì¹˜ë¥¼ ì°©ì§€ ì§€ì ìœ¼ë¡œ ì´ë™(ì´ ì§„í–‰ m = ë„ì•½ì„  + ì°©ì§€ê±°ë¦¬)
            h.x = takeoffM + h.landX;
            h.done = true;
            // ëª¨ë˜ì— "ë°•í˜" í‘œí˜„: ì‚´ì§ ë‚´ë ¤ì•‰ê³  ì í”„ í´ë˜ìŠ¤ í•´ì œ
            h.$el.classList.remove('jump');
            // ì´ë¦„í‘œëŠ” ê·¸ëŒ€ë¡œ (ë²ˆí˜¸/ì´ë¦„ í‘œì‹œ)
            finishEntry(h);
          }
        }

        placeHorseSand(h);
      }
    }else if(mapMode==='arena'){
      // ìŠ¤í”¼ë‹ ë”ë¹„: ì›í˜• ê²½ê¸°ì¥, ì¶©ëŒ/ë°˜ë°œ/íƒˆë½
      const vb=$arenaMap.getAttribute('viewBox').split(' ').map(Number);
      const W=vb[2],Hvb=vb[3],cx=W/2,cy=Hvb/2;
      const R=320; // ì•„ë ˆë‚˜ ë°˜ì§€ë¦„

      // ë‹¨ìˆœ ë¬¼ë¦¬ ì—…ë°ì´íŠ¸
      for(const h of H){
        if(h.done) continue;
        // íšŒì „+ë“œë¦¬í”„íŠ¸ ëŠë‚Œ
        h.rot = (h.rot + 240*dt) % 360;
        // ì•½ê°„ì˜ ì†Œìš©ëŒì´ í˜ (ì¤‘ì•™ì„ ë„ëŠ” ê°€ì†)
        const dx=h.ax-cx, dy=h.ay-cy, distC=Math.hypot(dx,dy)+1e-6;
        const tangential = {x: -dy/distC, y: dx/distC};
        h.vx += tangential.x * 5 * dt;
        h.vy += tangential.y * 5 * dt;

        // ì†ë„ ê°ì‡ 
        h.vx *= 0.996; h.vy *= 0.996;

        // ìœ„ì¹˜ ê°±ì‹ 
        h.ax += h.vx; h.ay += h.vy;

        // ë²½ ì¶©ëŒ â†’ íŠ•ê²¨ë‚˜ê°€ë©´ íƒˆë½
        const d=Math.hypot(h.ax-cx,h.ay-cy);
        if(d>R){
          // íƒˆë½ ì²˜ë¦¬
          h.done=true;
          if(!h._finished){ h._finished=true; finishEntry(h); }
          continue;
        }
      }

      // ê°„ë‹¨í•œ ë§-ë§ ì¶©ëŒ(ì„œë¡œ ë°€ì¹˜ê¸°)
      for(let i=0;i<H.length;i++){
        for(let j=i+1;j<H.length;j++){
          const a=H[i], b=H[j];
          if(a.done||b.done) continue;
          const dx=b.ax-a.ax, dy=b.ay-a.ay, dd=dx*dx+dy*dy;
          const minD=22; // ë§ ê°„ ìµœì†Œ ê°„ê²©
          if(dd<(minD*minD)){
            const d=Math.sqrt(dd)||1;
            const nx=dx/d, ny=dy/d;
            // ë°˜ë°œ
            const push=1.2;
            a.vx -= nx*push; a.vy -= ny*push;
            b.vx += nx*push; b.vy += ny*push;
          }
        }
      }

      // ìƒì¡´ì 1ëª… ë‚¨ìœ¼ë©´ ì¢…ë£Œ
      const alive = H.filter(x=>!x.done);
      if(alive.length===1 && !alive[0]._finished){
        alive[0].done=true; alive[0]._finished=true; finishEntry(alive[0]);
      }

      // ë Œë”
      for(const h of H) placeHorseArena(h);
    }

    updateRanking();
    updateCamera();

    // ëª¨ë‘ ì¢…ë£Œ?
    const allDone = (mapMode==='arena') ? (H.filter(h=>!h.done).length<=0) : H.every(h=>h.done);
    if(allDone){
      running=false;
    }else{
      raf=requestAnimationFrame(tick);
    }
  };

  raf=requestAnimationFrame(tick);
}

/* ====== Controls ====== */
document.getElementById('fullscreenBtn').onclick=()=>{
  const el=document.documentElement;
  if(!document.fullscreenElement){ el.requestFullscreen?.(); }
  else{ document.exitFullscreen?.(); }
};

function updateMapVisibility(){
  $straightMap.style.display = (mapMode==='straight')?'block':'none';
  $ovalMap.style.display     = (mapMode==='oval')?'block':'none';
  $sandMap.style.display     = (mapMode==='sand')?'block':'none';
  $arenaMap.style.display    = (mapMode==='arena')?'block':'none';

  // ì˜µì…˜ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
  $raceDist.style.display = (mapMode==='straight')?'inline-block':'none';
  $raceLen.style.display  = (mapMode==='oval')?'inline-block':'none';
  $sandPit.style.display  = (mapMode==='sand')?'inline-block':'none';
}

$mapSel.onchange=()=>{
  mapMode = $mapSel.value;
  updateMapVisibility();

  // ìº”ë²„ìŠ¤/ìƒíƒœ ì´ˆê¸°í™”
  if(raf) cancelAnimationFrame(raf);
  raf=null; running=false; pendingDraw={type:'first'}; drawFired=false; camPanX=0;
  $cele.style.display='none';
  clearHorses();
  resetFinishOrder();

  // ë§µ ë“œë¡œìš°
  if(mapMode==='straight'){ drawStraight(); }
  if(mapMode==='oval'){ drawOval(); }
  if(mapMode==='sand'){ drawSand(); }
  if(mapMode==='arena'){ drawArena(); }
};

$leaderBtn.onclick=()=>{
  leaderView=!leaderView;
  $leaderBtn.textContent = `ë¦¬ë”ë·°: ${leaderView?'ON':'OFF'}`;
  if(!leaderView){ camPanX=0; $viewport.style.transform=`translate(-50%,-50%) scale(1)`; }
};

/* ì¶”ì²¨(ë¼ë””ì˜¤) */
const $drawNthInput = document.getElementById('drawNthInput');
document.getElementById('drawGroup').addEventListener('click',(e)=>{
  const lab = e.target.closest('label.seg-item');
  if(!lab) return;
  document.querySelectorAll('#drawGroup .seg-item').forEach(l=>l.classList.remove('on'));
  lab.classList.add('on');
  const type = lab.dataset.type;
  if(type==='first'){ pendingDraw={type:'first'}; $drawNthInput.disabled=true; }
  else if(type==='last'){ pendingDraw={type:'last'}; $drawNthInput.disabled=true; }
  else if(type==='nth'){ pendingDraw={type:'nth'}; $drawNthInput.disabled=false; $drawNthInput.focus(); }
});
$drawNthInput.addEventListener('input',()=>{
  const n = parseInt($drawNthInput.value,10);
  if(!Number.isFinite(n) || n<1){ pendingDraw=null; return; }
  pendingDraw={type:'nth', n};
});

/* ì´ë¦„ ì…ë ¥ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° */
$names.addEventListener('input', ()=>{
  const list=splitNames($names.value);
  if(!list.length){ clearHorses(); return; }
  buildHorses(list);
});

/* ì‹œì‘/ë¦¬ì…‹ */
$start.onclick=async()=>{
  if(running) return;
  const list=splitNames($names.value);
  if(list.length<MIN){ alert('ìµœì†Œ 2ëª… ì…ë ¥'); return; }
  if(list.length>MAX){ alert('ìµœëŒ€ 50ëª…'); return; }

  laps=parseInt($raceLen.value,10)||3;
  dist=parseInt($raceDist.value,10)||100;
  pitLen=parseInt($sandPit.value,10)||50;

  seed=autoSeed(); reseed(seed);
  replay = {meta:{seed, names:list.map(x=>x.name), map:mapMode, dist, laps, pitLen, startedAt:Date.now()}, events:[]};

  $cele.style.display='none';
  if(raf) cancelAnimationFrame(raf);
  raf=null; running=false; camPanX=0;
  clearHorses();
  resetFinishOrder();

  if(mapMode==='straight'){ drawStraight(); }
  if(mapMode==='oval'){ drawOval(); }
  if(mapMode==='sand'){ drawSand(); }
  if(mapMode==='arena'){ drawArena(); }

  buildHorses(list);
  await countdown();
  run();
};

$reset.onclick=()=>{
  if(raf) cancelAnimationFrame(raf);
  raf=null; running=false; pendingDraw={type:'first'}; drawFired=false; camPanX=0;
  $cele.style.display='none';
  clearHorses();
  resetFinishOrder();

  if(mapMode==='straight'){ drawStraight(); }
  if(mapMode==='oval'){ drawOval(); }
  if(mapMode==='sand'){ drawSand(); }
  if(mapMode==='arena'){ drawArena(); }

  // ë¼ë””ì˜¤ UI ì´ˆê¸°í™” (1ë“± ì„ íƒ)
  document.querySelectorAll('#drawGroup .seg-item').forEach(l=>l.classList.remove('on'));
  document.querySelector('#drawGroup .seg-item[data-type="first"]').classList.add('on');
  $drawNthInput.value=''; $drawNthInput.disabled=true;
};

/* ë°°ì¹˜/ë¦¬ì‚¬ì´ì¦ˆ */
addEventListener('resize', ()=>{
  if(mapMode==='straight') drawStraight();
  if(mapMode==='oval') drawOval();
  if(mapMode==='sand') drawSand();
  if(mapMode==='arena') drawArena();
  H.forEach(placeEntity);
  updateCamera();
});

/* ====== ì´ˆê¸° ì§„ì… ê¸°ë³¸ê°’ ====== */
// 1) ê¸°ë³¸ ë§µ: ì§ì„ , ë¦¬ë”ë·° ON, ì¶”ì²¨ '1ë“±' ì„ íƒ ON
mapMode='straight';
updateMapVisibility();
drawStraight();
document.querySelector('#drawGroup .seg-item[data-type="first"]').classList.add('on');
// ë¦¬ë”ë·° ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³´ì •
$leaderBtn.textContent='ë¦¬ë”ë·°: ON';
</script>
</body>
</html>
