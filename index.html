<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lucky Horse Race — 경마게임</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">
  <style>
    :root {
      --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb;
      --muted:#94a3b8; --border:#1f2937; --accent:#6ee7ff;
    }
    *{box-sizing:border-box}
    html, body { height:100%; margin:0 }
    body {
      color:var(--ink); background:var(--bg);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Malgun Gothic",sans-serif;
    }

    /* ... 스타일 생략 없이 전부 있음 ... */
  </style>
</head>
  <body>
<div class="wrap">

  <div class="notice">자유롭게 사용해주시고 피드백 부탁드립니다.</div>

  <!-- HUD -->
  <div class="hud" id="hud">
    <div class="traffic">
      <div class="light" id="ltR"></div>
      <div class="light" id="ltY"></div>
      <div class="light" id="ltG"></div>
      <span class="countTxt" id="countTxt">Ready</span>
      <span class="gun" id="gunTxt"></span>
    </div>
  </div>

  <!-- Stage -->
  <div class="stage" id="stage">
    <div class="viewport" id="viewport">
      <div class="canvas" id="canvas">
        <!-- 타원맵 -->
        <svg id="ovalMap" class="ovalSvg" viewBox="0 0 1000 600" style="display:none">
          <ellipse cx="500" cy="300" rx="420" ry="220" fill="#0e1a2a" stroke="#2a3b54" stroke-width="2"/>
          <ellipse cx="500" cy="300" rx="360" ry="160" fill="#0b1220" stroke="#1f2937" stroke-width="2"/>
          <ellipse cx="500" cy="300" rx="390" ry="190" fill="none" stroke="#5b708f" stroke-dasharray="6,6" stroke-width="2"/>
          <text id="ovalStartTxt" x="500" y="70" text-anchor="middle" font-size="14" fill="#a5f3fc" font-weight="800">출발</text>
        </svg>

        <!-- 직선맵 -->
        <svg id="straightMap" class="straightSvg" viewBox="0 0 2000 400"></svg>
      </div>
    </div>

    <!-- 순위판 -->
    <div id="rankingBox" class="ranking">
      <h3>현재 순위</h3>
      <div id="rankingLines"></div>
    </div>
  </div>

  <!-- 하단 UI -->
  <header>
    <div class="controls left">
      <input id="names" type="text" placeholder="참가자 입력 (예: 고구마 감자 김치 / 고구마*3)">
      <select id="raceLen" style="display:none">
        <option value="1">1바퀴</option>
        <option value="3" selected>3바퀴</option>
        <option value="5">5바퀴</option>
        <option value="10">10바퀴</option>
      </select>
      <select id="raceDist">
        <option value="100" selected>100m</option>
        <option value="200">200m</option>
        <option value="300">300m</option>
        <option value="500">500m</option>
      </select>

      <button class="btn-ghost" id="shuffleBtn">말 섞기</button>
      <button class="btn-accent" id="startBtn">시작 ▶</button>
      <button class="btn-ghost" id="resetBtn">리셋</button>
      <button class="btn-ghost" id="mapToggleBtn">맵 전환: 직선</button>
    </div>

    <div class="controls right">
      <div class="seg" id="drawSeg">
        <label class="seg-item" data-type="first">
          <input type="radio" name="draw" value="first">
          <span>1등</span>
        </label>
        <label class="seg-item" data-type="last">
          <input type="radio" name="draw" value="last">
          <span>마지막</span>
        </label>
        <label class="seg-item" data-type="nth">
          <input type="radio" name="draw" value="nth">
          <span>n등</span>
        </label>
        <input id="drawNthInput" type="number" min="1" step="1" placeholder="n등" disabled>
      </div>

      <a href="https://buymeacoffee.com/luckyhorse" target="_blank" class="btn-accent btn">개발자 컵라면 사주기 🍜</a>
      <button class="btn-ghost" id="btnContact">문의 및 건의사항</button>
    </div>
  </header>
</div>

<!-- 우승 오버레이 -->
<div id="celebrate">
  <div class="title wiggle">WINNER~</div>
  <div class="subtitle" id="celeHorse"></div>
  <div>
    <button class="btn-accent btn-sm" id="btnReplaySave">리플레이 저장</button>
    <button class="btn-ghost btn-sm" id="btnCloseWin">닫기</button>
  </div>
</div>

<script>
/* ====== Utils ====== */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
let _rand=Math.random;
function reseed(seed){_rand=mulberry32(seed|0)}
function autoSeed(){return(Date.now()^Math.floor(Math.random()*0xFFFFFFFF))>>>0}
const JERSEYS=['#60a5fa','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6','#eab308','#fb7185','#34d399','#f97316','#a3e635','#e879f9','#f43f5e','#6ee7ff'];
function jc(i){return JERSEYS[i%JERSEYS.length]}
function splitNames(raw){
  return raw.split(/[/\s]+/).map(s=>s.trim()).filter(Boolean)
    .flatMap(s=>{const m=s.match(/(.+)\*(\d+)/);return m?Array.from({length:Math.min(50,parseInt(m[2]))},()=>m[1]):s})
    .slice(0,50).map((n,i)=>({name:n,no:i+1}));
}

/* ====== DOM 요소들 ====== */
const $names=document.getElementById('names'),
      $raceLen=document.getElementById('raceLen'),
      $raceDist=document.getElementById('raceDist'),
      $start=document.getElementById('startBtn'),
      $reset=document.getElementById('resetBtn'),
      $shuffle=document.getElementById('shuffleBtn'),
      $mapToggle=document.getElementById('mapToggleBtn'),
      $rankingBox=document.getElementById('rankingBox'),
      $rankingLines=document.getElementById('rankingLines'),
      $viewport=document.getElementById('viewport'),
      $canvas=document.getElementById('canvas'),
      $ovalMap=document.getElementById('ovalMap'),
      $straightMap=document.getElementById('straightMap'),
      $cele=document.getElementById('celebrate'),
      $celeHorse=document.getElementById('celeHorse');

/* ====== 상태값 ====== */
const MIN=2,MAX=50;
let H=[],running=false,raf=null;
let laps=3, dist=100;
let mapMode="straight";
let finishOrder=[];
let pendingDraw=null;

/* ====== 속도 설정 ====== */
const BASE_SPEED_MIN = 2.8;
const BASE_SPEED_MAX = 6.2;
const SPEED_GLOBAL   = 1.20;
const JITTER_FACTOR   = 0.22;
const BOOST_PROB      = 0.015;
const BOOST_GAIN      = 0.75;
const FATIGUE_INC     = 0.14;
const FATIGUE_DEC     = 0.07;
const FATIGUE_PENALTY = 0.16;
const VMIN_RATIO      = 0.55;
const VMAX_RATIO      = 2.10;

/* 타원맵 전용 속도 */
const OVAL_BOOST   = 0.06;
const OVAL_FATIGUE = 0.015;

/* ====== 말 SVG 생성 ====== */
function horseSVG(color){
  return `<svg class="horse-svg" viewBox="0 0 64 44" xmlns="http://www.w3.org/2000/svg" style="--jersey:${color}">
    <g class="g-bob">
      <path class="mane" d="M10 26c2-3 3-5 6-6 0 4-2 7-4 9l-4-1 2-2z"/>
      <path class="body" d="M8 28c7-9 12-11 20-11h9c7 0 14 4 19 9l3 5-4 2-6-4-7 2H28l-8 1-6 3-6-1 6-6z"/>
      <rect class="saddle" x="28" y="17" width="11" height="7" rx="2"/>
      <g class="jockey">
        <circle cx="31" cy="12" r="3.6"/>
        <rect x="28" y="15.5" width="10" height="7" rx="2"/>
      </g>
      <circle class="eye" cx="22.5" cy="20.5" r="0.9"/>
      <rect class="front-leg" x="21" y="26" width="3.5" height="13" fill="#e5e7eb"/>
      <rect class="back-leg"  x="36" y="26" width="3.5" height="13" fill="#e5e7eb"/>
    </g>
  </svg>`;
}
    
/* ====== 말 제거 + 배치 ====== */
function clearHorses(){ $canvas.querySelectorAll('.horse').forEach(n=>n.remove()); H.length=0; }

function buildHorses(list){
  clearHorses();
  const lanes=list.length;
  list.forEach((ent,i)=>{
    const color=jc(i);
    const el=document.createElement('div'); el.className='horse'; el.innerHTML=horseSVG(color);
    const plate=document.createElement('div'); plate.className='nameplate';
    plate.textContent=`${ent.no}번 ${ent.name}`; plate.style.borderColor=color; el.appendChild(plate);
    $canvas.appendChild(el);

    if(mapMode==="oval"){
      H.push({name:ent.name,no:ent.no,color,$el:el,theta:-Math.PI/2+i*0.03,v:0.02+(_rand()-0.5)*0.004,f:0,done:false});
    } else {
      const base = BASE_SPEED_MIN + _rand() * (BASE_SPEED_MAX - BASE_SPEED_MIN);
      const vb = $straightMap.viewBox.baseVal;
      const trackH = Math.max(160, lanes * 40 + 80);
      const trackY = (vb.height - trackH) / 2;
      const laneGap = 40;
      const y = trackY + laneGap * (i + 0.5) + (_rand() - 0.5) * 10;
      H.push({
        name: ent.name, no: ent.no, color, $el: el,
        x: 0, y,
        base,
        speed: base * (0.85 + _rand() * 0.3),
        fatigue: 0, done: false, _finished: false
      });
    }
  });
  updateRanking();
  H.forEach(placeHorse);
}

/* ====== 직선 맵 그리기 ====== */
function drawStraightMap(lanes = H.length){
  const PX_PER_M = 40;
  const straightViewW = PX_PER_M * dist;
  const laneGap = Math.min(50, 600 / lanes);
  const straightViewH = Math.max(400, lanes * laneGap + 200);
  $straightMap.setAttribute('viewBox', `0 0 ${straightViewW} ${straightViewH}`);

  const trackH = Math.max(160, lanes * laneGap + 80);
  const trackY = (straightViewH - trackH) / 2;
  const paddingX = 80;
  const startX = paddingX;
  const finishX = straightViewW - paddingX;

  const defs = `
    <defs>
      <pattern id="checkers" width="6" height="6" patternUnits="userSpaceOnUse">
        <rect width="6" height="6" fill="#e5e7eb"/>
        <rect width="3" height="3" x="0" y="0" fill="#0b1220"/>
        <rect width="3" height="3" x="3" y="3" fill="#0b1220"/>
      </pattern>
    </defs>
  `;

  $straightMap.innerHTML = `
    ${defs}
    <rect x="0" y="${trackY}" width="${straightViewW}" height="${trackH}" fill="#0e1a2a" stroke="#2a3b54" stroke-width="2"/>
    <line x1="${startX}" y1="${trackY-10}" x2="${startX}" y2="${trackY + trackH + 10}" stroke="#22d3ee" stroke-width="6"/>
    <text x="${startX}" y="${trackY - 22}" text-anchor="middle" font-size="14" fill="#a5f3fc" font-weight="800">출발 (0m)</text>
    <rect x="${finishX - 6}" y="${trackY - 10}" width="12" height="${trackH + 20}" fill="url(#checkers)"/>
    <text x="${finishX}" y="${trackY - 22}" text-anchor="middle" font-size="14" fill="#e5e7eb" font-weight="900">도착 (${dist}m)</text>
  `;
}

  /* ====== 말 위치 갱신 ====== */
function placeHorse(h){
  if(mapMode==="oval"){
    const cx=500,cy=300,rx=390,ry=190;
    const t=h.theta;
    const sx=cx+rx*Math.cos(t), sy=cy+ry*Math.sin(t);
    const rect=$canvas.getBoundingClientRect();
    const scaleX=rect.width/1000, scaleY=rect.height/600;
    const x=sx*scaleX, y=sy*scaleY;
    h.$el.style.left = x+'px'; h.$el.style.top = y+'px';
    const dx=-rx*Math.sin(t), dy=ry*Math.cos(t);
    const ang=Math.atan2(dy*scaleY, dx*scaleX)*180/Math.PI;
    h.$el.style.transform=`translate(-50%,-50%) rotate(${ang}deg)`;
  } else {
    const vb=$straightMap.viewBox.baseVal;
    const trackStart=80, trackFinish=vb.width-80;
    const progress=Math.max(0,Math.min(1,h.x/dist));
    const sx=trackStart+(trackFinish-trackStart)*progress;
    const rect=$canvas.getBoundingClientRect();
    const scaleX=rect.width/vb.width, scaleY=rect.height/vb.height;
    const x=sx*scaleX, y=h.y*scaleY;
    h.$el.style.left=x+'px'; h.$el.style.top=y+'px';
    h.$el.style.transform=`translate(-50%,-50%)`;
  }
}

/* ====== 카메라 따라가기 ====== */
function updateCamera(){
  if(H.length === 0) return;

  let leader = finishOrder[0] || H.reduce((a,b)=>
    (mapMode==="oval") ? (a.theta > b.theta ? a : b) : (a.x > b.x ? a : b)
  );

  const rect = $canvas.getBoundingClientRect();

  if(mapMode === "straight"){
    const vb = $straightMap.viewBox.baseVal;
    const trackStart = 80, trackFinish = vb.width - 80;
    const progress = Math.max(0, Math.min(1, leader.x / dist));
    const sx = trackStart + (trackFinish - trackStart) * progress;

    const zoom = 1.85;
    const scaleX = rect.width / vb.width;
    const scaleY = rect.height / vb.height;
    const px = sx * scaleX * zoom;
    const py = leader.y * scaleY * zoom;
    const cx = rect.width * 0.5;
    const cy = rect.height * 0.5;
    const dx = (cx - px) / zoom;
    const dy = (cy - py) / zoom;

    $viewport.style.transform = `translate(-50%,-50%) scale(${zoom}) translate(${dx}px, ${dy}px)`;
  }
}

/* ====== 레이스 루프 ====== */
function run(){
  running=true;
  let lastTime=null;

  const tick=(now)=>{
    if(lastTime===null) lastTime=now;
    const dt=Math.max(0.001,Math.min(0.05,(now-lastTime)/1000));
    lastTime=now;

    for(const h of H){
      if(h.done) continue;

      h.speed += h.base*JITTER_FACTOR*(_rand()-0.5);
      if(_rand()<BOOST_PROB) h.speed += h.base*BOOST_GAIN;
      if(h.speed > h.base*1.12) h.fatigue=Math.min(1,h.fatigue+dt*FATIGUE_INC);
      else h.fatigue=Math.max(0,h.fatigue-dt*FATIGUE_DEC);
      h.speed -= h.fatigue*h.base*FATIGUE_PENALTY;

      const vMin=h.base*VMIN_RATIO, vMax=h.base*VMAX_RATIO;
      h.speed = Math.max(vMin, Math.min(vMax, h.speed));

      h.x += h.speed * dt * SPEED_GLOBAL;
      if(h.x >= dist){
        h.x = dist;
        h.speed = 0;
        h.done = true;
      }

      if(!h._finished && h.done){
        h._finished = true;
        finishOrder.push(h);
        maybeFireDraw();
      }

      placeHorse(h);
    }

    updateRanking();
    updateCamera();

    if(H.every(h=>h.done)){
      running=false;
      celebrate();
    } else {
      raf = requestAnimationFrame(tick);
    }
  };

  raf = requestAnimationFrame(tick);
}

/* ====== 버튼 핸들러 ====== */
$start.onclick = async () => {
  if(running) return;
  const list = splitNames($names.value);
  if(list.length < 2){ alert('참가자 2명 이상 입력'); return; }

  reseed(autoSeed());
  $cele.style.display = 'none';
  finishOrder.length = 0;

  if(mapMode === "straight") drawStraightMap(list.length);
  buildHorses(list);

  await countdown();
  run();
};

$reset.onclick = () => {
  if(raf) cancelAnimationFrame(raf);
  raf = null;
  running = false;
  finishOrder.length = 0;
  $cele.style.display = 'none';

  const list = splitNames($names.value);
  if(mapMode === "straight") drawStraightMap(list.length || 6);
  buildHorses(list);
  $viewport.style.transform = "translate(-50%,-50%) scale(1)";
};

$shuffle.onclick = () => {
  const list = splitNames($names.value);
  for(let i = list.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [list[i], list[j]] = [list[j], list[i]];
  }
  $names.value = list.map(x => x.name).join(' ');
  if(mapMode === "straight") drawStraightMap(list.length);
  buildHorses(list);
};

/* ====== 우승 연출 ====== */
function celebrate(){
  const winner = finishOrder[0];
  if(!winner) return;

  const pill = `<div class="namepill">
    <span class="dot" style="background:${winner.color}"></span>
    <span>${winner.no}번 ${winner.name}</span>
  </div>`;
  $celeHorse.innerHTML = pill;
  $cele.style.display = 'flex';
}
