<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lucky Horse Race â€” ê²½ë§ˆê²Œì„</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --accent:#6ee7ff;
  --accent2:#fcd34d; --danger:#ef4444; --ok:#22c55e;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{color:var(--ink);background:#0b1220;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Malgun Gothic",sans-serif}

/* ì•ˆë‚´ ë°°ë„ˆ */
.notice{
  position:absolute; top:8px; left:12px; z-index:40;
  background:rgba(0,0,0,.45); padding:6px 12px; border-radius:10px;
  font-size:13px; color:#cbd5e1; backdrop-filter: blur(2px);
}

/* Buttons / Layout */
button,a.btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800;letter-spacing:.2px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
.btn-accent{background:linear-gradient(180deg,#1b9ab7,#168aa4);color:#06131b;border:1px solid #0a6c82}
.btn-ghost{background:rgba(0,0,0,.35);border:1px solid #2a3a57;color:#cbd5e1}
.btn-accent:hover,.btn-ghost:hover{filter:brightness(1.06)}
.btn-toggle.on{outline:2px solid var(--accent2); box-shadow:0 0 0 2px #0006 inset}

/* Stage */
.wrap{position:relative;width:100vw;height:100vh;overflow:hidden}
.stage{position:absolute; inset:0;}
.viewport{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);transform-origin:50% 50%; transition:transform .12s ease-out}
.canvas{position:relative;width:min(98vw,1800px);height:auto;margin:0 auto}

/* Maps */
.ovalSvg,.straightSvg{width:100%;height:auto;display:block}

/* Horses / Jockey */
.horse,.jockey{position:absolute;transform:translate(-50%,-50%);pointer-events:none;}
.horse{width:46px;height:34px; z-index:8}
.horse.jump{ z-index:12; }
.jockey{width:28px;height:28px; z-index:9}
.nameplate{position:absolute;bottom:100%;left:50%;transform:translate(-50%,-8px);background:#09111e;color:#dbe7f3;border:1px solid #2a3b57;border-radius:10px;font-size:11px;font-weight:800;padding:3px 8px;white-space:nowrap}
.stateIcon{position:absolute;left:50%;top:-36px;transform:translate(-50%,0);font-size:16px;filter:drop-shadow(0 2px 3px rgba(0,0,0,.5))}

.horse-svg{width:46px;height:34px}
.horse-svg .body{fill:#e5e7eb}
.horse-svg .mane{fill:#cbd5e1}
.horse-svg .jockey{fill:var(--jersey,#60a5fa)}
.horse-svg .saddle{fill:#94a3b8}
.horse-svg .eye{fill:#0f172a}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-1.2px)}}
.horse-svg .g-bob{animation:bob .26s infinite ease-in-out}

/* ë‹¤ë¦¬ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes leg-run-front { 0%,100% { transform: rotate(18deg); } 50% { transform: rotate(-18deg); } }
@keyframes leg-run-back  { 0%,100% { transform: rotate(-18deg); } 50% { transform: rotate(18deg); } }
.front-leg{transform-origin: top center;animation: leg-run-front .42s infinite linear}
.back-leg {transform-origin: top center;animation: leg-run-back  .42s infinite linear}

/* íŒŒí‹°ëª¨ë“œ ì´í™íŠ¸ */
.spin{animation:spin .6s linear infinite}
@keyframes spin{from{transform:translate(-50%,-50%) rotate(0)}to{transform:translate(-50%,-50%) rotate(360deg)}}
.moonwalk .front-leg{animation-direction:reverse}.moonwalk .back-leg{animation-direction:reverse}
.frenzy{filter:hue-rotate(45deg) brightness(1.15)}
.biped .horse-svg .g-bob{animation-duration:.18s}

/* Ranking (ë‹¤ì—´) */
.rankWrap{position:absolute;top:12px;right:12px;z-index:25;display:flex;gap:8px;align-items:flex-start}
.ranking{width:260px;background:rgba(8,18,34,.78);border:1px solid #2a3b54;border-radius:10px;padding:8px;font-size:13px}
.ranking h3{margin:2px 0 6px;font-size:13px;color:#93c5fd}
.ranking .row{display:flex;justify-content:space-between;padding:2px 6px;border-radius:6px}
.ranking .row:nth-child(odd){background:rgba(255,255,255,.03)}
.ranking .pos{font-weight:900;color:#6ee7ff}
.color-badge{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle;border:1px solid #1f2937}

/* Header */
header{position:absolute;inset:auto 0 0 0;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:12px;background:rgba(0,0,0,.5);z-index:30}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
#names{min-width:260px;padding:10px;border:1px solid #223047;border-radius:10px;background:rgba(0,0,0,.35);color:#dbe7f3}

/* HUD */
.hud{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:20}
.hud.show{display:flex}
.traffic{display:flex;gap:10px;align-items:center;background:#0b1220cc;border:1px solid #334155;padding:10px 14px;border-radius:12px}
.light{width:18px;height:18px;border-radius:50%;background:#111827;border:1px solid #334155}
.light.on.red{background:#ef4444}.light.on.yellow{background:#f59e0b}.light.on.green{background:#22c55e}
.countTxt{margin-left:6px;font-weight:900}
.gun{margin-left:8px;font-size:12px;color:#93c5fd}

/* Carrot & Hay rain */
@keyframes fall{0%{transform:translateY(-50px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(360deg);opacity:0}}
.carrot{position:fixed;top:-50px;animation:fall 3s linear forwards;pointer-events:none;z-index:9999;font-size:56px}
.hay{position:fixed;top:-50px;animation:fall 3s linear forwards;pointer-events:none;z-index:9999;font-size:52px}

/* Winner Overlay (í‚¹ë°›ê²Œ) */
#celebrate{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.55);z-index:10000;text-align:center}
#celebrate .big{font-size:96px;display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:8px}
#celebrate .title{font-size:72px;color:#fff;margin:0 0 8px;letter-spacing:.2em;animation:jelly 1.6s ease both; text-shadow:0 2px 10px rgba(0,0,0,.45),0 0 22px rgba(110,231,255,.25)}
#celebrate .subtitle{font-size:28px;color:#e6f9ff;margin:0 0 18px;text-shadow:0 1px 6px rgba(0,0,0,.35)}
@keyframes jelly{0%{transform:scale(0.8)}40%{transform:scale(1.12)}60%{transform:scale(0.98)}100%{transform:scale(1)}}
.winnerCard{display:flex;gap:20px;align-items:center;justify-content:center;margin:8px 0 18px}
.winnerHorse{width:160px;height:120px;transform:scale(1.2)}
.winnerName{font-size:28px;font-weight:900}
.confetti{position:fixed;top:-20px;font-size:26px;pointer-events:none;animation:fall 2.5s linear forwards;z-index:10001}

/* ì¶”ì²¨ ì„¸ê·¸ë¨¼íŠ¸ */
.seg{
  display:inline-flex; gap:6px; align-items:center; background:rgba(255,255,255,.05);
  border:1px solid #2a3b57; border-radius:12px; padding:6px; flex-wrap:wrap;
}
.seg-item{position:relative}
.seg-item input{display:none}
.seg-item span{
  display:inline-block; padding:8px 12px; border-radius:10px; border:1px solid #2a3b57;
  background:rgba(0,0,0,.35); color:#cbd5e1; font-weight:800; cursor:pointer; user-select:none;
}
.seg-item.on span{
  background:linear-gradient(180deg,#1b9ab7,#168aa4); color:#06131b; border-color:#0a6c82;
  box-shadow:0 0 0 1px rgba(0,0,0,.15), 0 0 12px #6ee7ff33;
}
#drawNthInput{
  width:70px; padding:8px; border-radius:10px; border:1px solid #223047;
  background:rgba(0,0,0,.35); color:#dbe7f3
}

/* ë¯¸ë‹ˆ í—¤ë“œì—… */
.chip{display:inline-block;padding:6px 10px;border:1px solid #2a3b57;border-radius:999px;background:rgba(0,0,0,.35);color:#cbd5e1;font-weight:800}

/* ëª¨ë°”ì¼ ë³´ì • */
@media (max-width:640px){.ranking{width:220px}#names{min-width:180px}}
</style>
</head>
<body>
<div class="wrap">

  <div class="notice">ììœ ë¡­ê²Œ ì‚¬ìš©í•´ì£¼ì‹œê³  í”¼ë“œë°± ë¶€íƒë“œë¦½ë‹ˆë‹¤.</div>

  <!-- HUD -->
  <div class="hud" id="hud">
    <div class="traffic">
      <div class="light" id="ltR"></div>
      <div class="light" id="ltY"></div>
      <div class="light" id="ltG"></div>
      <span class="countTxt" id="countTxt">Ready</span>
      <span class="gun" id="gunTxt"></span>
    </div>
  </div>

  <!-- Stage -->
  <div class="stage" id="stage">
    <div class="viewport" id="viewport">
      <div class="canvas" id="canvas">
        <!-- íƒ€ì›ë§µ -->
        <svg id="ovalMap" class="ovalSvg" viewBox="0 0 1000 600" style="display:none"></svg>
        <!-- ì§ì„ ë§µ -->
        <svg id="straightMap" class="straightSvg" viewBox="0 0 2000 400"></svg>
        <!-- ì§€ê·¸ì¬ê·¸ -->
        <svg id="zigzagMap" class="straightSvg" viewBox="0 0 2000 500" style="display:none"></svg>
        <!-- Së¼ì¸ -->
        <svg id="slineMap" class="straightSvg" viewBox="0 0 2000 500" style="display:none"></svg>
      </div>
    </div>

    <!-- ìˆœìœ„íŒ ë˜í¼(ë‹¤ì—´) -->
    <div class="rankWrap" id="rankWrap">
      <div id="rankingBox" class="ranking">
        <h3>í˜„ì¬ ìˆœìœ„</h3>
        <div id="rankingLines"></div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ UI -->
  <header>
    <div class="controls left">
      <input id="names" type="text" placeholder="ì°¸ê°€ì ì…ë ¥ (ì˜ˆ: ê³ êµ¬ë§ˆ ê°ì ê¹€ì¹˜ / ê³ êµ¬ë§ˆ*3)">
      <select id="raceLen" style="display:none">
        <option value="1">1ë°”í€´</option>
        <option value="3" selected>3ë°”í€´</option>
        <option value="5">5ë°”í€´</option>
        <option value="10">10ë°”í€´</option>
      </select>
      <select id="raceDist">
        <option value="100" selected>100m</option>
        <option value="200">200m</option>
        <option value="300">300m</option>
        <option value="500">500m</option>
        <option value="1000">1km</option>
      </select>

      <button class="btn-ghost" id="shuffleBtn">ë§ ì„ê¸°</button>
      <button class="btn-accent" id="startBtn">ì‹œì‘ â–¶</button>
      <button class="btn-ghost" id="resetBtn">ë¦¬ì…‹</button>

      <button class="btn-ghost" id="mapToggleBtn">ë§µ: ì§ì„ </button>
      <button class="btn-ghost btn-toggle" id="firstCamBtn">1ë“± ë·° OFF</button>
      <span class="chip">íŒŒí‹°ëª¨ë“œ <input id="partyChk" type="checkbox"> <select id="partyLv"><option>ë‚®ìŒ</option><option selected>ë³´í†µ</option><option>ê°•í•¨</option></select></span>
      <span class="chip">ë¦¬í”Œë ˆì´ ì €ì¥ <input id="replayChk" type="checkbox"></span>
    </div>

    <div class="controls right">
      <!-- ì¶”ì²¨ ë©”ë‰´ (ì„¸ê·¸ë¨¼íŠ¸) -->
      <div class="seg" id="drawSeg">
        <label class="seg-item on" data-type="first">
          <input type="radio" name="draw" value="first" checked>
          <span>1ë“±</span>
        </label>
        <label class="seg-item" data-type="last">
          <input type="radio" name="draw" value="last">
          <span>ë§ˆì§€ë§‰</span>
        </label>
        <label class="seg-item" data-type="nth">
          <input type="radio" name="draw" value="nth">
          <span>në“±</span>
        </label>
        <input id="drawNthInput" type="number" min="1" step="1" placeholder="në“±" disabled>
        <small style="opacity:.8;margin-left:6px">â€» ì„ íƒë§Œ í•´ë‘ë©´, í•´ë‹¹ ë“±ìˆ˜ ë“¤ì–´ì˜¤ëŠ” ìˆœê°„ ìë™ ë°œí‘œ</small>
      </div>

      <a href="https://buymeacoffee.com/luckyhorse" target="_blank" class="btn-accent btn">ê°œë°œì ì»µë¼ë©´ ì‚¬ì£¼ê¸° ğŸœ</a>
      <button class="btn-ghost" id="btnContact">ë¬¸ì˜ ë° ê±´ì˜ì‚¬í•­</button>
    </div>
  </header>
</div>

<!-- Winner Overlay -->
<div id="celebrate">
  <div class="big" id="winnerVisual"></div>
  <div class="title" id="celeTitle">W i n n e r r r r r ~</div>
  <div class="subtitle" id="celeSubtitle">ì´ ë§›ì— ë‹¬ë¦°ë‹¤~</div>
  <div class="winnerCard" id="winnerCard"></div>
  <div style="display:flex; gap:8px">
    <button class="btn-accent" id="replaySaveBtn" style="display:none">ë¦¬í”Œë ˆì´ ì €ì¥</button>
    <button class="btn-ghost" onclick="document.getElementById('celebrate').style.display='none'">ë‹«ê¸°</button>
  </div>
</div>

<script>
/* ====== Utils ====== */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
let _rand=Math.random;
function reseed(seed){_rand=mulberry32(seed|0)}
function autoSeed(){return(Date.now()^Math.floor(Math.random()*0xFFFFFFFF))>>>0}
const JERSEYS=['#60a5fa','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6','#eab308','#fb7185','#34d399','#f97316','#a3e635','#e879f9','#f43f5e','#6ee7ff'];
function jc(i){return JERSEYS[i%JERSEYS.length]}
function splitNames(raw){
  return raw.split(/[/\s]+/).map(s=>s.trim()).filter(Boolean)
    .flatMap(s=>{const m=s.match(/(.+)\*(\d+)/);return m?Array.from({length:Math.min(50,parseInt(m[2]))},()=>m[1]):s})
    .slice(0,50).map((n,i)=>({name:n,no:i+1}));
}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function download(filename, text){
  const a=document.createElement('a');
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text);
  a.download=filename; a.click();
}

/* ====== DOM ====== */
const $names=document.getElementById('names'),
      $raceLen=document.getElementById('raceLen'),
      $raceDist=document.getElementById('raceDist'),
      $start=document.getElementById('startBtn'),
      $reset=document.getElementById('resetBtn'),
      $shuffle=document.getElementById('shuffleBtn'),
      $mapToggle=document.getElementById('mapToggleBtn'),
      $firstCamBtn=document.getElementById('firstCamBtn'),
      $partyChk=document.getElementById('partyChk'),
      $partyLv=document.getElementById('partyLv'),
      $replayChk=document.getElementById('replayChk'),
      $rankWrap=document.getElementById('rankWrap'),
      $rankingBox=document.getElementById('rankingBox'),
      $rankingLines=document.getElementById('rankingLines'),
      $viewport=document.getElementById('viewport'),
      $canvas=document.getElementById('canvas'),
      $ovalMap=document.getElementById('ovalMap'),
      $straightMap=document.getElementById('straightMap'),
      $zigzagMap=document.getElementById('zigzagMap'),
      $slineMap=document.getElementById('slineMap'),
      $cele=document.getElementById('celebrate'),
      $celeTitle=document.getElementById('celeTitle'),
      $celeSubtitle=document.getElementById('celeSubtitle'),
      $winnerCard=document.getElementById('winnerCard'),
      $winnerVisual=document.getElementById('winnerVisual'),
      $replaySaveBtn=document.getElementById('replaySaveBtn');

/* ====== State ====== */
const MIN=2,MAX=50;
let H=[],running=false,raf=null;
let laps=3, dist=100;
let mapMode="straight"; // straight | oval | zigzag | sline
let pendingDraw={type:'first'}; // ê¸°ë³¸ê°’ 1ë“±
let finishOrder = [];                 // ì—”íŠ¸ë¦¬(ì‚¬ëŒ) ê¸°ì¤€ ê²°ê³¼
let entryDone = new Map();            // entryId -> result
let drawFired = false;
let firstCam=false;
let cameraZoom=1, camPanX=0, camPanY=0;
let seed=autoSeed();

/* ====== Replay ====== */
let replayOn=false, replay={meta:{}, events:[]};
function logEv(t, type, data){ if(!replayOn) return; replay.events.push({t, type, data}); }
function resetFinishOrder(){ finishOrder=[]; entryDone.clear(); drawFired=false; }

/* ====== Speed/Physics Tuning ====== */
const BASE_SPEED_MIN = 2.8;
const BASE_SPEED_MAX = 6.2;
const SPEED_GLOBAL   = 1.20;

const JITTER_FACTOR   = 0.22;
const BOOST_PROB      = 0.015;
const BOOST_GAIN      = 0.75;
const FATIGUE_INC     = 0.14;
const FATIGUE_DEC     = 0.07;
const FATIGUE_PENALTY = 0.16;
const VMIN_RATIO      = 0.55;
const VMAX_RATIO      = 2.10;

/* Rubberband (ì§ì„  ì „ìš© ì‚´ì§) */
const RB_RANK=0.25, RB_GAP=0.55, RB_MIN=0.92, RB_MAX=1.45;

/* Party Mode */
function partyScale(){ return $partyLv.value==='ê°•í•¨'?1.5:$partyLv.value==='ë‚®ìŒ'?0.6:1; }
const PARTY = {
  moonwalk:{p:0.008, dur:[0.6,1.1], icon:'ğŸ•º', spd:0.9},
  spin    :{p:0.006, dur:[0.6,1.0], icon:'ğŸŒ€', spd:0.95},
  pee     :{p:0.004, dur:[0.6,1.2], icon:'ğŸš½', spd:0.0}, // ì •ì§€
  jump    :{p:0.012, dur:[0.45,0.7], icon:'ğŸ¦˜', spd:1.05},
  biped   :{p:0.006, dur:[0.8,1.3], icon:'ğŸ¦µ', spd:1.08},
  shades  :{p:0.006, dur:[0.9,1.4], icon:'ğŸ˜', spd:1.15},
  bomb    :{p:0.004, stun:[0.5,0.9], icon:'ğŸ’£'},
  fall    :{p:0.003, icon:'ğŸ’¥'},
  piggy   :{p:0.003, dur:[0.9,1.4], icon:'ğŸ¤±', spd:0.7},
};

/* ====== Track Drawing ====== */
let straightViewW = 2000, straightViewH = 400;
let dynTrackY=150, dynTrackH=100, startX=80, finishX=straightViewW-80;
function dynamicTrackHeight(){
  const n=Math.max(2, H.length||splitNames($names.value).length||2);
  // ê¸°ë³¸ 100, ë§ ë§ìœ¼ë©´ ì ì§„ ì¦ê°€ (ìµœëŒ€ 220)
  return Math.min(220, 70 + n*8);
}

function drawStraightMap(){
  straightViewW = 20*dist;
  straightViewH = 400;
  dynTrackH = dynamicTrackHeight();
  dynTrackY = Math.round((straightViewH - dynTrackH)/2);
  startX=80; finishX=straightViewW-80;

  $straightMap.setAttribute('viewBox',`0 0 ${straightViewW} ${straightViewH}`);
  $straightMap.innerHTML = `
    <rect x="0" y="${dynTrackY}" width="${straightViewW}" height="${dynTrackH}" fill="#0e1a2a" stroke="#2a3b54" stroke-width="2"/>
    <line x1="${startX}" y1="${dynTrackY-12}" x2="${startX}" y2="${dynTrackY+dynTrackH+12}" stroke="#22d3ee" stroke-width="6"/>
    <text x="${startX}" y="${dynTrackY-20}" text-anchor="middle" font-size="14" fill="#a5f3fc" font-weight="800">ì¶œë°œ</text>
    <line x1="${finishX}" y1="${dynTrackY-16}" x2="${finishX}" y2="${dynTrackY+dynTrackH+16}" stroke="#ffffff" stroke-width="8"/>
    <text x="${finishX}" y="${dynTrackY-20}" text-anchor="middle" font-size="14" fill="#e5e7eb" font-weight="900">ë„ì°©</text>
  `;
}
function drawOvalMap(){
  const rx=420, ry=220;
  $ovalMap.innerHTML = `
    <ellipse cx="500" cy="300" rx="${rx}" ry="${ry}" fill="#0e1a2a" stroke="#2a3b54" stroke-width="2"/>
    <ellipse cx="500" cy="300" rx="${rx-60}" ry="${ry-60}" fill="#0b1220" stroke="#1f2937" stroke-width="2"/>
    <ellipse cx="500" cy="300" rx="${rx-30}" ry="${ry-30}" fill="none" stroke="#5b708f" stroke-dasharray="6,6" stroke-width="2"/>
    <text x="500" y="70" text-anchor="middle" font-size="14" fill="#a5f3fc" font-weight="800">ì¶œë°œ</text>
    <text x="500" y="540" text-anchor="middle" font-size="14" fill="#e5e7eb" font-weight="900">ë„ì°©</text>
  `;
}
/* Zigzag / S-line: ì¤‘ì•™ ê²½ë¡œ ê³¡ì„ ì„ ê·¸ë¦¬ë˜ ê²°ìŠ¹ì„ ì€ ì „ì²´ ë†’ì´ì— ë§ì¶° */
function drawZigzag(){
  const W=20*dist, H=500; const top=120, bot=380;
  $zigzagMap.setAttribute('viewBox',`0 0 ${W} ${H}`);
  const mid=(top+bot)/2, amp=(bot-top)/2 - 20;
  // ì§€ê·¸ì¬ê·¸ ì¤‘ì‹¬ì„ (í†±ë‹ˆ) â†’ ì‚´ì§ ìŠ¤ë¬´ë”©
  let pts=[];
  const teeth=6; // êµ´ê³¡ ìˆ˜
  for(let i=0;i<=teeth;i++){
    const x=80 + (W-160)*(i/teeth);
    const y= i%2? (top):(bot);
    pts.push(`${x},${y}`);
  }
  $zigzagMap.innerHTML=`
    <rect x="0" y="${top-40}" width="${W}" height="${(bot-top)+80}" fill="#0e1a2a" stroke="#2a3b54" stroke-width="2"/>
    <polyline points="${pts.join(' ')}" fill="none" stroke="#5b708f" stroke-dasharray="8,6" stroke-width="2"/>
    <line x1="${80}" y1="${top-60}" x2="${80}" y2="${bot+60}" stroke="#22d3ee" stroke-width="6"/>
    <text x="80" y="${top-70}" text-anchor="middle" font-size="14" fill="#a5f3fc" font-weight="800">ì¶œë°œ</text>
    <line x1="${W-80}" y1="${top-60}" x2="${W-80}" y2="${bot+60}" stroke="#ffffff" stroke-width="8"/>
    <text x="${W-80}" y="${top-70}" text-anchor="middle" font-size="14" fill="#e5e7eb" font-weight="900">ë„ì°©</text>
  `;
}
function drawSline(){
  const W=20*dist, H=500; const top=120, bot=380;
  $slineMap.setAttribute('viewBox',`0 0 ${W} ${H}`);
  const cx=W/2;
  // S ê³¡ì„ (ë² ì§€ì–´ ëŠë‚Œ) ì•ˆë‚´ì„ 
  const path=`M 80 ${(top+bot)/2}
              C ${W*0.33} ${top}, ${W*0.66} ${bot}, ${W-80} ${(top+bot)/2}`;
  $slineMap.innerHTML=`
    <rect x="0" y="${top-40}" width="${W}" height="${(bot-top)+80}" fill="#0e1a2a" stroke="#2a3b54" stroke-width="2"/>
    <path d="${path}" fill="none" stroke="#5b708f" stroke-dasharray="8,6" stroke-width="2"/>
    <line x1="${80}" y1="${top-60}" x2="${80}" y2="${bot+60}" stroke="#22d3ee" stroke-width="6"/>
    <text x="80" y="${top-70}" text-anchor="middle" font-size="14" fill="#a5f3fc" font-weight="800">ì¶œë°œ</text>
    <line x1="${W-80}" y1="${top-60}" x2="${W-80}" y2="${bot+60}" stroke="#ffffff" stroke-width="8"/>
    <text x="${W-80}" y="${top-70}" text-anchor="middle" font-size="14" fill="#e5e7eb" font-weight="900">ë„ì°©</text>
  `;
}

/* ====== Horses / Entities ====== */
function horseSVG(color){return `<svg class="horse-svg" viewBox="0 0 64 44" xmlns="http://www.w3.org/2000/svg" style="--jersey:${color}">
  <g class="g-bob">
    <path class="mane" d="M10 26c2-3 3-5 6-6 0 4-2 7-4 9l-4-1 2-2z"/>
    <path class="body" d="M8 28c7-9 12-11 20-11h9c7 0 14 4 19 9l3 5-4 2-6-4-7 2H28l-8 1-6 3-6-1 6-6z"/>
    <rect class="saddle" x="28" y="17" width="11" height="7" rx="2"/>
    <g class="jockey"><circle cx="31" cy="12" r="3.6"/><rect x="28" y="15.5" width="10" height="7" rx="2"/></g>
    <circle class="eye" cx="22.5" cy="20.5" r="0.9"/>
    <rect class="front-leg" x="21" y="26" width="3.5" height="13" fill="#e5e7eb"/>
    <rect class="back-leg"  x="36" y="26" width="3.5" height="13" fill="#e5e7eb"/>
  </g>
</svg>`}
function jockeySVG(color){return `<svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
  <circle cx="20" cy="12" r="6" fill="${color}"/>
  <rect x="13" y="18" width="14" height="12" rx="3" fill="#e5e7eb"/>
  <rect x="9" y="30" width="8" height="6" rx="2" fill="#e5e7eb"/>
  <rect x="23" y="30" width="8" height="6" rx="2" fill="#e5e7eb"/>
</svg>`}

function clearHorses(){ $canvas.querySelectorAll('.horse,.jockey').forEach(n=>n.remove()); H.length=0; }

function buildHorses(list){
  clearHorses();
  const lanes = list.length;
  list.forEach((ent,i)=>{
    const color = jc(i);
    const el=document.createElement('div');
    el.className='horse';
    el.innerHTML=horseSVG(color);

    const plate=document.createElement('div');
    plate.className='nameplate';
    plate.textContent=`${ent.no}ë²ˆ ${ent.name}`;
    plate.style.borderColor = color;
    plate.style.boxShadow = `0 0 0 1px rgba(0,0,0,.25), 0 0 8px 0 ${color}33`;
    el.appendChild(plate);

    const icon=document.createElement('div'); icon.className='stateIcon'; el.appendChild(icon);

    $canvas.appendChild(el);

    const base   = BASE_SPEED_MIN + _rand()*(BASE_SPEED_MAX-BASE_SPEED_MIN);
    // ë ˆì¸ ë¶„ì‚°
    let baseY = 200;
    if(mapMode==='straight'){ const gap = Math.min(28, dynamicTrackHeight()/Math.max(1,lanes)); baseY = dynTrackY + dynTrackH/2 + (i-(lanes-1)/2) * gap; }
    if(mapMode==='zigzag' || mapMode==='sline'){ baseY = 250 + (i-(lanes-1)/2) * Math.min(28, 140/Math.max(1,lanes)); }

    H.push({
      entryId: i, role:'horse',
      name:ent.name,no:ent.no,color,$el:el,iconEl:icon,
      x:0,y:baseY, sx:0, sy:0,
      base, speed: base*(0.85+_rand()*0.3),
      fatigue:0, legsDur:.42, done:false, _finished:false,
      party:{spin:0,moon:0,pee:0,jump:0,biped:0,shades:0,stun:0,piggy:0},
      jumpT:0, jumpDur:0.55, stumble:0,
    });
  });
  updateRanking();
  H.forEach(placeEntity);
}

/* ====== Placement ====== */
function pathCenterY(px){ // px: canvas ì¢Œí‘œê³„ X (viewBox ê¸°ì¤€)
  if(mapMode==='straight') return dynTrackY + dynTrackH/2;
  if(mapMode==='zigzag'){
    // í†±ë‹ˆíŒŒ ê·¼ì‚¬
    const W=straightViewW;
    const top=120, bot=380, per=(px-80)/(W-160);
    const teeth=6;
    const seg=1/teeth, idx=Math.floor(clamp(per,0,1)/seg);
    const a=idx%2? (top):(bot), b=(idx%2?bot:top);
    const t=(per-idx*seg)/seg;
    return a + (b-a)*t;
  }
  if(mapMode==='sline'){
    const top=120, bot=380, W=straightViewW;
    const t=clamp((px-80)/(W-160),0,1);
    // S-curve ê·¼ì‚¬: sinì„ ì‚¬ìš©
    const mid=(top+bot)/2, amp=(bot-top)/2 - 20;
    return mid + amp*Math.sin((t*2-1)*Math.PI/2);
  }
  return 300;
}

function placeEntity(h){
  if(mapMode==='oval'){
    // ê°„ë‹¨: íƒ€ì› ì£¼ë³€ ë“±ê°„ê²©(ê¸°ì¡´ ì½”ë“œëŠ” theta ê¸°ë°˜ì´ì—ˆì§€ë§Œ ì§ì„  ì£¼í–‰ êµ¬ì¡°ì™€ í†µì¼ ìœ„í•´ ê°„ëµí™” ìƒëµ)
    // ì—¬ê¸°ì„  ì›í˜• ëª¨ë“œëŠ” ì´ì „ ë²„ì „ì²˜ëŸ¼ ìœ ì§€í•˜ê³ , ë§ ìˆ˜ ì¦ê°€ë§Œ ë°˜ì˜í•˜ë ¤ë©´ ë³„ë„ êµ¬í˜„ í•„ìš”.
    // (ìš”ì²­ í¬ì»¤ìŠ¤ê°€ ì§ì„ /ì§€ê·¸ì¬ê·¸/Sì˜€ìœ¼ë¯€ë¡œ ì›í˜•ì€ ìœ ì§€)
  }else{
    const view = (mapMode==='straight')?$straightMap:(mapMode==='zigzag')?$zigzagMap:$slineMap;
    const viewBox = view.getAttribute('viewBox').split(' ').map(Number);
    const W=viewBox[2], H=viewBox[3];
    const rect=$canvas.getBoundingClientRect();
    const scaleX=rect.width/W, scaleY=rect.height/H;

    const progress = clamp(h.x/dist, 0, 1);
    const px = 80 + (W-160)*progress;
    const cy = pathCenterY(px);
    // ë ˆì¸/ê°œì¸ yëŠ” ì¤‘ì‹¬ì— ì˜¤í”„ì…‹
    let y = cy + (h.y - (mapMode==='straight'?(dynTrackY+dynTrackH/2):250));

    let x = px*scaleX, ypx = y*scaleY;

    // íŒŒí‹° ì´í™íŠ¸ í‘œì‹œ
    h.iconEl.textContent = '';
    if(h.party.spin>0) {h.$el.classList.add('spin'); h.iconEl.textContent='ğŸŒ€'}
    else h.$el.classList.remove('spin');
    if(h.party.moon>0){h.$el.classList.add('moonwalk'); h.iconEl.textContent='ğŸ•º'}
    else h.$el.classList.remove('moonwalk');
    if(h.party.biped>0){h.$el.classList.add('biped'); if(!h.iconEl.textContent) h.iconEl.textContent='ğŸ¦µ'}
    else h.$el.classList.remove('biped');
    if(h.party.shades>0){h.$el.classList.add('frenzy'); if(!h.iconEl.textContent) h.iconEl.textContent='ğŸ˜'}
    else h.$el.classList.remove('frenzy');
    if(h.party.pee>0){h.iconEl.textContent='ğŸš½'}
    if(h.party.stun>0){h.iconEl.textContent='ğŸ’«'}
    if(h.party.piggy>0){h.iconEl.textContent='ğŸ¤±'}

    h.$el.style.left = x+'px'; h.$el.style.top = ypx+'px';
    h.$el.style.transform=`translate(-50%,-50%)`;

    // ìŠ¤í¬ë¦° ì¢Œí‘œ ì €ì¥(ì¹´ë©”ë¼ ì¶”ì ìš©)
    h.sx=x; h.sy=ypx;

    // ë‹¤ë¦¬ ì• ë‹ˆë©”ì´ì…˜ ì†ë„ ë™ê¸°í™”
    const dur = Math.max(0.18, 0.6 - (h.speed*0.12));
    if(Math.abs(dur - h.legsDur) > 0.01){
      h.legsDur = dur;
      h.$el.querySelectorAll('.front-leg,.back-leg').forEach(e=>e.style.animationDuration = dur+'s');
    }
  }
}

/* ====== Ranking (Entry ê¸°ì¤€ / ë‹¤ì—´) ====== */
function orderByLeadEntities(){
  const arr = H.slice().sort((a,b)=> Math.min(b.x,dist)-Math.min(a.x,dist));
  return arr;
}
function toEntryOrder(){
  // entryIdë³„ë¡œ ê°€ì¥ ì•ì„  ì—”í‹°í‹°ë¡œ ì •ë ¬
  const best = new Map();
  H.forEach(h=>{
    const key=h.entryId;
    if(!best.has(key) || best.get(key).x < h.x) best.set(key, h);
  });
  const list=[...best.values()].sort((a,b)=> Math.min(b.x,dist)-Math.min(a.x,dist));
  return list;
}
function renderRankColumns(list){
  // ì—´ë‹¹ 10ëª…
  const cols = Math.ceil(list.length/10)||1;
  $rankWrap.innerHTML='';
  for(let c=0;c<cols;c++){
    const box=document.createElement('div');
    box.className='ranking';
    box.innerHTML=`<h3>í˜„ì¬ ìˆœìœ„</h3><div class="lines"></div>`;
    const lines=box.querySelector('.lines');
    const slice=list.slice(c*10,(c+1)*10);
    lines.innerHTML=slice.map((h,i)=>{
      const pos=c*10+i+1;
      const status = h.done?'ì™„ì£¼':`${Math.floor(h.x)}m`;
      return `<div class="row"><span class="pos">${pos}ìœ„</span>
      <span><span class="color-badge" style="background:${h.color}"></span>${h.no}ë²ˆ ${h.name} - ${status}</span></div>`;
    }).join('');
    // ìš°ì¸¡ë¶€í„° ìŒ“ì´ê²Œ
    $rankWrap.appendChild(box);
  }
  // ê²°ìŠ¹ì„  ê°€ë¦¬ì§€ ì•Šë„ë¡: ì—´ì´ 2ê°œ ì´ìƒì´ë©´ ìë™ ì¶•ì†Œ/ë°˜íˆ¬ëª…
  if(cols>=2){
    [...$rankWrap.children].forEach((b,i)=>{
      b.style.opacity = 0.9;
      b.style.transform='scale(0.96)';
    });
  }
}
function updateRanking(){
  const order = toEntryOrder();
  renderRankColumns(order);
}

/* ====== Camera (1ë“± ë·° í† ê¸€) ====== */
function updateCamera(){
  if(!firstCam){ $viewport.style.transform=`translate(-50%,-50%) scale(1)`; return; }
  const order = toEntryOrder();
  const lead = order[0];
  if(!lead){ $viewport.style.transform=`translate(-50%,-50%) scale(1)`; return; }
  const scale = 1.28; // ì¤Œ
  // ê°€ë¡œ íŒ¬: ë¦¬ë” xê°€ í™”ë©´ ì¤‘ì•™ ì˜¤ë„ë¡ ê·¼ì‚¬
  const rect=$canvas.getBoundingClientRect();
  const targetPanX = clamp((rect.width/2 - lead.sx)/scale, -rect.width*0.35, rect.width*0.35);
  camPanX += (targetPanX - camPanX)*0.15;
  $viewport.style.transform=`translate(-50%,-50%) scale(${scale}) translate(${camPanX}px, 0)`;
}

/* ====== Countdown HUD ====== */
const $hud=document.getElementById('hud'),
      $ltR=document.getElementById('ltR'),
      $ltY=document.getElementById('ltY'),
      $ltG=document.getElementById('ltG'),
      $countTxt=document.getElementById('countTxt'),
      $gunTxt=document.getElementById('gunTxt');
function wait(ms){return new Promise(r=>setTimeout(r,ms))}
async function countdown(){
  $hud.classList.add('show');
  $ltR.className='light on red'; $countTxt.textContent='3'; await wait(650);
  $ltY.className='light on yellow'; $countTxt.textContent='2'; await wait(650);
  $ltG.className='light on green'; $countTxt.textContent='1'; await wait(550);
  $countTxt.textContent='ì¶œë°œ!'; $gunTxt.textContent='íƒ•!'; await wait(300);
  $hud.classList.remove('show'); $gunTxt.textContent='';
}

/* ====== Winner Overlay ====== */
function winnerHorseSVG(color, big=false){
  const s = big? 'winnerHorse':'horse-svg';
  return `<svg class="${s}" viewBox="0 0 64 44" xmlns="http://www.w3.org/2000/svg" style="--jersey:${color}">
    <g class="g-bob">
      <path fill="#cbd5e1" d="M10 26c2-3 3-5 6-6 0 4-2 7-4 9l-4-1 2-2z"/>
      <path fill="#e5e7eb" d="M8 28c7-9 12-11 20-11h9c7 0 14 4 19 9l3 5-4 2-6-4-7 2H28l-8 1-6 3-6-1 6-6z"/>
      <rect fill="#94a3b8" x="28" y="17" width="11" height="7" rx="2"/>
      <g><circle cx="31" cy="12" r="3.6" fill="${color}"/><rect x="28" y="15.5" width="10" height="7" rx="2" fill="${color}"/></g>
      <circle cx="22.5" cy="20.5" r="0.9" fill="#0f172a"/>
      <rect x="21" y="26" width="3.5" height="13" fill="#e5e7eb"/>
      <rect x="36" y="26" width="3.5" height="13" fill="#e5e7eb"/>
    </g>
  </svg>`;
}
function showWinner(entry){
  $cele.style.display='flex';
  $celeTitle.textContent='W i n n e r r r r r ~';
  $celeSubtitle.textContent='ì´ ë§›ì— ë‹¬ë¦°ë‹¤~';

  // ì‹œê°: ë§+ê¸°ìˆ˜ í¬ê²Œ
  $winnerVisual.innerHTML = 'ğŸ‘‘ ğŸ¥• âœ¨';
  $winnerCard.innerHTML = `
    <div>${winnerHorseSVG(entry.color,true)}</div>
    <div class="winnerName">${entry.no}ë²ˆ ${entry.name}</div>
  `;

  // ë¦¬í”Œë ˆì´ ì €ì¥ ë²„íŠ¼
  $replaySaveBtn.style.display = replayOn ? 'inline-flex' : 'none';
  if(replayOn){
    $replaySaveBtn.onclick = ()=>{
      replay.meta.finishedAt = Date.now();
      download('lucky-horse-replay.json', JSON.stringify(replay,null,2));
    };
  }

  // í„°ì§€ëŠ” ì´ëª¨ì§€
  const emojis=['ğŸ‰','âœ¨','ğŸŠ','ğŸ¥³','ğŸ¾','ğŸˆ','â­'];
  for(let i=0;i<30;i++){
    const c=document.createElement('div');
    c.className='confetti';
    c.textContent=emojis[i%emojis.length];
    c.style.left=(Math.random()*100)+'vw';
    c.style.animationDuration=(2+Math.random()*1.5)+'s';
    document.body.appendChild(c);
    setTimeout(()=>c.remove(),3500);
  }
}

/* ì„ íƒ ë“±ìˆ˜ê°€ 'ë“¤ì–´ì˜¤ëŠ” ìˆœê°„' ì¦‰ë°œ (ì—”íŠ¸ë¦¬ ê¸°ì¤€) */
function maybeFireDraw(){
  if(drawFired || !pendingDraw) return;
  const k = finishOrder.length;
  if(k===0) return;

  const pick = (n)=> finishOrder[n-1]; // 1-based
  let target=null, title='Champion';

  if(pendingDraw.type==='first' && k>=1){ target=pick(1); title='Champion'; }
  if(pendingDraw.type==='nth'){
    const n = Math.max(1, parseInt(pendingDraw.n||1,10));
    if(k>=n) { target=pick(n); title=`${n}ë“± ë‹¹ì²¨`; }
  }
  if(pendingDraw.type==='last' && k===toEntryOrder().length){ target=pick(k); title='ë§ˆì§€ë§‰ ë‹¹ì²¨'; }

  if(target){
    drawFired=true; pendingDraw=null;
    showWinner(target);
  }
}

/* ====== Party Engine ====== */
// ì—”íŠ¸ë¦¬(ì‚¬ëŒ) ê¸°ì¤€ìœ¼ë¡œ ìš°ìŠ¹ íŒì •: ë‘˜ ì¤‘ ë¨¼ì € ë“¤ì–´ì˜¤ë©´ ë
function finishEntryIfFirst(h){
  if(entryDone.get(h.entryId)) return; // ì´ë¯¸ ë
  entryDone.set(h.entryId, {who:h.role, x:h.x});
  finishOrder.push({entryId:h.entryId, name:h.name, no:h.no, color:h.color, who:h.role});
  maybeFireDraw();
}

function spawnJockeyFrom(h){
  // ì´ë¯¸ ì¡´ì¬í•˜ë©´ íŒ¨ìŠ¤
  if(H.find(e=>e.entryId===h.entryId && e.role==='jockey' && !e.done)) return;
  const el=document.createElement('div'); el.className='jockey'; el.innerHTML=jockeySVG(h.color);
  const plate=document.createElement('div'); plate.className='nameplate'; plate.textContent=`${h.no}ë²ˆ ${h.name} (ê¸°ìˆ˜)`; el.appendChild(plate);
  const icon=document.createElement('div'); icon.className='stateIcon'; el.appendChild(icon);
  $canvas.appendChild(el);
  const j = {
    entryId:h.entryId, role:'jockey',
    name:h.name,no:h.no,color:h.color,$el:el,iconEl:icon,
    x:h.x, y:h.y, sx:0, sy:0,
    base: 3.6 + _rand()*0.6, speed: 3.2 + _rand()*0.6,
    fatigue:0, legsDur:.4, done:false, _finished:false,
    party:{spin:0,moon:0,pee:0,jump:0,biped:0,shades:0,stun:0,piggy:0},
    jumpT:0, jumpDur:0.4, stumble:0,
  };
  H.push(j);
}

function maybeParty(h, dt, tnow){
  if(!$partyChk.checked) return;

  const scale = partyScale();

  // ìŠ¤í„´ì´ ìˆìœ¼ë©´ ì•„ë¬´ ê²ƒë„ ëª»í•¨
  if(h.party.stun>0){ h.party.stun-=dt; return; }

  // ì§„í–‰ ì¤‘ì¸ ìƒíƒœ ê°ì†Œ
  ['spin','moon','pee','jump','biped','shades','piggy'].forEach(k=>{ if(h.party[k]>0) h.party[k]-=dt; });

  // í™•ë¥  íŠ¸ë¦¬ê±° (ë™ì‹œ 1ê°œë§Œ ìƒˆë¡œ ê±¸ê¸°)
  const already = ['spin','moon','pee','jump','biped','shades','piggy'].some(k=>h.party[k]>0);
  if(!already){
    for(const [key,conf] of Object.entries(PARTY)){
      if(key==='bomb' || key==='fall') continue; // ì•„ë˜ ë³„ë„ ì²˜ë¦¬
      const p = conf.p * scale * dt;
      if(_rand()<p){
        const dur = conf.dur? conf.dur[0] + _rand()*(conf.dur[1]-conf.dur[0]) : 0.8;
        h.party[key]=dur;
        logEv(tnow,'party', {entry:h.entryId, role:h.role, key, dur});
        break;
      }
    }
  }

  // í­íƒ„: ê·¼ì²˜ ì  ìŠ¤í„´
  if(_rand() < PARTY.bomb.p * scale * dt){
    const targets = H.filter(o=>o.entryId!==h.entryId && !o.done && Math.abs(o.x-h.x)<12);
    const tgt = targets[targets.length? Math.floor(_rand()*targets.length): -1];
    if(tgt){
      tgt.party.stun = PARTY.bomb.stun[0] + _rand()*(PARTY.bomb.stun[1]-PARTY.bomb.stun[0]);
      logEv(tnow,'bomb',{from:h.entryId,to:tgt.entryId,dur:tgt.party.stun});
    }
  }

  // ë‚™ë§ˆ: ê¸°ìˆ˜ ë¶„ë¦¬
  if(h.role==='horse' && _rand() < PARTY.fall.p * scale * dt){
    spawnJockeyFrom(h);
    // ë§ì€ ì‚´ì§ í”ë“¤ (ê°ì†)
    h.speed *= 0.7;
    logEv(tnow,'fall',{entry:h.entryId});
  }
}

function partySpeedFactor(h){
  let f=1;
  if(h.party.spin>0) f*=0.95;
  if(h.party.moon>0) f*=0.9;
  if(h.party.pee>0)  f*=0.0;
  if(h.party.jump>0) f*=1.05;
  if(h.party.biped>0)f*=1.08;
  if(h.party.shades>0)f*=1.15;
  if(h.party.piggy>0) f*=0.7;
  return f;
}

/* ====== Race Loop ====== */
let lastTime=null, startTS=0;
function run(){
  running=true; lastTime=null; startTS=performance.now();

  const tick=(now)=>{
    if(lastTime===null) lastTime=now;
    const dt=Math.max(0.001,Math.min(0.05,(now-lastTime)/1000));
    lastTime=now;

    const orderEnt = toEntryOrder();
    const leadX = orderEnt[0]? Math.min(orderEnt[0].x, dist):0;

    for(const h of H){
      if(h.done) continue;

      // íŒŒí‹° ì´ë²¤íŠ¸
      maybeParty(h, dt, (now-startTS)/1000);

      // ê¸°ë³¸ ì£¼í–‰(ì§ì„ /ì§€ê·¸ì¬ê·¸/S)
      h.speed += h.base*JITTER_FACTOR*(_rand()-0.5);
      if(_rand()<BOOST_PROB) h.speed += h.base*BOOST_GAIN;
      if(h.speed>h.base*1.12) h.fatigue = Math.min(1,h.fatigue+dt*FATIGUE_INC);
      else h.fatigue = Math.max(0,h.fatigue-dt*FATIGUE_DEC);
      h.speed -= h.fatigue*h.base*FATIGUE_PENALTY;

      // ëŸ¬ë²„ë°´ë”©(ì§ì„ ë¥˜ ì „ìš©)
      if(mapMode!=='oval'){
        const gap = leadX - Math.min(h.x,dist);
        const gapNorm = clamp(gap/Math.max(20,dist*0.6),0,1);
        const rankIdx = orderEnt.findIndex(e=>e.entryId===h.entryId);
        const rankNorm = (orderEnt.length>1)?(rankIdx/(orderEnt.length-1)):0;
        let assist = 1 + RB_RANK*rankNorm + RB_GAP*gapNorm;
        assist=clamp(assist,RB_MIN,RB_MAX);
        h.speed *= (1 + (assist-1)*0.5);
      }

      // íŒŒí‹° ì†ë„ ê³„ìˆ˜
      h.speed *= partySpeedFactor(h);

      // ì†ë„ í´ë¨í”„
      const vMin=h.base*VMIN_RATIO, vMax=h.base*VMAX_RATIO;
      h.speed=clamp(h.speed, vMin, vMax);

      // ì´ë™
      h.x += h.speed*dt*SPEED_GLOBAL;

      // ì í”„ ì´í™íŠ¸(íŒŒí‹° jump)
      if(h.party.jump>0){
        h.jumpT += dt;
        h.$el.classList.add('jump');
      }else{
        h.jumpT=0; h.$el.classList.remove('jump');
      }

      if(h.x>=dist){ h.done=true; }

      // ì—”íŠ¸ë¦¬ ê¸°ì¤€ í”¼ë‹ˆì‹œ ì²˜ë¦¬
      if(!h._finished && h.done){
        h._finished=true;
        finishEntryIfFirst(h);
      }

      placeEntity(h);
    }

    updateRanking();
    updateCamera();

    if(H.every(h=>h.done)){
      running=false;
    }else{
      raf=requestAnimationFrame(tick);
    }
  };

  raf=requestAnimationFrame(tick);
}

/* ====== Controls ====== */
document.getElementById('btnContact').onclick=()=>{
  alert("ë¬¸ì˜/ê±´ì˜/í”¼ë“œë°±: luckyhorserace@gmail.com\nììœ ë¡­ê²Œ ì´ìš©í•´ ì£¼ì‹œê³  ì–¸ì œë“  ì˜ê²¬ ì£¼ì„¸ìš”!");
};

$start.onclick=async()=>{
  if(running) return;
  const list=splitNames($names.value);
  if(list.length<MIN){alert('ìµœì†Œ 2ëª… ì…ë ¥');return}
  if(list.length>MAX){alert('ìµœëŒ€ 50ëª…');return}
  laps=parseInt($raceLen.value,10)||3;
  dist=parseInt($raceDist.value,10)||100;

  seed=autoSeed(); reseed(seed);
  replayOn = $replayChk.checked;
  replay = {meta:{seed, names:list.map(x=>x.name), map:mapMode, dist, laps, party:$partyChk.checked, partyLv:$partyLv.value}, events:[]};

  $cele.style.display='none';
  clearHorses();
  resetFinishOrder();

  if(mapMode==="straight") drawStraightMap();
  if(mapMode==="zigzag") drawZigzag();
  if(mapMode==="sline") drawSline();
  if(mapMode==="oval") drawOvalMap();

  buildHorses(list);
  await countdown();
  run();
};

$reset.onclick=()=>{
  if(raf) cancelAnimationFrame(raf);
  raf=null; running=false; pendingDraw={type:'first'};
  // UI ë°˜ì˜
  document.querySelectorAll('#drawSeg .seg-item').forEach(l=>l.classList.remove('on'));
  document.querySelector('#drawSeg .seg-item[data-type="first"]').classList.add('on');
  $cele.style.display='none';
  clearHorses();
  resetFinishOrder();
  if(mapMode==="straight") drawStraightMap();
  if(mapMode==="zigzag") drawZigzag();
  if(mapMode==="sline") drawSline();
  if(mapMode==="oval") drawOvalMap();
};

$shuffle.onclick=()=>{
  const list=splitNames($names.value);
  for(let i=list.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[list[i],list[j]]=[list[j],list[i]]}
  $names.value=list.map(x=>x.name).join(' ');
  if(list.length) buildHorses(list); else clearHorses();
};

$names.addEventListener('input', ()=>{
  const list=splitNames($names.value);
  if(list.length) buildHorses(list); else clearHorses();
});

addEventListener('resize', ()=>{
  if(mapMode==="straight") drawStraightMap();
  if(mapMode==="zigzag") drawZigzag();
  if(mapMode==="sline") drawSline();
  if(mapMode==="oval") drawOvalMap();
  H.forEach(placeEntity);
  updateCamera();
});

/* ë§µ ì „í™˜ (ì§ì„  â†’ íƒ€ì› â†’ ì§€ê·¸ì¬ê·¸ â†’ Së¼ì¸ ìˆœí™˜) */
$mapToggle.onclick=()=>{
  mapMode = (mapMode==='straight')?'oval':(mapMode==='oval')?'zigzag':(mapMode==='zigzag')?'sline':'straight';
  $mapToggle.textContent = "ë§µ: " + (mapMode==='straight'?'ì§ì„ ':mapMode==='oval'?'íƒ€ì›':mapMode==='zigzag'?'ì§€ê·¸ì¬ê·¸':'S-ë¼ì¸');

  // UI í‘œì‹œ
  $raceLen.style.display = (mapMode==='oval')?"inline-block":"none";
  $raceDist.style.display = (mapMode!=='oval')?"inline-block":"none";

  $straightMap.style.display = (mapMode==='straight')?'block':'none';
  $ovalMap.style.display     = (mapMode==='oval')?'block':'none';
  $zigzagMap.style.display   = (mapMode==='zigzag')?'block':'none';
  $slineMap.style.display    = (mapMode==='sline')?'block':'none';

  if(raf) cancelAnimationFrame(raf);
  raf=null; running=false;
  $cele.style.display='none';
  clearHorses();
  resetFinishOrder();

  if(mapMode==="straight") drawStraightMap();
  if(mapMode==="zigzag") drawZigzag();
  if(mapMode==="sline") drawSline();
  if(mapMode==="oval") drawOvalMap();
};

/* 1ë“± ë·° í† ê¸€ */
$firstCamBtn.onclick=()=>{
  firstCam=!firstCam;
  $firstCamBtn.textContent = firstCam? '1ë“± ë·° ON':'1ë“± ë·° OFF';
  $firstCamBtn.classList.toggle('on', firstCam);
  if(!firstCam){ camPanX=0; $viewport.style.transform=`translate(-50%,-50%) scale(1)`; }
};

/* ì¶”ì²¨(ì„¸ê·¸ë¨¼íŠ¸) */
const $drawSeg = document.getElementById('drawSeg');
const $drawNthInput = document.getElementById('drawNthInput');
function updateDrawUI(type){
  $drawSeg.querySelectorAll('.seg-item').forEach(lab=>{
    lab.classList.toggle('on', lab.dataset.type===type);
  });
  $drawNthInput.disabled = (type!=='nth');
  if(type==='nth'){ $drawNthInput.focus(); }
}
function applyDrawSelection(type){
  if(type==='first') pendingDraw = {type:'first'};
  else if(type==='last') pendingDraw = {type:'last'};
  else if(type==='nth'){
    const n = parseInt($drawNthInput.value,10);
    if(!n || n<1){ pendingDraw=null; alert('në“± ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    pendingDraw = {type:'nth', n};
  } else pendingDraw=null;
}
$drawSeg.addEventListener('click', (e)=>{
  const lab = e.target.closest('.seg-item'); if(!lab) return;
  const type = lab.dataset.type;
  updateDrawUI(type); applyDrawSelection(type);
});
$drawNthInput.addEventListener('input', ()=>{
  const on = $drawSeg.querySelector('.seg-item.on');
  if(on && on.dataset.type==='nth') applyDrawSelection('nth');
});

/* ì´ˆê¸° í‘œì‹œ: ì§ì„  + 1ë“±ëª¨ë“œ ê¸°ë³¸ ì„ íƒ */
$raceLen.style.display="none";
$raceDist.style.display="inline-block";
$straightMap.style.display="block";
$ovalMap.style.display="none";
$zigzagMap.style.display="none";
$slineMap.style.display="none";
drawStraightMap();
document.querySelector('#drawSeg .seg-item[data-type="first"]').classList.add('on');

</script>
</body>
</html>
